<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Show Code as Written Text</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; }

    /* wrap pre so we can place the button neatly */
    .code-wrap { max-width: 1200px; }

    pre {
      position: relative;
      padding: 52px 16px 16px; /* extra top space for button */
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      background: #0b1020;
      color: #e8e8e8;
      overflow: auto;
      line-height: 1.45;
      font-size: 14px;
      margin: 0;
    }

    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      white-space: pre; /* keep spacing */
    }

    /* Copy button */
    #copyBtn {
      position: absolute;
      top: 12px;
      right: 12px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.08);
      color: #fff;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
      user-select: none;
      backdrop-filter: blur(6px);
    }
    #copyBtn:hover { background: rgba(255,255,255,0.14); }
    #copyBtn:active { transform: translateY(1px); }

    #copyStatus {
      position: absolute;
      top: 16px;
      left: 16px;
      font-size: 12px;
      color: rgba(232,232,232,0.85);
    }
  </style>
</head>
<body>

  <h2>Displayed Code (as text exactly)</h2>

  <div class="code-wrap">
    <pre>
      <button id="copyBtn" type="button" aria-label="Copy code to clipboard">Copy</button>
      <span id="copyStatus" aria-live="polite"></span>
      <code id="codeBlock">






using System;
using System.Collections.Generic;
using System.Data;
using System.Drawing;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Windows.Forms;
using ClosedXML.Excel;
using Microsoft.Data.Sqlite;

namespace DrugNameStandardizer
{
    public partial class Form1 : Form
    {
        // =========================
        // State
        // =========================
        private DataTable? _inputTable;

        private DataTable _libraryTable = new DataTable();
        private DataTable _synonymsTable = new DataTable();
        private DataTable _unknownsTable = new DataTable();
        private DataTable _variabilityTable = new DataTable();
        private DataTable _validationTable = new DataTable();

        // NEW: Pricing / Spend tools
        private DataTable _costSavingsTopTable = new DataTable();
        private DataTable _therapeuticSpendTable = new DataTable();

        // FIX: typed generics (this is what removes CS0305 errors)
        private HashSet<string> _ingredientSet = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        private Dictionary<string, string> _synonymMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);

        // Export column selection
        private HashSet<string>? _selectedOutputColumns = null;

        private readonly string _dbPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "ingredient_library.db");

        // =========================
        // Constructor / UI
        // =========================
        public Form1()
        {
            InitializeComponent();
            Controls.Clear();

            Width = 1380;
            Height = 840;
            Text = "Generic Name Standardizer — Primary Ingredient (Library + Synonyms + Reports)";

            // Top row buttons
            var btnLoadLibrary = new Button { Text = "Load Library", Left = 15, Top = 15, Width = 125, Height = 35 };
            var btnImportLibrary = new Button { Text = "Import Library (Excel)", Left = 150, Top = 15, Width = 170, Height = 35 };
            var btnSaveLibrary = new Button { Text = "Save Library", Left = 330, Top = 15, Width = 125, Height = 35 };

            var btnLoadSynonyms = new Button { Text = "Load Synonyms", Left = 470, Top = 15, Width = 140, Height = 35 };
            var btnImportSynonyms = new Button { Text = "Import Synonyms (Excel)", Left = 620, Top = 15, Width = 185, Height = 35 };
            var btnSaveSynonyms = new Button { Text = "Save Synonyms", Left = 815, Top = 15, Width = 140, Height = 35 };

            var btnUploadInput = new Button { Text = "Upload Input Excel", Left = 975, Top = 15, Width = 150, Height = 35 };
            var btnRun = new Button { Text = "Run Standardization", Left = 1130, Top = 15, Width = 165, Height = 35, Enabled = false };

            // Second row buttons
            var btnAnalyzeVariability = new Button { Text = "Analyze Variability", Left = 15, Top = 58, Width = 160, Height = 32, Enabled = false };
            var btnGenerateValidation = new Button { Text = "Generate Validation", Left = 185, Top = 58, Width = 160, Height = 32, Enabled = false };
            var btnExportDocs = new Button { Text = "Export Documentation", Left = 355, Top = 58, Width = 175, Height = 32 };

            var btnExportUnknowns = new Button { Text = "Export Unknowns", Left = 540, Top = 58, Width = 150, Height = 32, Enabled = false };
            var btnExportVariability = new Button { Text = "Export Variability", Left = 700, Top = 58, Width = 160, Height = 32, Enabled = false };
            var btnExportValidation = new Button { Text = "Export Validation", Left = 870, Top = 58, Width = 160, Height = 32, Enabled = false };

            var btnChooseColumns = new Button { Text = "Choose Output Columns", Left = 1040, Top = 58, Width = 185, Height = 32, Enabled = false };
            var btnSaveOutput = new Button { Text = "Save Output Excel", Left = 1230, Top = 58, Width = 135, Height = 32, Enabled = false };

            var lblStatus = new Label { Text = "Status: Ready", Left = 15, Top = 98, Width = 1320 };

            // Tabs
            var tabs = new TabControl { Left = 15, Top = 125, Width = 1350, Height = 650 };

            var tabLibrary = new TabPage("Ingredient Library (Editable)");
            var tabSynonyms = new TabPage("Synonyms (Editable)");
            var tabInput = new TabPage("Input + Output Preview");
            var tabUnknowns = new TabPage("Unknowns (Needs Review)");
            var tabVariability = new TabPage("Variability Report");
            var tabValidation = new TabPage("Validation Examples");

            // NEW TABS (do not disturb existing UI rows)
            var tabCostSavings = new TabPage("Cost-Savings Opportunity Finder");
            var tabTherapeuticSpend = new TabPage("Therapeutic Category Spend Trends");

            tabs.TabPages.Add(tabLibrary);
            tabs.TabPages.Add(tabSynonyms);
            tabs.TabPages.Add(tabInput);
            tabs.TabPages.Add(tabUnknowns);
            tabs.TabPages.Add(tabVariability);
            tabs.TabPages.Add(tabValidation);
            tabs.TabPages.Add(tabCostSavings);
            tabs.TabPages.Add(tabTherapeuticSpend);

            // Grids
            var libraryGrid = MakeEditableGrid();
            var synonymsGrid = MakeEditableGrid();
            var inputGrid = MakeReadOnlyGrid();      // preview grid (read-only cells, but supports right-click delete column)
            var unknownsGrid = MakeEditableGrid();   // user can fill ApprovedIngredient
            var variabilityGrid = MakeReadOnlyGrid();
            var validationGrid = MakeReadOnlyGrid();

            // NEW tool grids
            var costSavingsGrid = MakeReadOnlyGrid();
            var therapeuticSpendGrid = MakeReadOnlyGrid();

            tabLibrary.Controls.Add(libraryGrid);
            tabSynonyms.Controls.Add(synonymsGrid);
            tabInput.Controls.Add(inputGrid);
            tabUnknowns.Controls.Add(unknownsGrid);
            tabVariability.Controls.Add(variabilityGrid);
            tabValidation.Controls.Add(validationGrid);

            // NEW: tool UIs inside their tabs (keeps your top UI unchanged)
            var costPanel = new Panel { Dock = DockStyle.Fill };
            var btnRunCost = new Button { Text = "Run Cost-Savings Finder", Left = 10, Top = 10, Width = 200, Height = 30, Enabled = false };
            var btnExportCost = new Button { Text = "Export Cost-Savings Output", Left = 220, Top = 10, Width = 220, Height = 30, Enabled = false };
            var btnShowCostSummary = new Button { Text = "Show Summary", Left = 450, Top = 10, Width = 140, Height = 30, Enabled = false };
            costSavingsGrid.Left = 10; costSavingsGrid.Top = 50; costSavingsGrid.Width = 1310; costSavingsGrid.Height = 560;
            costPanel.Controls.Add(btnRunCost);
            costPanel.Controls.Add(btnExportCost);
            costPanel.Controls.Add(btnShowCostSummary);
            costPanel.Controls.Add(costSavingsGrid);
            tabCostSavings.Controls.Add(costPanel);

            var spendPanel = new Panel { Dock = DockStyle.Fill };
            var btnRunSpend = new Button { Text = "Run Spend Trends", Left = 10, Top = 10, Width = 170, Height = 30, Enabled = false };
            var btnExportSpend = new Button { Text = "Export Spend Trends", Left = 190, Top = 10, Width = 170, Height = 30, Enabled = false };
            var btnShowSpendSummary = new Button { Text = "Show Summary", Left = 370, Top = 10, Width = 140, Height = 30, Enabled = false };
            therapeuticSpendGrid.Left = 10; therapeuticSpendGrid.Top = 50; therapeuticSpendGrid.Width = 1310; therapeuticSpendGrid.Height = 560;
            spendPanel.Controls.Add(btnRunSpend);
            spendPanel.Controls.Add(btnExportSpend);
            spendPanel.Controls.Add(btnShowSpendSummary);
            spendPanel.Controls.Add(therapeuticSpendGrid);
            tabTherapeuticSpend.Controls.Add(spendPanel);

            Controls.Add(btnLoadLibrary);
            Controls.Add(btnImportLibrary);
            Controls.Add(btnSaveLibrary);

            Controls.Add(btnLoadSynonyms);
            Controls.Add(btnImportSynonyms);
            Controls.Add(btnSaveSynonyms);

            Controls.Add(btnUploadInput);
            Controls.Add(btnRun);

            Controls.Add(btnAnalyzeVariability);
            Controls.Add(btnGenerateValidation);
            Controls.Add(btnExportDocs);

            Controls.Add(btnExportUnknowns);
            Controls.Add(btnExportVariability);
            Controls.Add(btnExportValidation);

            Controls.Add(btnChooseColumns);
            Controls.Add(btnSaveOutput);

            Controls.Add(lblStatus);
            Controls.Add(tabs);

            // Ensure DB exists
            EnsureDatabase();

            // Initial load
            LoadLibraryFromDb();
            LoadSynonymsFromDb();
            libraryGrid.DataSource = _libraryTable;
            synonymsGrid.DataSource = _synonymsTable;

            // ==========================================================
            // Feature A) Right-click column header -> Delete Column (Preview)
            // ==========================================================
            var inputHeaderMenu = new ContextMenuStrip();
            var miDeleteColumn = new ToolStripMenuItem("Delete Column");
            inputHeaderMenu.Items.Add(miDeleteColumn);

            string? lastRightClickedColumnName = null;

            inputGrid.ColumnHeaderMouseClick += (_, e) =>
            {
                if (e.Button != MouseButtons.Right) return;
                if (e.ColumnIndex < 0) return;

                lastRightClickedColumnName = inputGrid.Columns[e.ColumnIndex].Name;

                inputGrid.ClearSelection();
                inputGrid.Columns[e.ColumnIndex].Selected = true;

                inputHeaderMenu.Show(Cursor.Position);
            };

            miDeleteColumn.Click += (_, __) =>
            {
                if (_inputTable == null) return;
                if (string.IsNullOrWhiteSpace(lastRightClickedColumnName)) return;

                // Protect required column (generic_name)
                var protectedCols = new HashSet<string>(StringComparer.OrdinalIgnoreCase) { "generic_name" };

                if (protectedCols.Contains(lastRightClickedColumnName))
                {
                    MessageBox.Show($"You cannot delete required column: {lastRightClickedColumnName}", "Protected Column");
                    return;
                }

                if (!_inputTable.Columns.Contains(lastRightClickedColumnName)) return;

                var confirm = MessageBox.Show(
                    $"Delete column '{lastRightClickedColumnName}' from the preview table?\n\nThis removes it from the current loaded data in the program.",
                    "Confirm Delete Column",
                    MessageBoxButtons.YesNo,
                    MessageBoxIcon.Warning
                );

                if (confirm != DialogResult.Yes) return;

                _inputTable.Columns.Remove(lastRightClickedColumnName);

                // keep export selection in sync
                _selectedOutputColumns?.Remove(lastRightClickedColumnName);

                inputGrid.DataSource = _inputTable;
                inputGrid.Refresh();

                lblStatus.Text = $"Status: Deleted column '{lastRightClickedColumnName}' from preview.";
            };

            // ==========================================================
            // Feature B) Click PrimaryIngredient cell -> popup count + unique forms
            // ==========================================================
            inputGrid.CellClick += (_, e) =>
            {
                if (e.RowIndex < 0 || e.ColumnIndex < 0) return;
                if (_inputTable == null) return;

                // Only trigger when clicking PrimaryIngredient column
                var clickedColName = inputGrid.Columns[e.ColumnIndex].Name;
                if (!clickedColName.Equals("PrimaryIngredient", StringComparison.OrdinalIgnoreCase))
                    return;

                var ingredient = inputGrid.Rows[e.RowIndex].Cells[e.ColumnIndex].Value?.ToString()?.Trim();
                if (string.IsNullOrWhiteSpace(ingredient)) return;

                var primaryCol = FindColumn(_inputTable, "PrimaryIngredient");
                var genericCol = FindColumn(_inputTable, "generic_name");
                if (primaryCol == null || genericCol == null)
                {
                    MessageBox.Show("Missing required columns: PrimaryIngredient or generic_name.", "Error");
                    return;
                }

                int count = 0;
                var uniqueForms = new HashSet<string>(StringComparer.OrdinalIgnoreCase);

                foreach (DataRow r in _inputTable.Rows)
                {
                    var p = (r[primaryCol]?.ToString() ?? "").Trim();
                    if (!p.Equals(ingredient, StringComparison.OrdinalIgnoreCase)) continue;

                    count++;

                    var g = (r[genericCol]?.ToString() ?? "").Trim();
                    if (!string.IsNullOrWhiteSpace(g))
                        uniqueForms.Add(g);
                }

                var sb = new StringBuilder();
                sb.AppendLine($"Primary Ingredient: {ingredient}");
                sb.AppendLine($"Mentioned: {count} time(s)");
                sb.AppendLine();
                sb.AppendLine("Unique forms in sheet (no duplicates):");
                sb.AppendLine("-------------------------------------");
                foreach (var form in uniqueForms.OrderBy(x => x))
                    sb.AppendLine("• " + form);

                ShowBigPopup(sb.ToString(), $"Ingredient Summary — {ingredient}");
            };

            // ... (rest of your code continues unchanged)
        }

        // (rest of your file unchanged)
    }
}



         
  
  
  
  
  
      </code>
    </pre>
  </div>

  <script>
    (function () {
      const btn = document.getElementById('copyBtn');
      const codeEl = document.getElementById('codeBlock');
      const statusEl = document.getElementById('copyStatus');

      function setStatus(msg) {
        statusEl.textContent = msg || '';
        if (msg) setTimeout(() => (statusEl.textContent = ''), 2000);
      }

      async function copyText(text) {
        // Modern API
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
          return true;
        }

        // Fallback
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.setAttribute('readonly', '');
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();

        let ok = false;
        try { ok = document.execCommand('copy'); } catch (e) { ok = false; }

        document.body.removeChild(ta);
        return ok;
      }

      btn.addEventListener('click', async () => {
        const text = codeEl.textContent; // keeps spacing/newlines exactly as shown
        try {
          const ok = await copyText(text);
          if (!ok) throw new Error('Copy failed');
          btn.textContent = 'Copied!';
          setStatus('Copied to clipboard.');
          setTimeout(() => (btn.textContent = 'Copy'), 1500);
        } catch (e) {
          setStatus('Could not copy (browser blocked). Select + copy manually.');
        }
      });
    })();
  </script>

</body>
</html>
