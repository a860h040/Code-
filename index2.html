using System;
using System.Collections.Generic;
using System.Data;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Windows.Forms;
using ClosedXML.Excel;
using Microsoft.Data.Sqlite;

namespace DrugNameStandardizer
{
    public partial class Form1 : Form
    {
        // =========================
        // State
        // =========================
        private DataTable? _inputTable;

        private DataTable _libraryTable = new DataTable();
        private DataTable _synonymsTable = new DataTable();
        private DataTable _unknownsTable = new DataTable();
        private DataTable _variabilityTable = new DataTable();
        private DataTable _validationTable = new DataTable();

        private HashSet<string> _ingredientSet = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        private Dictionary<string, string> _synonymMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);

        private HashSet<string>? _selectedOutputColumns = null;

        private readonly string _dbPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "ingredient_library.db");

        // Search state
        private string _lastSearchText = "";
        private int _lastFoundRow = -1;
        private int _lastFoundCol = -1;

        // =========================
        // UI references
        // =========================
        private ToolStripStatusLabel? _statusLabel;

        private TabControl? _tabs;

        private DataGridView? _libraryGrid;
        private DataGridView? _synonymsGrid;
        private DataGridView? _inputGrid;
        private DataGridView? _inputDetailsGrid;
        private DataGridView? _unknownsGrid;
        private DataGridView? _variabilityGrid;
        private DataGridView? _validationGrid;

        // Search ribbon widgets
        private ToolStripTextBox? _searchBox;
        private ToolStripComboBox? _searchScope;

        // =========================
        // Constructor
        // =========================
        public Form1()
        {
            InitializeComponent();
            Controls.Clear();

            Width = 1500;
            Height = 900;
            Text = "Generic Name Standardizer — Library + Synonyms + Tools";

            KeyPreview = true;
            KeyDown += Form1_KeyDown;

            // =========================
            // MenuStrip (kept minimal; your “ribbon” is ToolStrips below)
            // =========================
            var menu = new MenuStrip();

            var mFile = new ToolStripMenuItem("File");
            var miOpen = new ToolStripMenuItem("Open Input Excel", null, (_, __) => UploadInputExcel()) { ShortcutKeys = Keys.Control | Keys.O };
            var miSaveOutput = new ToolStripMenuItem("Save Output Excel", null, (_, __) => SaveOutputExcel()) { ShortcutKeys = Keys.Control | Keys.S };
            var miExit = new ToolStripMenuItem("Exit", null, (_, __) => Close());
            mFile.DropDownItems.Add(miOpen);
            mFile.DropDownItems.Add(miSaveOutput);
            mFile.DropDownItems.Add(new ToolStripSeparator());
            mFile.DropDownItems.Add(miExit);

            var mView = new ToolStripMenuItem("View");
            var miEssential = new ToolStripMenuItem("Essential Columns (Input)", null, (_, __) =>
            {
                if (_inputTable != null && _inputGrid != null)
                {
                    ApplyInputColumnProfile(_inputTable, _inputGrid, "Essential");
                    SetStatus("View: Essential columns applied.");
                }
            });
            var miAllCols = new ToolStripMenuItem("Show All Columns (Input)", null, (_, __) =>
            {
                if (_inputTable != null && _inputGrid != null)
                {
                    ApplyInputColumnProfile(_inputTable, _inputGrid, "All");
                    SetStatus("View: All columns shown.");
                }
            });
            mView.DropDownItems.Add(miEssential);
            mView.DropDownItems.Add(miAllCols);

            var mHelp = new ToolStripMenuItem("Help");
            var miHotkeys = new ToolStripMenuItem("Hotkeys", null, (_, __) =>
            {
                MessageBox.Show(
                    "Hotkeys:\n\n" +
                    "Ctrl+F = Focus Search\n" +
                    "Enter (in search box) = Find Next\n" +
                    "F3 = Find Next\n" +
                    "Shift+F3 = Find Previous\n",
                    "Hotkeys");
            });
            mHelp.DropDownItems.Add(miHotkeys);

            menu.Items.AddRange(new ToolStripItem[] { mFile, mView, mHelp });
            MainMenuStrip = menu;
            Controls.Add(menu);

            // =========================
            // SEARCH RIBBON (ToolStrip #1) — ONLY search bar
            // =========================
            var searchRibbon = new ToolStrip
            {
                Dock = DockStyle.Top,
                GripStyle = ToolStripGripStyle.Hidden,
                RenderMode = ToolStripRenderMode.Professional
            };

            searchRibbon.Items.Add(new ToolStripLabel("Search:"));

            _searchBox = new ToolStripTextBox
            {
                Width = 360,
                AutoSize = false
            };
            _searchBox.KeyDown += SearchBox_KeyDown;

            var btnPrev = new ToolStripButton("Prev");
            btnPrev.Click += (_, __) => FindInActiveGrid(next: false);

            var btnNext = new ToolStripButton("Next");
            btnNext.Click += (_, __) => FindInActiveGrid(next: true);

            searchRibbon.Items.Add(_searchBox);
            searchRibbon.Items.Add(btnPrev);
            searchRibbon.Items.Add(btnNext);

            searchRibbon.Items.Add(new ToolStripSeparator());
            searchRibbon.Items.Add(new ToolStripLabel("Scope:"));

            _searchScope = new ToolStripComboBox { Width = 160, DropDownStyle = ComboBoxStyle.DropDownList };
            _searchScope.Items.AddRange(new object[] { "Active Tab", "Input Tab Only" });
            _searchScope.SelectedIndex = 0;

            searchRibbon.Items.Add(_searchScope);

            Controls.Add(searchRibbon);

            // =========================
            // TOOLS RIBBON (ToolStrip #2) — Tool dropdown + Run (green)
            // =========================
            var toolsRibbon = new ToolStrip
            {
                Dock = DockStyle.Top,
                GripStyle = ToolStripGripStyle.Hidden,
                RenderMode = ToolStripRenderMode.Professional
            };

            // File quick actions
            var btnOpenExcel = new ToolStripButton("Open Excel");
            btnOpenExcel.Click += (_, __) => UploadInputExcel();

            var btnSaveExcel = new ToolStripButton("Save Output");
            btnSaveExcel.Click += (_, __) => SaveOutputExcel();

            toolsRibbon.Items.Add(btnOpenExcel);
            toolsRibbon.Items.Add(btnSaveExcel);
            toolsRibbon.Items.Add(new ToolStripSeparator());

            toolsRibbon.Items.Add(new ToolStripLabel("Tool:"));

            // Tool dropdown list (as requested)
            var toolDropDown = new ToolStripDropDownButton("Select Tool");
            var miAnalyzeVar = new ToolStripMenuItem("Analyze Variability", null, (_, __) => RunVariability());
            var miValidation = new ToolStripMenuItem("Generate Validation Examples", null, (_, __) => RunValidation());
            toolDropDown.DropDownItems.Add(miAnalyzeVar);
            toolDropDown.DropDownItems.Add(miValidation);

            toolsRibbon.Items.Add(toolDropDown);
            toolsRibbon.Items.Add(new ToolStripSeparator());

            // RUN as a GREEN button (host a real Button so BackColor works reliably)
            var runBtn = new Button
            {
                Text = "RUN",
                AutoSize = true,
                BackColor = Color.FromArgb(0, 170, 0),
                ForeColor = Color.White,
                FlatStyle = FlatStyle.Flat,
                Font = new Font("Segoe UI", 9F, FontStyle.Bold),
                Padding = new Padding(10, 2, 10, 2)
            };
            runBtn.FlatAppearance.BorderSize = 0;
            runBtn.Click += (_, __) => RunStandardization();

            var runHost = new ToolStripControlHost(runBtn) { Margin = new Padding(6, 2, 6, 2) };
            toolsRibbon.Items.Add(runHost);

            Controls.Add(toolsRibbon);

            // =========================
            // StatusStrip
            // =========================
            var statusStrip = new StatusStrip();
            _statusLabel = new ToolStripStatusLabel("Status: Ready");
            statusStrip.Items.Add(_statusLabel);
            Controls.Add(statusStrip);

            // =========================
            // Tabs + Grids
            // =========================
            _tabs = new TabControl
            {
                Dock = DockStyle.Fill
            };

            var tabLibrary = new TabPage("Library");
            var tabSynonyms = new TabPage("Synonyms");
            var tabInput = new TabPage("Input Data");
            var tabUnknowns = new TabPage("Unknowns");
            var tabVariability = new TabPage("Variability");
            var tabValidation = new TabPage("Validation");

            _tabs.TabPages.Add(tabInput);
            _tabs.TabPages.Add(tabLibrary);
            _tabs.TabPages.Add(tabSynonyms);
            _tabs.TabPages.Add(tabUnknowns);
            _tabs.TabPages.Add(tabVariability);
            _tabs.TabPages.Add(tabValidation);

            Controls.Add(_tabs);

            _libraryGrid = MakeEditableGrid();
            _synonymsGrid = MakeEditableGrid();
            _inputGrid = MakeReadOnlyGrid();
            _unknownsGrid = MakeEditableGrid();
            _variabilityGrid = MakeReadOnlyGrid();
            _validationGrid = MakeReadOnlyGrid();

            // Input tab layout: SplitContainer (left grid, right row-details)
            var split = new SplitContainer
            {
                Dock = DockStyle.Fill,
                Orientation = Orientation.Vertical,
                SplitterDistance = 1050
            };

            split.Panel1.Controls.Add(_inputGrid);

            _inputDetailsGrid = new DataGridView
            {
                Dock = DockStyle.Fill,
                ReadOnly = true,
                AllowUserToAddRows = false,
                AllowUserToDeleteRows = false,
                RowHeadersVisible = false,
                SelectionMode = DataGridViewSelectionMode.CellSelect,
                MultiSelect = false,
                AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill,
                DefaultCellStyle = { Font = new Font("Segoe UI", 9F) },
                ColumnHeadersDefaultCellStyle = { Font = new Font("Segoe UI", 9F, FontStyle.Bold) }
            };
            _inputDetailsGrid.Columns.Add("Field", "Field");
            _inputDetailsGrid.Columns.Add("Value", "Value");

            split.Panel2.Controls.Add(_inputDetailsGrid);
            tabInput.Controls.Add(split);

            tabLibrary.Controls.Add(_libraryGrid);
            tabSynonyms.Controls.Add(_synonymsGrid);
            tabUnknowns.Controls.Add(_unknownsGrid);
            tabVariability.Controls.Add(_variabilityGrid);
            tabValidation.Controls.Add(_validationGrid);

            // =========================
            // DB init + initial load
            // =========================
            EnsureDatabase();
            LoadLibraryFromDb();
            LoadSynonymsFromDb();

            _libraryGrid.DataSource = _libraryTable;
            _synonymsGrid.DataSource = _synonymsTable;

            // =========================
            // Feature A) Right-click column header -> Delete Column (Preview)
            // =========================
            var inputHeaderMenu = new ContextMenuStrip();
            var miDeleteColumn = new ToolStripMenuItem("Delete Column");
            inputHeaderMenu.Items.Add(miDeleteColumn);

            string? lastRightClickedColumnName = null;

            _inputGrid.ColumnHeaderMouseClick += (_, e) =>
            {
                if (e.Button != MouseButtons.Right) return;
                if (e.ColumnIndex < 0) return;

                lastRightClickedColumnName = _inputGrid.Columns[e.ColumnIndex].Name;

                _inputGrid.ClearSelection();
                _inputGrid.Columns[e.ColumnIndex].Selected = true;

                inputHeaderMenu.Show(Cursor.Position);
            };

            miDeleteColumn.Click += (_, __) =>
            {
                if (_inputTable == null) return;
                if (string.IsNullOrWhiteSpace(lastRightClickedColumnName)) return;

                var protectedCols = new HashSet<string>(StringComparer.OrdinalIgnoreCase) { "generic_name" };

                if (protectedCols.Contains(lastRightClickedColumnName))
                {
                    MessageBox.Show($"You cannot delete required column: {lastRightClickedColumnName}", "Protected Column");
                    return;
                }

                if (!_inputTable.Columns.Contains(lastRightClickedColumnName)) return;

                var confirm = MessageBox.Show(
                    $"Delete column '{lastRightClickedColumnName}' from the preview table?\n\nThis removes it from the current loaded data in the program.",
                    "Confirm Delete Column",
                    MessageBoxButtons.YesNo,
                    MessageBoxIcon.Warning
                );

                if (confirm != DialogResult.Yes) return;

                _inputTable.Columns.Remove(lastRightClickedColumnName);
                _selectedOutputColumns?.Remove(lastRightClickedColumnName);

                _inputGrid.DataSource = _inputTable;
                _inputGrid.Refresh();

                SetStatus($"Deleted column '{lastRightClickedColumnName}' from preview.");
            };

            // =========================
            // Feature B) Click PrimaryIngredient cell -> popup count + unique forms
            // =========================
            _inputGrid.CellClick += (_, e) =>
            {
                if (e.RowIndex < 0 || e.ColumnIndex < 0) return;
                if (_inputTable == null) return;

                var clickedColName = _inputGrid.Columns[e.ColumnIndex].Name;
                if (!clickedColName.Equals("PrimaryIngredient", StringComparison.OrdinalIgnoreCase))
                    return;

                var ingredient = _inputGrid.Rows[e.RowIndex].Cells[e.ColumnIndex].Value?.ToString()?.Trim();
                if (string.IsNullOrWhiteSpace(ingredient)) return;

                var primaryCol = FindColumn(_inputTable, "PrimaryIngredient");
                var genericCol = FindColumn(_inputTable, "generic_name");
                if (primaryCol == null || genericCol == null)
                {
                    MessageBox.Show("Missing required columns: PrimaryIngredient or generic_name.", "Error");
                    return;
                }

                int count = 0;
                var uniqueForms = new HashSet<string>(StringComparer.OrdinalIgnoreCase);

                foreach (DataRow r in _inputTable.Rows)
                {
                    var p = (r[primaryCol]?.ToString() ?? "").Trim();
                    if (!p.Equals(ingredient, StringComparison.OrdinalIgnoreCase)) continue;

                    count++;

                    var g = (r[genericCol]?.ToString() ?? "").Trim();
                    if (!string.IsNullOrWhiteSpace(g))
                        uniqueForms.Add(g);
                }

                var sb = new StringBuilder();
                sb.AppendLine($"Primary Ingredient: {ingredient}");
                sb.AppendLine($"Mentioned: {count} time(s)");
                sb.AppendLine();
                sb.AppendLine("Unique forms in sheet (no duplicates):");
                sb.AppendLine("-------------------------------------");
                foreach (var form in uniqueForms.OrderBy(x => x))
                    sb.AppendLine("• " + form);

                ShowBigPopup(sb.ToString(), $"Ingredient Summary — {ingredient}");
            };

            // Row details pane update
            _inputGrid.SelectionChanged += (_, __) =>
            {
                if (_inputTable == null) return;
                if (_inputDetailsGrid == null) return;
                if (_inputGrid.CurrentRow == null) return;
                int idx = _inputGrid.CurrentRow.Index;
                if (idx < 0 || idx >= _inputTable.Rows.Count) return;

                var row = _inputTable.Rows[idx];
                _inputDetailsGrid.Rows.Clear();
                foreach (DataColumn col in _inputTable.Columns)
                {
                    var val = row[col]?.ToString() ?? "";
                    _inputDetailsGrid.Rows.Add(col.ColumnName, val);
                }
            };
        }

        // =========================
        // Ctrl+F support
        // =========================
        private void Form1_KeyDown(object? sender, KeyEventArgs e)
        {
            if (e.Control && e.KeyCode == Keys.F)
            {
                FocusSearch();
                e.SuppressKeyPress = true;
                return;
            }

            if (e.KeyCode == Keys.F3)
            {
                bool prev = e.Shift;
                FindInActiveGrid(next: !prev);
                e.SuppressKeyPress = true;
                return;
            }
        }

        private void SearchBox_KeyDown(object? sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter)
            {
                FindInActiveGrid(next: true);
                e.SuppressKeyPress = true;
            }
        }

        private void FocusSearch()
        {
            if (_searchBox == null) return;
            _searchBox.Focus();
            _searchBox.SelectAll();
            SetStatus("Search: ready (Enter=Next, Shift+F3=Prev).");
        }

        // =========================
        // Search logic (Active tab / Input tab only)
        // =========================
        private void FindInActiveGrid(bool next)
        {
            if (_searchBox == null || _tabs == null) return;

            var term = (_searchBox.Text ?? "").Trim();
            if (string.IsNullOrWhiteSpace(term))
            {
                SetStatus("Search: type something first.");
                return;
            }

            bool scopeInputOnly = (_searchScope?.SelectedIndex ?? 0) == 1;

            DataGridView? grid = null;
            DataTable? table = null;

            if (scopeInputOnly)
            {
                grid = _inputGrid;
                table = _inputTable;
            }
            else
            {
                grid = GetActiveGrid();
                table = GetActiveTableForGrid(grid);
            }

            if (grid == null || table == null)
            {
                SetStatus("Search: no data table available on this tab.");
                return;
            }

            // Reset find pointer if new search term
            if (!term.Equals(_lastSearchText, StringComparison.OrdinalIgnoreCase))
            {
                _lastSearchText = term;
                _lastFoundRow = -1;
                _lastFoundCol = -1;
            }

            bool found = FindNextInTable(grid, table, term, next);

            if (!found)
                SetStatus($"Search: '{term}' not found.");
        }

        private DataGridView? GetActiveGrid()
        {
            if (_tabs == null) return null;
            if (_tabs.SelectedTab == null) return null;

            // each tab contains either a single grid or split container containing _inputGrid
            if (_tabs.SelectedTab.Text.Equals("Input Data", StringComparison.OrdinalIgnoreCase))
                return _inputGrid;

            var grids = _tabs.SelectedTab.Controls.OfType<DataGridView>().ToList();
            return grids.Count > 0 ? grids[0] : null;
        }

        private DataTable? GetActiveTableForGrid(DataGridView? grid)
        {
            if (grid == null) return null;

            if (grid == _inputGrid) return _inputTable;
            if (grid == _libraryGrid) return _libraryTable;
            if (grid == _synonymsGrid) return _synonymsTable;
            if (grid == _unknownsGrid) return _unknownsTable;
            if (grid == _variabilityGrid) return _variabilityTable;
            if (grid == _validationGrid) return _validationTable;

            return null;
        }

        private bool FindNextInTable(DataGridView grid, DataTable table, string term, bool next)
        {
            // Search visible columns only (so it matches what user sees)
            var visibleCols = grid.Columns
                .Cast<DataGridViewColumn>()
                .Where(c => c.Visible)
                .OrderBy(c => c.DisplayIndex)
                .Select(c => c.Name)
                .ToList();

            if (visibleCols.Count == 0)
                visibleCols = table.Columns.Cast<DataColumn>().Select(c => c.ColumnName).ToList();

            int rowStart = _lastFoundRow;
            int colStart = _lastFoundCol;

            // Starting position
            int r = rowStart;
            int c = colStart;

            if (r < 0 || c < 0)
            {
                r = 0;
                c = -1;
            }

            if (next)
            {
                for (int rr = r; rr < table.Rows.Count; rr++)
                {
                    int ccStart = (rr == r) ? c + 1 : 0;
                    for (int cc = ccStart; cc < visibleCols.Count; cc++)
                    {
                        var colName = visibleCols[cc];
                        if (!table.Columns.Contains(colName)) continue;

                        var val = table.Rows[rr][colName]?.ToString() ?? "";
                        if (val.IndexOf(term, StringComparison.OrdinalIgnoreCase) >= 0)
                        {
                            SelectGridCell(grid, rr, colName);
                            _lastFoundRow = rr;
                            _lastFoundCol = cc;
                            SetStatus($"Search: found '{term}' at row {rr + 1}, column '{colName}'.");
                            return true;
                        }
                    }
                }

                // Wrap
                for (int rr = 0; rr <= r; rr++)
                {
                    for (int cc = 0; cc < visibleCols.Count; cc++)
                    {
                        if (rr == r && cc >= c) break;

                        var colName = visibleCols[cc];
                        if (!table.Columns.Contains(colName)) continue;

                        var val = table.Rows[rr][colName]?.ToString() ?? "";
                        if (val.IndexOf(term, StringComparison.OrdinalIgnoreCase) >= 0)
                        {
                            SelectGridCell(grid, rr, colName);
                            _lastFoundRow = rr;
                            _lastFoundCol = cc;
                            SetStatus($"Search: found '{term}' at row {rr + 1}, column '{colName}' (wrapped).");
                            return true;
                        }
                    }
                }
            }
            else
            {
                for (int rr = r; rr >= 0; rr--)
                {
                    int ccStart = (rr == r) ? c - 1 : visibleCols.Count - 1;
                    for (int cc = ccStart; cc >= 0; cc--)
                    {
                        var colName = visibleCols[cc];
                        if (!table.Columns.Contains(colName)) continue;

                        var val = table.Rows[rr][colName]?.ToString() ?? "";
                        if (val.IndexOf(term, StringComparison.OrdinalIgnoreCase) >= 0)
                        {
                            SelectGridCell(grid, rr, colName);
                            _lastFoundRow = rr;
                            _lastFoundCol = cc;
                            SetStatus($"Search: found '{term}' at row {rr + 1}, column '{colName}'.");
                            return true;
                        }
                    }
                }

                // Wrap
                for (int rr = table.Rows.Count - 1; rr >= r; rr--)
                {
                    for (int cc = visibleCols.Count - 1; cc >= 0; cc--)
                    {
                        if (rr == r && cc <= c) break;

                        var colName = visibleCols[cc];
                        if (!table.Columns.Contains(colName)) continue;

                        var val = table.Rows[rr][colName]?.ToString() ?? "";
                        if (val.IndexOf(term, StringComparison.OrdinalIgnoreCase) >= 0)
                        {
                            SelectGridCell(grid, rr, colName);
                            _lastFoundRow = rr;
                            _lastFoundCol = cc;
                            SetStatus($"Search: found '{term}' at row {rr + 1}, column '{colName}' (wrapped).");
                            return true;
                        }
                    }
                }
            }

            return false;
        }

        private static void SelectGridCell(DataGridView grid, int rowIndex, string colName)
        {
            if (rowIndex < 0 || rowIndex >= grid.Rows.Count) return;
            if (!grid.Columns.Contains(colName)) return;

            int colIndex = grid.Columns[colName].Index;

            grid.ClearSelection();
            grid.CurrentCell = grid.Rows[rowIndex].Cells[colIndex];
            grid.Rows[rowIndex].Selected = true;

            grid.FirstDisplayedScrollingRowIndex = Math.Max(0, rowIndex - 3);
        }

        // =========================
        // Actions: Open / Run / Save / Reports
        // =========================
        private void UploadInputExcel()
        {
            using var ofd = new OpenFileDialog { Filter = "Excel Files (*.xlsx)|*.xlsx", Title = "Select Input Excel" };
            if (ofd.ShowDialog() != DialogResult.OK) return;

            try
            {
                _inputTable = LoadFirstSheetToDataTable(ofd.FileName);
                if (_inputGrid != null) _inputGrid.DataSource = _inputTable;

                // Default column profile: Essential
                if (_inputTable != null && _inputGrid != null)
                    ApplyInputColumnProfile(_inputTable, _inputGrid, "Essential");

                _selectedOutputColumns = null;

                _tabs?.SelectTab(0);
                SetStatus($"Input loaded ({_inputTable.Rows.Count} rows). Ctrl+F to search.");
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message, "Input Load Error");
            }
        }

        private void RunStandardization()
        {
            if (_inputTable == null)
            {
                MessageBox.Show("Upload an input Excel file first.");
                return;
            }

            if (_ingredientSet.Count == 0)
            {
                MessageBox.Show("Ingredient Library is empty. Import/add ingredients first.");
                return;
            }

            var genericCol = FindColumn(_inputTable, "generic_name");
            if (genericCol == null)
            {
                MessageBox.Show("Input must have a column named 'generic_name' in header row.");
                return;
            }

            EnsureOutputColumns(_inputTable);
            BuildUnknownsTableSchema();

            SetStatus("Standardizing...");
            Application.DoEvents();

            int unknownCount = 0;

            foreach (DataRow row in _inputTable.Rows)
            {
                var raw = row[genericCol]?.ToString() ?? "";
                var result = ExtractWithRules(raw, _ingredientSet, _synonymMap);

                row["PrimaryIngredient"] = result.PrimaryIngredient;
                row["AllIngredients"] = result.AllIngredients;
                row["RuleApplied"] = result.RuleApplied;
                row["NormalizedGeneric"] = result.CleanedForMatching;

                if (result.IsUnknown)
                {
                    unknownCount++;
                    AddUnknownRow(raw, result.CleanedForMatching, result.SuggestedIngredient);
                }
            }

            if (_inputGrid != null) _inputGrid.Refresh();
            if (_unknownsGrid != null) _unknownsGrid.DataSource = _unknownsTable;

            _selectedOutputColumns = new HashSet<string>(
                _inputTable.Columns.Cast<DataColumn>().Select(c => c.ColumnName),
                StringComparer.OrdinalIgnoreCase
            );

            LogRun(_inputTable.Rows.Count, unknownCount);

            SetStatus($"Done. Unknowns: {unknownCount}. Click PrimaryIngredient for popup. Ctrl+F to search.");
        }

        private void RunVariability()
        {
            if (_inputTable == null)
            {
                MessageBox.Show("Upload an input Excel file first.");
                return;
            }

            _variabilityTable = BuildVariabilityReport(_inputTable);
            if (_variabilityGrid != null) _variabilityGrid.DataSource = _variabilityTable;

            SetStatus($"Variability report created ({_variabilityTable.Rows.Count} ingredients).");
            _tabs?.SelectTab("Variability");
        }

        private void RunValidation()
        {
            if (_inputTable == null)
            {
                MessageBox.Show("Upload an input Excel file first.");
                return;
            }

            _validationTable = BuildValidationExamples(_inputTable, topIngredients: 20, examplesPerIngredient: 10);
            if (_validationGrid != null) _validationGrid.DataSource = _validationTable;

            SetStatus($"Validation examples created ({_validationTable.Rows.Count} rows).");
            _tabs?.SelectTab("Validation");
        }

        private void SaveOutputExcel()
        {
            if (_inputTable == null)
            {
                MessageBox.Show("No input loaded.");
                return;
            }

            using var sfd = new SaveFileDialog
            {
                Filter = "Excel Files (*.xlsx)|*.xlsx",
                Title = "Save Output",
                FileName = "standardized_output.xlsx"
            };
            if (sfd.ShowDialog() != DialogResult.OK) return;

            try
            {
                DataTable toSave = _inputTable;

                if (_selectedOutputColumns != null)
                    toSave = CreateFilteredTable(_inputTable, _selectedOutputColumns);

                SaveDataTableToExcel(toSave, sfd.FileName);
                SetStatus($"Output saved -> {sfd.FileName}");
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message, "Save Output Error");
            }
        }

        // =========================
        // Popup Window Helper
        // =========================
        private void ShowBigPopup(string text, string title)
        {
            var f = new Form
            {
                Text = title,
                Width = 900,
                Height = 650,
                StartPosition = FormStartPosition.CenterParent
            };

            var box = new TextBox
            {
                Multiline = true,
                ReadOnly = true,
                ScrollBars = ScrollBars.Both,
                Dock = DockStyle.Fill,
                Font = new Font("Segoe UI", 10),
                Text = text
            };

            var btn = new Button
            {
                Text = "Close",
                Dock = DockStyle.Bottom,
                Height = 40
            };
            btn.Click += (_, __) => f.Close();

            f.Controls.Add(box);
            f.Controls.Add(btn);
            f.ShowDialog(this);
        }

        private void SetStatus(string text)
        {
            if (_statusLabel != null) _statusLabel.Text = "Status: " + text;
        }

        // =========================
        // UI helpers
        // =========================
        private static DataGridView MakeEditableGrid()
        {
            var g = new DataGridView
            {
                Dock = DockStyle.Fill,
                AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill,
                AllowUserToAddRows = true,
                AllowUserToDeleteRows = true,
                AllowUserToOrderColumns = true,
                RowHeadersVisible = false,
                SelectionMode = DataGridViewSelectionMode.FullRowSelect,
                MultiSelect = false,
                DefaultCellStyle = { Font = new Font("Segoe UI", 9F) },
                ColumnHeadersDefaultCellStyle = { Font = new Font("Segoe UI", 9F, FontStyle.Bold) },
                AllowUserToResizeRows = false,
                RowTemplate = { Height = 26 },
                ScrollBars = ScrollBars.Both
            };
            return g;
        }

        private static DataGridView MakeReadOnlyGrid()
        {
            var g = new DataGridView
            {
                Dock = DockStyle.Fill,
                ReadOnly = true,
                AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill,
                AllowUserToOrderColumns = true,
                RowHeadersVisible = false,
                SelectionMode = DataGridViewSelectionMode.FullRowSelect,
                MultiSelect = false,
                DefaultCellStyle = { Font = new Font("Segoe UI", 9F) },
                ColumnHeadersDefaultCellStyle = { Font = new Font("Segoe UI", 9F, FontStyle.Bold) },
                AllowUserToResizeRows = false,
                RowTemplate = { Height = 26 },
                ScrollBars = ScrollBars.Both
            };
            return g;
        }

        private static void ApplyInputColumnProfile(DataTable dt, DataGridView grid, string profile)
        {
            var essential = new HashSet<string>(StringComparer.OrdinalIgnoreCase)
            {
                "ndc",
                "generic_name",
                "PrimaryIngredient",
                "RuleApplied",
                "Vizient_ABC_WAC",
                "Vizient_MCK_WAC",
                "Vizient_MDX_WAC",
                "fdb_current_wac_price",
                "etc1",
                "etc2",
                "AHFS_therapeutic_description",
                "ETC_Lowest_lvl"
            };

            bool showAll = profile.Equals("All", StringComparison.OrdinalIgnoreCase);

            foreach (DataGridViewColumn col in grid.Columns)
            {
                col.Visible = showAll || essential.Contains(col.Name);
            }

            FreezeIfExists(grid, "ndc");
            FreezeIfExists(grid, "generic_name");
            FreezeIfExists(grid, "PrimaryIngredient");
        }

        private static void FreezeIfExists(DataGridView grid, string colName)
        {
            var col = grid.Columns
                .Cast<DataGridViewColumn>()
                .FirstOrDefault(c => c.Name.Equals(colName, StringComparison.OrdinalIgnoreCase));

            if (col != null) col.Frozen = true;
        }

        // =========================
        // DB setup
        // =========================
        private void EnsureDatabase()
        {
            using var conn = new SqliteConnection($"Data Source={_dbPath}");
            conn.Open();

            using var cmd = conn.CreateCommand();
            cmd.CommandText =
            @"
            CREATE TABLE IF NOT EXISTS Ingredients (
                Id INTEGER PRIMARY KEY AUTOINCREMENT,
                Name TEXT NOT NULL UNIQUE,
                Normalized TEXT NOT NULL
            );

            CREATE TABLE IF NOT EXISTS Synonyms (
                Id INTEGER PRIMARY KEY AUTOINCREMENT,
                Pattern TEXT NOT NULL UNIQUE,
                NormalizedPattern TEXT NOT NULL,
                MapsToIngredient TEXT NOT NULL,
                NormalizedMapsTo TEXT NOT NULL,
                Source TEXT NOT NULL DEFAULT 'manual',
                CreatedAt TEXT NOT NULL DEFAULT (datetime('now'))
            );

            CREATE TABLE IF NOT EXISTS Runs (
                Id INTEGER PRIMARY KEY AUTOINCREMENT,
                RunAt TEXT NOT NULL DEFAULT (datetime('now')),
                RowCount INTEGER NOT NULL,
                UnknownCount INTEGER NOT NULL
            );
            ";
            cmd.ExecuteNonQuery();
        }

        private void LogRun(int rowCount, int unknownCount)
        {
            using var conn = new SqliteConnection($"Data Source={_dbPath}");
            conn.Open();
            using var cmd = conn.CreateCommand();
            cmd.CommandText = "INSERT INTO Runs (RowCount, UnknownCount) VALUES ($r, $u);";
            cmd.Parameters.AddWithValue("$r", rowCount);
            cmd.Parameters.AddWithValue("$u", unknownCount);
            cmd.ExecuteNonQuery();
        }

        // =========================
        // Library: Load / Save / Import
        // =========================
        private void LoadLibraryFromDb()
        {
            _libraryTable = new DataTable();
            _libraryTable.Columns.Add("Name", typeof(string));

            _ingredientSet = new HashSet<string>(StringComparer.OrdinalIgnoreCase);

            using var conn = new SqliteConnection($"Data Source={_dbPath}");
            conn.Open();

            using var cmd = conn.CreateCommand();
            cmd.CommandText = "SELECT Name FROM Ingredients ORDER BY Name;";
            using var reader = cmd.ExecuteReader();

            while (reader.Read())
            {
                var name = reader.GetString(0);
                _libraryTable.Rows.Add(name);

                var norm = NormalizeIngredient(name);
                if (!string.IsNullOrWhiteSpace(norm))
                    _ingredientSet.Add(norm);
            }
        }

        private void LoadSynonymsFromDb()
        {
            _synonymsTable = new DataTable();
            _synonymsTable.Columns.Add("Pattern", typeof(string));
            _synonymsTable.Columns.Add("MapsToIngredient", typeof(string));
            _synonymsTable.Columns.Add("Source", typeof(string));

            _synonymMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);

            using var conn = new SqliteConnection($"Data Source={_dbPath}");
            conn.Open();

            using var cmd = conn.CreateCommand();
            cmd.CommandText = "SELECT Pattern, MapsToIngredient, Source FROM Synonyms ORDER BY Pattern;";
            using var reader = cmd.ExecuteReader();

            while (reader.Read())
            {
                var pattern = reader.GetString(0);
                var mapsTo = reader.GetString(1);
                var source = reader.GetString(2);

                _synonymsTable.Rows.Add(pattern, mapsTo, source);

                var normPattern = NormalizeIngredient(pattern);
                var normMapsTo = NormalizeIngredient(mapsTo);

                if (!string.IsNullOrWhiteSpace(normPattern) && !string.IsNullOrWhiteSpace(normMapsTo))
                    _synonymMap[normPattern] = normMapsTo;
            }
        }

        // =========================
        // Standardization Rules Engine
        // =========================
        private struct ExtractResult
        {
            public string PrimaryIngredient;
            public string AllIngredients;
            public string RuleApplied;
            public string CleanedForMatching;
            public bool IsUnknown;
            public string SuggestedIngredient;
        }

        private static ExtractResult ExtractWithRules(string genericName, HashSet<string> ingredientSet, Dictionary<string, string> synonymMap)
        {
            var result = new ExtractResult
            {
                PrimaryIngredient = "",
                AllIngredients = "",
                RuleApplied = "",
                CleanedForMatching = "",
                IsUnknown = false,
                SuggestedIngredient = ""
            };

            if (string.IsNullOrWhiteSpace(genericName))
            {
                result.PrimaryIngredient = "NON_DRUG";
                result.RuleApplied = "EMPTY";
                return result;
            }

            var cleaned = CleanGenericForMatching(genericName);
            result.CleanedForMatching = cleaned;

            if (string.IsNullOrWhiteSpace(cleaned))
            {
                result.PrimaryIngredient = "NON_DRUG";
                result.RuleApplied = "NON_DRUG_AFTER_CLEAN";
                return result;
            }

            var parts = SplitComboParts(genericName);
            if (parts.Count >= 2)
            {
                var ingredients = new List<string>();
                var rules = new List<string>();

                foreach (var p in parts)
                {
                    var c = CleanGenericForMatching(p);
                    if (string.IsNullOrWhiteSpace(c)) continue;

                    var synHit = LongestMatch(c, synonymMap.Keys);
                    if (!string.IsNullOrWhiteSpace(synHit))
                    {
                        var mapped = synonymMap[synHit];
                        ingredients.Add(mapped);
                        rules.Add($"SYNONYM({synHit}->{mapped})");
                        continue;
                    }

                    var ingHit = LongestMatch(c, ingredientSet);
                    if (!string.IsNullOrWhiteSpace(ingHit))
                    {
                        ingredients.Add(ingHit);
                        rules.Add("DICT");
                        continue;
                    }

                    if (c.Contains("insulin"))
                    {
                        ingredients.Add("insulin");
                        rules.Add("INSULIN_FALLBACK");
                        continue;
                    }
                }

                ingredients = ingredients
                    .Where(x => !string.IsNullOrWhiteSpace(x))
                    .Distinct(StringComparer.OrdinalIgnoreCase)
                    .ToList();

                if (ingredients.Count > 0)
                {
                    result.PrimaryIngredient = ingredients[0];
                    result.AllIngredients = string.Join("|", ingredients);
                    result.RuleApplied = "COMBO:" + string.Join(",", rules.Distinct());
                    return result;
                }

                result.RuleApplied = "COMBO_NO_MATCH";
                result.IsUnknown = true;
                result.SuggestedIngredient = SuggestIngredient(cleaned, ingredientSet);
                return result;
            }

            var syn = LongestMatch(cleaned, synonymMap.Keys);
            if (!string.IsNullOrWhiteSpace(syn))
            {
                var mapped = synonymMap[syn];
                result.PrimaryIngredient = mapped;
                result.AllIngredients = mapped;
                result.RuleApplied = $"SYNONYM({syn}->{mapped})";
                return result;
            }

            var ing = LongestMatch(cleaned, ingredientSet);
            if (!string.IsNullOrWhiteSpace(ing))
            {
                result.PrimaryIngredient = ing;
                result.AllIngredients = ing;
                result.RuleApplied = "DICT_LONGEST_MATCH";
                return result;
            }

            if (cleaned.Contains("insulin"))
            {
                result.PrimaryIngredient = "insulin";
                result.AllIngredients = "insulin";
                result.RuleApplied = "INSULIN_FALLBACK";
                return result;
            }

            if (!ContainsDrugLikeToken(cleaned))
            {
                result.PrimaryIngredient = "NON_DRUG";
                result.RuleApplied = "NON_DRUG_HEURISTIC";
                return result;
            }

            result.RuleApplied = "UNKNOWN_NO_MATCH";
            result.IsUnknown = true;
            result.SuggestedIngredient = SuggestIngredient(cleaned, ingredientSet);
            return result;
        }

        private static bool ContainsDrugLikeToken(string cleaned)
        {
            var tokens = cleaned.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            if (tokens.Any(t => t.Length >= 8)) return true;

            string[] suffixes =
            {
                "cillin","mycin","cycline","prazole","pril","sartan","olol","dipine","statin",
                "azole","vir","mab","nib","tide","caine","parin","dronate","gliptin","gliflozin"
            };
            return tokens.Any(t => suffixes.Any(s => t.EndsWith(s)));
        }

        private static List<string> SplitComboParts(string raw)
        {
            var s = raw.ToLowerInvariant();
            if (!s.Contains("/") && !s.Contains("+") && !s.Contains(" and "))
                return new List<string> { raw };

            var parts = Regex.Split(raw, @"\s*(\/|\+|\band\b)\s*", RegexOptions.IgnoreCase)
                .Select(p => p.Trim())
                .Where(p => !string.IsNullOrWhiteSpace(p))
                .ToList();

            parts = parts.Where(p =>
                p != "/" && p != "+" && !string.Equals(p, "and", StringComparison.OrdinalIgnoreCase)).ToList();

            return parts.Count == 0 ? new List<string> { raw } : parts;
        }

        private static string LongestMatch(string cleaned, IEnumerable<string> candidates)
        {
            var tokens = cleaned.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            if (tokens.Length == 0) return "";

            int maxGram = Math.Min(6, tokens.Length);

            HashSet<string>? set = candidates as HashSet<string>;
            set ??= new HashSet<string>(candidates, StringComparer.OrdinalIgnoreCase);

            for (int n = maxGram; n >= 1; n--)
            {
                for (int i = 0; i <= tokens.Length - n; i++)
                {
                    var phrase = string.Join(" ", tokens.Skip(i).Take(n));
                    if (set.Contains(phrase))
                        return phrase;
                }
            }
            return "";
        }

        private static string SuggestIngredient(string cleaned, HashSet<string> ingredientSet)
        {
            var tokens = cleaned.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            if (tokens.Length == 0) return "";

            foreach (var t in tokens)
                if (ingredientSet.Contains(t)) return t;

            var prefixes = tokens
                .Where(t => t.Length >= 6)
                .Select(t => t.Substring(0, 6))
                .Distinct()
                .ToList();

            string best = "";
            foreach (var ing in ingredientSet)
            {
                foreach (var p in prefixes)
                {
                    if (ing.StartsWith(p) && ing.Length > best.Length)
                        best = ing;
                }
            }
            return best;
        }

        // =========================
        // Cleaning / normalization
        // =========================
        private static string CleanGenericForMatching(string input)
        {
            var s = input.Trim().ToLowerInvariant();

            s = s.Replace("/", " ")
                 .Replace(",", " ")
                 .Replace(";", " ")
                 .Replace("(", " ")
                 .Replace(")", " ")
                 .Replace("-", " ");

            s = Regex.Replace(s, @"\bu\s*[-]?\s*\d+\b", " ");

            s = Regex.Replace(s, @"\b\d+(\.\d+)?\s*(mg|mcg|g|gram|grams|ml|mL|l|meq|units|iu|%)\b", " ");
            s = Regex.Replace(s, @"\b\d+(\.\d+)?\s*(mg\/ml|mg\/mL|mcg\/ml|g\/l|mg\/g)\b", " ");

            foreach (var w in StopWords)
                s = Regex.Replace(s, $@"\b{Regex.Escape(w)}\b", " ");

            foreach (var w in SaltWords)
                s = Regex.Replace(s, $@"\b{Regex.Escape(w)}\b", " ");

            s = Regex.Replace(s, @"\s+", " ").Trim();
            return s;
        }

        private static string NormalizeIngredient(string name)
        {
            var s = name.Trim().ToLowerInvariant();
            s = s.Replace("/", " ").Replace("-", " ");
            s = Regex.Replace(s, @"\s+", " ").Trim();
            return s;
        }

        private static readonly string[] StopWords =
        {
            "vial","vials","syringe","syringes","needle","needles","bag","bags","premix",
            "cartridge","cartridges","label","labels","printer","toner","thermometer","thermometers",
            "kit","kits","cap","caps","luer","female","male","tackle","box","various","dram","drams",
            "tablet","tablets","tab","capsule","capsules","solution","suspension","syrup","injection","inj","iv",
            "oral","topical","cream","ointment","gel","patch","spray","drops","ophthalmic","otic","nasal",
            "extended","release","er","xr","sr","dr","immediate","ir","concentrate","prefilled","pen",
            "for","use","single","dose","multi","dose","pre","filled"
        };

        private static readonly string[] SaltWords =
        {
            "hydrochloride","hcl","sodium","potassium","calcium","magnesium",
            "phosphate","acetate","succinate","tartrate","citrate","mesylate",
            "besylate","tosylate","fumarate","maleate","sulfate","nitrate"
        };

        // =========================
        // Unknowns
        // =========================
        private void BuildUnknownsTableSchema()
        {
            _unknownsTable = new DataTable();
            _unknownsTable.Columns.Add("OriginalGenericName", typeof(string));
            _unknownsTable.Columns.Add("CleanedForMatching", typeof(string));
            _unknownsTable.Columns.Add("SuggestedIngredient", typeof(string));
            _unknownsTable.Columns.Add("ApprovedIngredient", typeof(string));
            _unknownsTable.Columns.Add("SuggestedPattern", typeof(string));
        }

        private void AddUnknownRow(string original, string cleaned, string suggested)
        {
            _unknownsTable.Rows.Add(original, cleaned, suggested, "", cleaned);
        }

        // =========================
        // Reports
        // =========================
        private static DataTable BuildVariabilityReport(DataTable input)
        {
            var dt = new DataTable();
            dt.Columns.Add("PrimaryIngredient", typeof(string));
            dt.Columns.Add("RowCount", typeof(int));
            dt.Columns.Add("UniqueGenericNames", typeof(int));
            dt.Columns.Add("ExampleVariants", typeof(string));

            var genericCol = FindColumn(input, "generic_name");
            var primaryCol = FindColumn(input, "PrimaryIngredient");

            if (genericCol == null || primaryCol == null) return dt;

            var groups = input.Rows.Cast<DataRow>()
                .GroupBy(r => (r[primaryCol]?.ToString() ?? "").Trim())
                .OrderByDescending(g => g.Count());

            foreach (var g in groups)
            {
                var ingredient = g.Key;
                if (string.IsNullOrWhiteSpace(ingredient)) ingredient = "(blank)";
                if (ingredient.Equals("NON_DRUG", StringComparison.OrdinalIgnoreCase)) continue;

                var variants = g
                    .Select(r => (r[genericCol]?.ToString() ?? "").Trim())
                    .Where(x => !string.IsNullOrWhiteSpace(x))
                    .Distinct(StringComparer.OrdinalIgnoreCase)
                    .ToList();

                dt.Rows.Add(ingredient, g.Count(), variants.Count, string.Join(" | ", variants.Take(10)));
            }

            return dt;
        }

        private static DataTable BuildValidationExamples(DataTable input, int topIngredients, int examplesPerIngredient)
        {
            var dt = new DataTable();
            dt.Columns.Add("PrimaryIngredient", typeof(string));
            dt.Columns.Add("GenericNameExample", typeof(string));
            dt.Columns.Add("StandardizedPrimaryIngredient", typeof(string));
            dt.Columns.Add("AllIngredients", typeof(string));
            dt.Columns.Add("RuleApplied", typeof(string));

            var genericCol = FindColumn(input, "generic_name");
            var primaryCol = FindColumn(input, "PrimaryIngredient");
            var allCol = FindColumn(input, "AllIngredients");
            var ruleCol = FindColumn(input, "RuleApplied");

            if (genericCol == null || primaryCol == null) return dt;

            var groups = input.Rows.Cast<DataRow>()
                .Where(r => !string.Equals((r[primaryCol]?.ToString() ?? ""), "NON_DRUG", StringComparison.OrdinalIgnoreCase))
                .GroupBy(r => (r[primaryCol]?.ToString() ?? "").Trim())
                .Select(g => new
                {
                    Ingredient = g.Key,
                    RowCount = g.Count(),
                    UniqueVariants = g.Select(r => (r[genericCol]?.ToString() ?? "").Trim())
                                      .Where(x => !string.IsNullOrWhiteSpace(x))
                                      .Distinct(StringComparer.OrdinalIgnoreCase)
                                      .Count(),
                    Rows = g.ToList()
                })
                .OrderByDescending(x => x.UniqueVariants)
                .ThenByDescending(x => x.RowCount)
                .Take(topIngredients)
                .ToList();

            foreach (var g in groups)
            {
                var sample = g.Rows
                    .Select(r => new
                    {
                        Generic = (r[genericCol]?.ToString() ?? "").Trim(),
                        Primary = (r[primaryCol]?.ToString() ?? "").Trim(),
                        All = allCol == null ? "" : (r[allCol]?.ToString() ?? "").Trim(),
                        Rule = ruleCol == null ? "" : (r[ruleCol]?.ToString() ?? "").Trim()
                    })
                    .Where(x => !string.IsNullOrWhiteSpace(x.Generic))
                    .GroupBy(x => x.Generic, StringComparer.OrdinalIgnoreCase)
                    .Select(grp => grp.First())
                    .Take(examplesPerIngredient)
                    .ToList();

                foreach (var ex in sample)
                    dt.Rows.Add(g.Ingredient, ex.Generic, ex.Primary, ex.All, ex.Rule);
            }

            return dt;
        }

        // =========================
        // Output columns
        // =========================
        private static void EnsureOutputColumns(DataTable dt)
        {
            EnsureCol(dt, "PrimaryIngredient", typeof(string));
            EnsureCol(dt, "AllIngredients", typeof(string));
            EnsureCol(dt, "RuleApplied", typeof(string));
            EnsureCol(dt, "NormalizedGeneric", typeof(string));
        }

        private static void EnsureCol(DataTable dt, string name, Type t)
        {
            if (dt.Columns.Cast<DataColumn>().All(c => c.ColumnName != name))
                dt.Columns.Add(name, t);
        }

        private static DataColumn? FindColumn(DataTable dt, string name)
        {
            return dt.Columns.Cast<DataColumn>()
                .FirstOrDefault(c => string.Equals(c.ColumnName, name, StringComparison.OrdinalIgnoreCase));
        }

        // =========================
        // Export column filtering
        // =========================
        private static DataTable CreateFilteredTable(DataTable source, HashSet<string> keepCols)
        {
            var dt = new DataTable();

            foreach (DataColumn col in source.Columns)
            {
                if (keepCols.Contains(col.ColumnName))
                    dt.Columns.Add(col.ColumnName, col.DataType);
            }

            foreach (DataRow row in source.Rows)
            {
                var nr = dt.NewRow();
                foreach (DataColumn col in dt.Columns)
                    nr[col.ColumnName] = row[col.ColumnName];
                dt.Rows.Add(nr);
            }

            return dt;
        }

        // =========================
        // Excel I/O
        // =========================
        private static DataTable LoadFirstSheetToDataTable(string path)
        {
            using var wb = new XLWorkbook(path);
            var ws = wb.Worksheets.First();

            var range = ws.RangeUsed();
            if (range == null) throw new Exception("The first worksheet is empty.");

            var dt = new DataTable();

            var headerRow = range.FirstRowUsed();
            var headerCells = headerRow.CellsUsed().ToList();

            foreach (var cell in headerCells)
            {
                var name = cell.GetString().Trim();
                if (string.IsNullOrWhiteSpace(name))
                    name = "Column" + cell.Address.ColumnNumber;

                var original = name;
                int k = 1;
                while (dt.Columns.Contains(name))
                {
                    name = $"{original}_{k}";
                    k++;
                }

                dt.Columns.Add(name);
            }

            var firstDataRowNumber = headerRow.RowNumber() + 1;
            var lastRowNumber = range.LastRowUsed().RowNumber();

            for (int r = firstDataRowNumber; r <= lastRowNumber; r++)
            {
                var excelRow = ws.Row(r);
                if (excelRow.Cells(1, dt.Columns.Count).All(c => c.IsEmpty()))
                    continue;

                var dr = dt.NewRow();
                for (int i = 0; i < dt.Columns.Count; i++)
                    dr[i] = excelRow.Cell(i + 1).GetValue<string>();

                dt.Rows.Add(dr);
            }

            return dt;
        }

        private static void SaveDataTableToExcel(DataTable dt, string path)
        {
            using var wb = new XLWorkbook();
            var ws = wb.Worksheets.Add("Output");

            for (int c = 0; c < dt.Columns.Count; c++)
                ws.Cell(1, c + 1).Value = dt.Columns[c].ColumnName;

            for (int r = 0; r < dt.Rows.Count; r++)
            {
                for (int c = 0; c < dt.Columns.Count; c++)
                    ws.Cell(r + 2, c + 1).Value = dt.Rows[r][c]?.ToString() ?? "";
            }

            ws.Columns().AdjustToContents();
            wb.SaveAs(path);
        }
    }
}
