using System;
using System.Collections.Generic;
using System.Data;
using System.Drawing;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Windows.Forms;
using ClosedXML.Excel;
using Microsoft.Data.Sqlite;

namespace DrugNameStandardizer
{
    public partial class Form1 : Form
    {
        // =========================
        // State
        // =========================
        private DataTable? _inputTable;

        private DataTable _libraryTable = new DataTable();
        private DataTable _synonymsTable = new DataTable();
        private DataTable _unknownsTable = new DataTable();
        private DataTable _variabilityTable = new DataTable();
        private DataTable _validationTable = new DataTable();

        // tool outputs
        private DataTable _costSavingsTop25Table = new DataTable();
        private DataTable _spendTrendsTable = new DataTable();

        private HashSet<string> _ingredientSet = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        private Dictionary<string, string> _synonymMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);

        private HashSet<string>? _selectedOutputColumns = null;

        private readonly string _dbPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "ingredient_library.db");

        // =========================
        // UI references (needed for ribbon + actions)
        // =========================
        private Label _lblStatus = new Label();
        private TabControl _tabs = new TabControl();

        private DataGridView _libraryGrid = null!;
        private DataGridView _synonymsGrid = null!;
        private DataGridView _inputGrid = null!;
        private DataGridView _unknownsGrid = null!;
        private DataGridView _variabilityGrid = null!;
        private DataGridView _validationGrid = null!;
        private DataGridView _costSavingsGrid = null!;
        private DataGridView _spendTrendsGrid = null!;

        // "Ribbon mimic" area
        private TabControl _ribbonTabs = new TabControl();
        private Panel _topPanel = new Panel();

        // REQUIRED: keep search ribbon EXACTLY as-is
        private ToolStrip _searchRibbon = null!;
        private ToolStripTextBox _txtSearch = null!;
        private ToolStripButton _btnPrev = null!;
        private ToolStripButton _btnNext = null!;

        // REQUIRED: keep tools ribbon concept (ToolStrip)
        private ToolStrip _toolsRibbon = null!;
        private ToolStripDropDownButton _ddTools = null!;

        // enable/disable states formerly controlled by buttons
        private bool _canRun = false;
        private bool _canAnalyzeVariability = false;
        private bool _canGenerateValidation = false;
        private bool _canChooseColumns = false;
        private bool _canSaveOutput = false;
        private bool _canExportUnknowns = false;
        private bool _canExportVariability = false;
        private bool _canExportValidation = false;

        // ribbon buttons we need to enable/disable
        private ToolStripButton _rbRun = null!;
        private ToolStripButton _rbUpload = null!;
        private ToolStripButton _rbAnalyzeVariability = null!;
        private ToolStripButton _rbGenerateValidation = null!;
        private ToolStripButton _rbChooseColumns = null!;
        private ToolStripButton _rbSaveOutput = null!;
        private ToolStripButton _rbExportUnknowns = null!;
        private ToolStripButton _rbExportVariability = null!;
        private ToolStripButton _rbExportValidation = null!;
        private ToolStripButton _rbExportDocs = null!;

        private ToolStripButton _rbLoadLibrary = null!;
        private ToolStripButton _rbImportLibrary = null!;
        private ToolStripButton _rbSaveLibrary = null!;
        private ToolStripButton _rbLoadSynonyms = null!;
        private ToolStripButton _rbImportSynonyms = null!;
        private ToolStripButton _rbSaveSynonyms = null!;

        private ToolStripButton _rbToolCostSavings = null!;
        private ToolStripButton _rbToolSpendTrends = null!;

        // font controls
        private ToolStripComboBox _cbFontFamily = null!;
        private ToolStripComboBox _cbFontSize = null!;
        private ToolStripButton _btnBold = null!;
        private ToolStripButton _btnItalic = null!;
        private ToolStripButton _btnUnderline = null!;
        private ToolStripButton _btnTextColor = null!;
        private ToolStripButton _btnHighlight = null!;

        private FontStyle _gridFontStyle = FontStyle.Regular;

        public Form1()
        {
            InitializeComponent();
            Controls.Clear();

            Width = 1380;
            Height = 840;
            Text = "Generic Name Standardizer — Primary Ingredient (Library + Synonyms + Reports)";
            KeyPreview = true;

            BuildUI();

            // Ensure DB exists
            EnsureDatabase();

            // Initial load
            LoadLibraryFromDb();
            LoadSynonymsFromDb();
            _libraryGrid.DataSource = _libraryTable;
            _synonymsGrid.DataSource = _synonymsTable;

            // Sync initial enable/disable
            SetRunEnabled(false);
            SetPostRunEnabled(false);

            WireSearchLogic();    // KEEP EXACT behavior
            WireToolsDropDown();  // KEEP tool ribbon concept
            WireTabFeatures();    // header delete + ingredient popup

            // shortcuts
            KeyDown += Form1_KeyDown;
        }

        // =========================================================
        // UI BUILD
        // =========================================================
        private void BuildUI()
        {
            // Top panel holds: Ribbon Tabs + Search Ribbon + Tools Ribbon + Status
            _topPanel = new Panel
            {
                Dock = DockStyle.Top,
                Height = 150,
                Padding = new Padding(8, 8, 8, 6)
            };
            Controls.Add(_topPanel);

            // Ribbon mimic TabControl (Office style)
            _ribbonTabs = new TabControl
            {
                Dock = DockStyle.Top,
                Height = 78
            };
            _topPanel.Controls.Add(_ribbonTabs);

            // Build ribbon tabs (each tab contains a ToolStrip)
            _ribbonTabs.TabPages.Add(BuildRibbonTab_File());
            _ribbonTabs.TabPages.Add(BuildRibbonTab_Home());
            _ribbonTabs.TabPages.Add(BuildRibbonTab_Edit());
            _ribbonTabs.TabPages.Add(BuildRibbonTab_View());
            _ribbonTabs.TabPages.Add(BuildRibbonTab_Tools());
            _ribbonTabs.TabPages.Add(BuildRibbonTab_Library());

            // =========================
            // REQUIRED: Search ribbon EXACTLY as-is
            // (Only change: Dock properly so it never "disappears")
            // =========================
            _searchRibbon = new ToolStrip
            {
                Dock = DockStyle.Top,
                GripStyle = ToolStripGripStyle.Hidden,
                Size = new Size(1350, 28)
            };

            var lblSearch = new ToolStripLabel("Search:");
            _txtSearch = new ToolStripTextBox { Width = 320 };
            _btnPrev = new ToolStripButton("Prev");
            _btnNext = new ToolStripButton("Next");

            _searchRibbon.Items.Add(lblSearch);
            _searchRibbon.Items.Add(_txtSearch);
            _searchRibbon.Items.Add(_btnPrev);
            _searchRibbon.Items.Add(_btnNext);

            _topPanel.Controls.Add(_searchRibbon);

            // =========================
            // REQUIRED: Tools ribbon concept (ToolStrip with dropdown)
            // =========================
            _toolsRibbon = new ToolStrip
            {
                Dock = DockStyle.Top,
                GripStyle = ToolStripGripStyle.Hidden,
                Size = new Size(1350, 28)
            };
            _toolsRibbon.Items.Add(new ToolStripLabel("Tools:"));
            _ddTools = new ToolStripDropDownButton("Select Tool");
            _toolsRibbon.Items.Add(_ddTools);
            _topPanel.Controls.Add(_toolsRibbon);

            // Status label
            _lblStatus = new Label
            {
                Dock = DockStyle.Top,
                Height = 22,
                Text = "Status: Ready"
            };
            _topPanel.Controls.Add(_lblStatus);

            // Main tabs (data grids)
            _tabs = new TabControl
            {
                Dock = DockStyle.Fill
            };
            Controls.Add(_tabs);

            var tabLibrary = new TabPage("Ingredient Library (Editable)");
            var tabSynonyms = new TabPage("Synonyms (Editable)");
            var tabInput = new TabPage("Input + Output Preview");
            var tabUnknowns = new TabPage("Unknowns (Needs Review)");
            var tabVariability = new TabPage("Variability Report");
            var tabValidation = new TabPage("Validation Examples");
            var tabCostSavings = new TabPage("Cost Savings");
            var tabSpendTrends = new TabPage("Spend Trends");

            _tabs.TabPages.Add(tabLibrary);
            _tabs.TabPages.Add(tabSynonyms);
            _tabs.TabPages.Add(tabInput);
            _tabs.TabPages.Add(tabUnknowns);
            _tabs.TabPages.Add(tabVariability);
            _tabs.TabPages.Add(tabValidation);
            _tabs.TabPages.Add(tabCostSavings);
            _tabs.TabPages.Add(tabSpendTrends);

            _libraryGrid = MakeEditableGrid();
            _synonymsGrid = MakeEditableGrid();
            _inputGrid = MakeReadOnlyGrid();
            _unknownsGrid = MakeEditableGrid();
            _variabilityGrid = MakeReadOnlyGrid();
            _validationGrid = MakeReadOnlyGrid();
            _costSavingsGrid = MakeReadOnlyGrid();
            _spendTrendsGrid = MakeReadOnlyGrid();

            tabLibrary.Controls.Add(_libraryGrid);
            tabSynonyms.Controls.Add(_synonymsGrid);
            tabInput.Controls.Add(_inputGrid);
            tabUnknowns.Controls.Add(_unknownsGrid);
            tabVariability.Controls.Add(_variabilityGrid);
            tabValidation.Controls.Add(_validationGrid);
            tabCostSavings.Controls.Add(_costSavingsGrid);
            tabSpendTrends.Controls.Add(_spendTrendsGrid);

            // apply default grid font to all
            ApplyGridFontToAll(new Font("Segoe UI", 9f, FontStyle.Regular));
        }

        // =========================================================
        // Ribbon Tabs
        // =========================================================
        private TabPage BuildRibbonTab_File()
        {
            var tab = new TabPage("File");
            var strip = MakeRibbonStrip();

            _rbUpload = MakeRibbonButton("Upload File (Ctrl+O)", UploadInput_Click);
            _rbRun = MakeRibbonButton("Run (Ctrl+R)", Run_Click);
            MakeRunGreen(_rbRun);

            _rbSaveOutput = MakeRibbonButton("Save Output (Ctrl+S)", SaveOutput_Click);
            _rbChooseColumns = MakeRibbonButton("Choose Columns", ChooseColumns_Click);

            _rbExportDocs = MakeRibbonButton("Export Documentation", ExportDocs_Click);
            _rbExportUnknowns = MakeRibbonButton("Export Unknowns", ExportUnknowns_Click);
            _rbExportVariability = MakeRibbonButton("Export Variability", ExportVariability_Click);
            _rbExportValidation = MakeRibbonButton("Export Validation", ExportValidation_Click);

            strip.Items.Add(new ToolStripLabel("Open"));
            strip.Items.Add(_rbUpload);
            strip.Items.Add(new ToolStripSeparator());
            strip.Items.Add(new ToolStripLabel("Run"));
            strip.Items.Add(_rbRun);
            strip.Items.Add(new ToolStripSeparator());
            strip.Items.Add(new ToolStripLabel("Save / Export"));
            strip.Items.Add(_rbChooseColumns);
            strip.Items.Add(_rbSaveOutput);
            strip.Items.Add(new ToolStripSeparator());
            strip.Items.Add(_rbExportUnknowns);
            strip.Items.Add(_rbExportVariability);
            strip.Items.Add(_rbExportValidation);
            strip.Items.Add(new ToolStripSeparator());
            strip.Items.Add(_rbExportDocs);

            tab.Controls.Add(strip);
            return tab;
        }

        private TabPage BuildRibbonTab_Home()
        {
            var tab = new TabPage("Home");
            var strip = MakeRibbonStrip();

            // quick actions
            var upload = MakeRibbonButton("Upload", UploadInput_Click);
            var run = MakeRibbonButton("Run", Run_Click);
            MakeRunGreen(run);

            strip.Items.Add(new ToolStripLabel("Quick"));
            strip.Items.Add(upload);
            strip.Items.Add(run);

            strip.Items.Add(new ToolStripSeparator());

            // Font group for grids
            strip.Items.Add(new ToolStripLabel("Font"));

            _cbFontFamily = new ToolStripComboBox { Width = 170, DropDownStyle = ComboBoxStyle.DropDownList };
            foreach (var ff in FontFamily.Families.OrderBy(f => f.Name))
                _cbFontFamily.Items.Add(ff.Name);
            _cbFontFamily.SelectedItem = "Segoe UI";
            _cbFontFamily.SelectedIndexChanged += (_, __) => ApplyGridFontFromControls();

            _cbFontSize = new ToolStripComboBox { Width = 70, DropDownStyle = ComboBoxStyle.DropDownList };
            foreach (var s in new[] { "8", "9", "10", "11", "12", "14", "16", "18", "20", "24" })
                _cbFontSize.Items.Add(s);
            _cbFontSize.SelectedItem = "9";
            _cbFontSize.SelectedIndexChanged += (_, __) => ApplyGridFontFromControls();

            _btnBold = new ToolStripButton("B") { CheckOnClick = true, Font = new Font("Segoe UI", 9, FontStyle.Bold) };
            _btnItalic = new ToolStripButton("I") { CheckOnClick = true, Font = new Font("Segoe UI", 9, FontStyle.Italic) };
            _btnUnderline = new ToolStripButton("U") { CheckOnClick = true, Font = new Font("Segoe UI", 9, FontStyle.Underline) };

            _btnBold.CheckedChanged += (_, __) => ApplyGridFontFromControls();
            _btnItalic.CheckedChanged += (_, __) => ApplyGridFontFromControls();
            _btnUnderline.CheckedChanged += (_, __) => ApplyGridFontFromControls();

            _btnTextColor = MakeRibbonButton("Text Color", (_, __) => PickTextColorForActiveGrid());
            _btnHighlight = MakeRibbonButton("Highlight", (_, __) => PickHighlightForActiveGrid());

            strip.Items.Add(_cbFontFamily);
            strip.Items.Add(_cbFontSize);
            strip.Items.Add(_btnBold);
            strip.Items.Add(_btnItalic);
            strip.Items.Add(_btnUnderline);
            strip.Items.Add(new ToolStripSeparator());
            strip.Items.Add(_btnTextColor);
            strip.Items.Add(_btnHighlight);

            tab.Controls.Add(strip);
            return tab;
        }

        private TabPage BuildRibbonTab_Edit()
        {
            var tab = new TabPage("Edit");
            var strip = MakeRibbonStrip();

            strip.Items.Add(new ToolStripLabel("Data"));
            strip.Items.Add(MakeRibbonButton("Choose Output Columns", ChooseColumns_Click));
            strip.Items.Add(new ToolStripSeparator());
            strip.Items.Add(MakeRibbonButton("Save Output", SaveOutput_Click));

            tab.Controls.Add(strip);
            return tab;
        }

        private TabPage BuildRibbonTab_View()
        {
            var tab = new TabPage("View");
            var strip = MakeRibbonStrip();

            strip.Items.Add(new ToolStripLabel("Tabs"));
            strip.Items.Add(MakeRibbonButton("Go: Input", (_, __) => SelectTabByName("Input + Output Preview")));
            strip.Items.Add(MakeRibbonButton("Go: Unknowns", (_, __) => SelectTabByName("Unknowns (Needs Review)")));
            strip.Items.Add(MakeRibbonButton("Go: Variability", (_, __) => SelectTabByName("Variability Report")));
            strip.Items.Add(MakeRibbonButton("Go: Validation", (_, __) => SelectTabByName("Validation Examples")));

            tab.Controls.Add(strip);
            return tab;
        }

        private TabPage BuildRibbonTab_Tools()
        {
            var tab = new TabPage("Tools");
            var strip = MakeRibbonStrip();

            _rbAnalyzeVariability = MakeRibbonButton("Analyze Variability", AnalyzeVariability_Click);
            _rbGenerateValidation = MakeRibbonButton("Generate Validation", GenerateValidation_Click);

            _rbToolCostSavings = MakeRibbonButton("Cost-Savings Finder", (_, __) =>
            {
                if (_inputTable == null) { MessageBox.Show("Upload an input Excel file first."); return; }
                try
                {
                    RunCostSavingsOpportunityFinder(_inputTable, _costSavingsGrid);
                    _lblStatus.Text = "Status: Cost-Savings computed. Top 25 shown.";
                    SelectTabByName("Cost Savings");
                }
                catch (Exception ex) { MessageBox.Show(ex.Message, "Cost-Savings Tool Error"); }
            });

            _rbToolSpendTrends = MakeRibbonButton("Spend Trends", (_, __) =>
            {
                if (_inputTable == null) { MessageBox.Show("Upload an input Excel file first."); return; }
                try
                {
                    RunTherapeuticSpendTrends(_inputTable, _spendTrendsGrid);
                    _lblStatus.Text = $"Status: Spend Trends created ({_spendTrendsTable.Rows.Count} rows).";
                    SelectTabByName("Spend Trends");
                }
                catch (Exception ex) { MessageBox.Show(ex.Message, "Spend Trends Tool Error"); }
            });

            strip.Items.Add(new ToolStripLabel("Reports"));
            strip.Items.Add(_rbAnalyzeVariability);
            strip.Items.Add(_rbGenerateValidation);
            strip.Items.Add(new ToolStripSeparator());
            strip.Items.Add(new ToolStripLabel("Extra Tools"));
            strip.Items.Add(_rbToolCostSavings);
            strip.Items.Add(_rbToolSpendTrends);

            tab.Controls.Add(strip);
            return tab;
        }

        private TabPage BuildRibbonTab_Library()
        {
            var tab = new TabPage("Library");
            var strip = MakeRibbonStrip();

            _rbLoadLibrary = MakeRibbonButton("Load Library", LoadLibrary_Click);
            _rbImportLibrary = MakeRibbonButton("Import Library (Excel)", ImportLibrary_Click);
            _rbSaveLibrary = MakeRibbonButton("Save Library", SaveLibrary_Click);

            _rbLoadSynonyms = MakeRibbonButton("Load Synonyms", LoadSynonyms_Click);
            _rbImportSynonyms = MakeRibbonButton("Import Synonyms (Excel)", ImportSynonyms_Click);
            _rbSaveSynonyms = MakeRibbonButton("Save Synonyms", SaveSynonyms_Click);

            strip.Items.Add(new ToolStripLabel("Ingredients"));
            strip.Items.Add(_rbLoadLibrary);
            strip.Items.Add(_rbImportLibrary);
            strip.Items.Add(_rbSaveLibrary);
            strip.Items.Add(new ToolStripSeparator());
            strip.Items.Add(new ToolStripLabel("Synonyms"));
            strip.Items.Add(_rbLoadSynonyms);
            strip.Items.Add(_rbImportSynonyms);
            strip.Items.Add(_rbSaveSynonyms);

            tab.Controls.Add(strip);
            return tab;
        }

        private ToolStrip MakeRibbonStrip()
        {
            return new ToolStrip
            {
                Dock = DockStyle.Fill,
                GripStyle = ToolStripGripStyle.Hidden,
                ImageScalingSize = new Size(20, 20),
                Padding = new Padding(6, 6, 6, 6)
            };
        }

        private ToolStripButton MakeRibbonButton(string text, EventHandler onClick)
        {
            var b = new ToolStripButton(text)
            {
                DisplayStyle = ToolStripItemDisplayStyle.Text,
                AutoSize = true
            };
            b.Click += onClick;
            return b;
        }

        private void MakeRunGreen(ToolStripButton b)
        {
            b.BackColor = Color.FromArgb(0, 170, 0);
            b.ForeColor = Color.White;
        }

        private void SelectTabByName(string name)
        {
            foreach (TabPage p in _tabs.TabPages)
                if (p.Text == name) { _tabs.SelectedTab = p; return; }
        }

        // =========================================================
        // Shortcuts
        // =========================================================
        private void Form1_KeyDown(object? sender, KeyEventArgs e)
        {
            if (e.Control && e.KeyCode == Keys.O)
            {
                UploadInput_Click(this, EventArgs.Empty);
                e.SuppressKeyPress = true;
                return;
            }
            if (e.Control && e.KeyCode == Keys.R)
            {
                if (_rbRun.Enabled) Run_Click(this, EventArgs.Empty);
                e.SuppressKeyPress = true;
                return;
            }
            if (e.Control && e.KeyCode == Keys.F)
            {
                _txtSearch.Focus();
                _txtSearch.SelectAll();
                e.SuppressKeyPress = true;
                return;
            }
            if (e.Control && e.KeyCode == Keys.S)
            {
                if (_rbSaveOutput.Enabled) SaveOutput_Click(this, EventArgs.Empty);
                e.SuppressKeyPress = true;
                return;
            }
        }

        // =========================================================
        // Enable/Disable sync
        // =========================================================
        private void SetRunEnabled(bool enabled)
        {
            _canRun = enabled;
            if (_rbRun != null) _rbRun.Enabled = enabled;
        }

        private void SetPostRunEnabled(bool enabled)
        {
            _canSaveOutput = enabled;
            _canChooseColumns = enabled;
            _canAnalyzeVariability = enabled;
            _canGenerateValidation = enabled;

            if (_rbSaveOutput != null) _rbSaveOutput.Enabled = enabled;
            if (_rbChooseColumns != null) _rbChooseColumns.Enabled = enabled;
            if (_rbAnalyzeVariability != null) _rbAnalyzeVariability.Enabled = enabled;
            if (_rbGenerateValidation != null) _rbGenerateValidation.Enabled = enabled;

            // exports depend on data presence; set separately after generation
            if (_rbExportUnknowns != null) _rbExportUnknowns.Enabled = false;
            if (_rbExportVariability != null) _rbExportVariability.Enabled = false;
            if (_rbExportValidation != null) _rbExportValidation.Enabled = false;
        }

        private void SyncExportButtons()
        {
            if (_rbExportUnknowns != null) _rbExportUnknowns.Enabled = _unknownsTable.Rows.Count > 0;
            if (_rbExportVariability != null) _rbExportVariability.Enabled = _variabilityTable.Rows.Count > 0;
            if (_rbExportValidation != null) _rbExportValidation.Enabled = _validationTable.Rows.Count > 0;
        }

        // =========================================================
        // Font controls apply to DATA TABLE GRIDS
        // =========================================================
        private void ApplyGridFontFromControls()
        {
            try
            {
                string family = _cbFontFamily.SelectedItem?.ToString() ?? "Segoe UI";
                float size = float.TryParse(_cbFontSize.SelectedItem?.ToString(), out float s) ? s : 9f;

                _gridFontStyle = FontStyle.Regular;
                if (_btnBold.Checked) _gridFontStyle |= FontStyle.Bold;
                if (_btnItalic.Checked) _gridFontStyle |= FontStyle.Italic;
                if (_btnUnderline.Checked) _gridFontStyle |= FontStyle.Underline;

                var f = new Font(family, size, _gridFontStyle);
                ApplyGridFontToAll(f);
            }
            catch
            {
                // ignore bad font selections
            }
        }

        private void ApplyGridFontToAll(Font f)
        {
            foreach (var g in AllGrids())
            {
                g.Font = f;
                g.ColumnHeadersDefaultCellStyle.Font = new Font(f.FontFamily, f.Size, FontStyle.Bold);
                g.RowHeadersDefaultCellStyle.Font = f;
            }
        }

        private IEnumerable<DataGridView> AllGrids()
        {
            yield return _libraryGrid;
            yield return _synonymsGrid;
            yield return _inputGrid;
            yield return _unknownsGrid;
            yield return _variabilityGrid;
            yield return _validationGrid;
            yield return _costSavingsGrid;
            yield return _spendTrendsGrid;
        }

        private DataGridView GetActiveGrid()
        {
            var name = _tabs.SelectedTab?.Text ?? "";
            return name switch
            {
                "Ingredient Library (Editable)" => _libraryGrid,
                "Synonyms (Editable)" => _synonymsGrid,
                "Input + Output Preview" => _inputGrid,
                "Unknowns (Needs Review)" => _unknownsGrid,
                "Variability Report" => _variabilityGrid,
                "Validation Examples" => _validationGrid,
                "Cost Savings" => _costSavingsGrid,
                "Spend Trends" => _spendTrendsGrid,
                _ => _inputGrid
            };
        }

        private void PickTextColorForActiveGrid()
        {
            using var cd = new ColorDialog();
            if (cd.ShowDialog() != DialogResult.OK) return;
            GetActiveGrid().DefaultCellStyle.ForeColor = cd.Color;
        }

        private void PickHighlightForActiveGrid()
        {
            using var cd = new ColorDialog();
            if (cd.ShowDialog() != DialogResult.OK) return;
            GetActiveGrid().DefaultCellStyle.BackColor = cd.Color;
        }

        // =========================================================
        // Search logic (KEEP EXACT behavior)
        // =========================================================
        private void WireSearchLogic()
        {
            string lastTerm = "";
            int lastRow = -1;
            int lastCol = -1;

            bool Find(bool forward)
            {
                if (_inputTable == null && _tabs.SelectedTab?.Text == "Input + Output Preview")
                {
                    MessageBox.Show("Upload an input Excel file first.");
                    return false;
                }

                var term = (_txtSearch.Text ?? "").Trim();
                if (string.IsNullOrWhiteSpace(term))
                {
                    _lblStatus.Text = "Status: Search is empty.";
                    return false;
                }

                if (!term.Equals(lastTerm, StringComparison.OrdinalIgnoreCase))
                {
                    lastTerm = term;
                    lastRow = -1;
                    lastCol = -1;
                }

                DataGridView activeGrid;
                DataTable? activeTable;

                var tabText = _tabs.SelectedTab?.Text ?? "";

                if (tabText == "Input + Output Preview") { activeGrid = _inputGrid; activeTable = _inputTable; }
                else if (tabText == "Ingredient Library (Editable)") { activeGrid = _libraryGrid; activeTable = _libraryTable; }
                else if (tabText == "Synonyms (Editable)") { activeGrid = _synonymsGrid; activeTable = _synonymsTable; }
                else if (tabText == "Unknowns (Needs Review)") { activeGrid = _unknownsGrid; activeTable = _unknownsTable; }
                else if (tabText == "Variability Report") { activeGrid = _variabilityGrid; activeTable = _variabilityTable; }
                else if (tabText == "Validation Examples") { activeGrid = _validationGrid; activeTable = _validationTable; }
                else if (tabText == "Cost Savings") { activeGrid = _costSavingsGrid; activeTable = _costSavingsTop25Table; }
                else if (tabText == "Spend Trends") { activeGrid = _spendTrendsGrid; activeTable = _spendTrendsTable; }
                else { activeGrid = _inputGrid; activeTable = _inputTable; }

                if (activeTable == null || activeTable.Columns.Count == 0 || activeTable.Rows.Count == 0)
                {
                    _lblStatus.Text = "Status: Nothing to search on this tab.";
                    return false;
                }

                int rowCount = activeTable.Rows.Count;
                int colCount = activeTable.Columns.Count;

                int startRow = lastRow;
                int startCol = lastCol;

                if (startRow < 0) { startRow = 0; startCol = -1; }

                if (forward)
                {
                    for (int r = startRow; r < rowCount; r++)
                    {
                        int cStart = (r == startRow) ? startCol + 1 : 0;
                        for (int c = cStart; c < colCount; c++)
                        {
                            var v = activeTable.Rows[r][c]?.ToString() ?? "";
                            if (v.IndexOf(term, StringComparison.OrdinalIgnoreCase) >= 0)
                            {
                                SelectCell(activeGrid, r, c);
                                lastRow = r; lastCol = c;
                                _lblStatus.Text = $"Status: Found '{term}' at row {r + 1}, col {activeTable.Columns[c].ColumnName}.";
                                return true;
                            }
                        }
                    }

                    for (int r = 0; r <= startRow; r++)
                    {
                        for (int c = 0; c < colCount; c++)
                        {
                            if (r == startRow && c >= startCol) break;
                            var v = activeTable.Rows[r][c]?.ToString() ?? "";
                            if (v.IndexOf(term, StringComparison.OrdinalIgnoreCase) >= 0)
                            {
                                SelectCell(activeGrid, r, c);
                                lastRow = r; lastCol = c;
                                _lblStatus.Text = $"Status: Found '{term}' (wrapped) at row {r + 1}, col {activeTable.Columns[c].ColumnName}.";
                                return true;
                            }
                        }
                    }
                }
                else
                {
                    for (int r = startRow; r >= 0; r--)
                    {
                        int cStart = (r == startRow) ? startCol - 1 : colCount - 1;
                        for (int c = cStart; c >= 0; c--)
                        {
                            var v = activeTable.Rows[r][c]?.ToString() ?? "";
                            if (v.IndexOf(term, StringComparison.OrdinalIgnoreCase) >= 0)
                            {
                                SelectCell(activeGrid, r, c);
                                lastRow = r; lastCol = c;
                                _lblStatus.Text = $"Status: Found '{term}' at row {r + 1}, col {activeTable.Columns[c].ColumnName}.";
                                return true;
                            }
                        }
                    }

                    for (int r = rowCount - 1; r >= startRow; r--)
                    {
                        for (int c = colCount - 1; c >= 0; c--)
                        {
                            if (r == startRow && c <= startCol) break;
                            var v = activeTable.Rows[r][c]?.ToString() ?? "";
                            if (v.IndexOf(term, StringComparison.OrdinalIgnoreCase) >= 0)
                            {
                                SelectCell(activeGrid, r, c);
                                lastRow = r; lastCol = c;
                                _lblStatus.Text = $"Status: Found '{term}' (wrapped) at row {r + 1}, col {activeTable.Columns[c].ColumnName}.";
                                return true;
                            }
                        }
                    }
                }

                _lblStatus.Text = $"Status: '{term}' not found.";
                return false;
            }

            _btnNext.Click += (_, __) => Find(true);
            _btnPrev.Click += (_, __) => Find(false);

            _txtSearch.KeyDown += (_, e) =>
            {
                if (e.KeyCode == Keys.Enter)
                {
                    Find(true);
                    e.SuppressKeyPress = true;
                }
            };
        }

        // =========================================================
        // Tools dropdown (kept)
        // =========================================================
        private void WireToolsDropDown()
        {
            _ddTools.DropDownItems.Clear();

            _ddTools.DropDownItems.Add(new ToolStripMenuItem("Run Standardization", null, (_, __) => Run_Click(this, EventArgs.Empty)));
            _ddTools.DropDownItems.Add(new ToolStripMenuItem("Analyze Variability", null, (_, __) => AnalyzeVariability_Click(this, EventArgs.Empty)) { Enabled = false });
            _ddTools.DropDownItems.Add(new ToolStripMenuItem("Generate Validation", null, (_, __) => GenerateValidation_Click(this, EventArgs.Empty)) { Enabled = false });
            _ddTools.DropDownItems.Add(new ToolStripSeparator());

            _ddTools.DropDownItems.Add(new ToolStripMenuItem("Cost-Savings Opportunity Finder", null, (_, __) =>
            {
                if (_inputTable == null) { MessageBox.Show("Upload an input Excel file first."); return; }
                try
                {
                    RunCostSavingsOpportunityFinder(_inputTable, _costSavingsGrid);
                    _lblStatus.Text = "Status: Cost-Savings computed. Top 25 shown.";
                    SelectTabByName("Cost Savings");
                }
                catch (Exception ex) { MessageBox.Show(ex.Message, "Cost-Savings Tool Error"); }
            }));

            _ddTools.DropDownItems.Add(new ToolStripMenuItem("Therapeutic Category Spend Trends", null, (_, __) =>
            {
                if (_inputTable == null) { MessageBox.Show("Upload an input Excel file first."); return; }
                try
                {
                    RunTherapeuticSpendTrends(_inputTable, _spendTrendsGrid);
                    _lblStatus.Text = $"Status: Spend Trends created ({_spendTrendsTable.Rows.Count} rows).";
                    SelectTabByName("Spend Trends");
                }
                catch (Exception ex) { MessageBox.Show(ex.Message, "Spend Trends Tool Error"); }
            }));
        }

        // =========================================================
        // Tab features (delete column + ingredient popup)
        // =========================================================
        private void WireTabFeatures()
        {
            // Right-click header delete column for input preview
            var inputHeaderMenu = new ContextMenuStrip();
            var miDeleteColumn = new ToolStripMenuItem("Delete Column");
            inputHeaderMenu.Items.Add(miDeleteColumn);

            string? lastRightClickedColumnName = null;

            _inputGrid.ColumnHeaderMouseClick += (_, e) =>
            {
                if (e.Button != MouseButtons.Right) return;
                if (e.ColumnIndex < 0) return;

                lastRightClickedColumnName = _inputGrid.Columns[e.ColumnIndex].Name;

                _inputGrid.ClearSelection();
                _inputGrid.Columns[e.ColumnIndex].Selected = true;
                inputHeaderMenu.Show(Cursor.Position);
            };

            miDeleteColumn.Click += (_, __) =>
            {
                if (_inputTable == null) return;
                if (string.IsNullOrWhiteSpace(lastRightClickedColumnName)) return;

                var protectedCols = new HashSet<string>(StringComparer.OrdinalIgnoreCase) { "generic_name" };
                if (protectedCols.Contains(lastRightClickedColumnName))
                {
                    MessageBox.Show($"You cannot delete required column: {lastRightClickedColumnName}", "Protected Column");
                    return;
                }

                if (!_inputTable.Columns.Contains(lastRightClickedColumnName)) return;

                var confirm = MessageBox.Show(
                    $"Delete column '{lastRightClickedColumnName}' from the preview table?\n\nThis removes it from the current loaded data in the program.",
                    "Confirm Delete Column",
                    MessageBoxButtons.YesNo,
                    MessageBoxIcon.Warning
                );

                if (confirm != DialogResult.Yes) return;

                _inputTable.Columns.Remove(lastRightClickedColumnName);
                _selectedOutputColumns?.Remove(lastRightClickedColumnName);

                _inputGrid.DataSource = _inputTable;
                _inputGrid.Refresh();

                _lblStatus.Text = $"Status: Deleted column '{lastRightClickedColumnName}' from preview.";
            };

            // Click PrimaryIngredient cell -> popup count + unique forms
            _inputGrid.CellClick += (_, e) =>
            {
                if (e.RowIndex < 0 || e.ColumnIndex < 0) return;
                if (_inputTable == null) return;

                var clickedColName = _inputGrid.Columns[e.ColumnIndex].Name;
                if (!clickedColName.Equals("PrimaryIngredient", StringComparison.OrdinalIgnoreCase))
                    return;

                var ingredient = _inputGrid.Rows[e.RowIndex].Cells[e.ColumnIndex].Value?.ToString()?.Trim();
                if (string.IsNullOrWhiteSpace(ingredient)) return;

                var primaryCol = FindColumn(_inputTable, "PrimaryIngredient");
                var genericCol = FindColumn(_inputTable, "generic_name");
                if (primaryCol == null || genericCol == null)
                {
                    MessageBox.Show("Missing required columns: PrimaryIngredient or generic_name.", "Error");
                    return;
                }

                int count = 0;
                var uniqueForms = new HashSet<string>(StringComparer.OrdinalIgnoreCase);

                foreach (DataRow r in _inputTable.Rows)
                {
                    var p = (r[primaryCol]?.ToString() ?? "").Trim();
                    if (!p.Equals(ingredient, StringComparison.OrdinalIgnoreCase)) continue;

                    count++;

                    var g = (r[genericCol]?.ToString() ?? "").Trim();
                    if (!string.IsNullOrWhiteSpace(g))
                        uniqueForms.Add(g);
                }

                var sb = new StringBuilder();
                sb.AppendLine($"Primary Ingredient: {ingredient}");
                sb.AppendLine($"Mentioned: {count} time(s)");
                sb.AppendLine();
                sb.AppendLine("Unique forms in sheet (no duplicates):");
                sb.AppendLine("-------------------------------------");
                foreach (var form in uniqueForms.OrderBy(x => x))
                    sb.AppendLine("• " + form);

                ShowBigPopup(sb.ToString(), $"Ingredient Summary — {ingredient}");
            };
        }

        // =========================================================
        // RIBBON ACTIONS (call your ORIGINAL logic)
        // =========================================================

        private void LoadLibrary_Click(object? sender, EventArgs e)
        {
            try
            {
                LoadLibraryFromDb();
                _libraryGrid.DataSource = _libraryTable;
                _lblStatus.Text = $"Status: Library loaded ({_libraryTable.Rows.Count} ingredients).";
            }
            catch (Exception ex) { MessageBox.Show(ex.Message, "Load Library Error"); }
        }

        private void ImportLibrary_Click(object? sender, EventArgs e)
        {
            using var ofd = new OpenFileDialog { Filter = "Excel Files (*.xlsx)|*.xlsx", Title = "Select Ingredient Library Excel" };
            if (ofd.ShowDialog() != DialogResult.OK) return;

            try
            {
                int added = ImportIngredientsFromExcel(ofd.FileName);
                LoadLibraryFromDb();
                _libraryGrid.DataSource = _libraryTable;
                _lblStatus.Text = $"Status: Imported ingredients. Added {added}. Total {_libraryTable.Rows.Count}.";
            }
            catch (Exception ex) { MessageBox.Show(ex.Message, "Import Library Error"); }
        }

        private void SaveLibrary_Click(object? sender, EventArgs e)
        {
            try
            {
                SaveIngredientsToDb(_libraryTable);
                LoadLibraryFromDb();
                _libraryGrid.DataSource = _libraryTable;
                _lblStatus.Text = $"Status: Library saved. Total {_libraryTable.Rows.Count}.";
            }
            catch (Exception ex) { MessageBox.Show(ex.Message, "Save Library Error"); }
        }

        private void LoadSynonyms_Click(object? sender, EventArgs e)
        {
            try
            {
                LoadSynonymsFromDb();
                _synonymsGrid.DataSource = _synonymsTable;
                _lblStatus.Text = $"Status: Synonyms loaded ({_synonymsTable.Rows.Count} mappings).";
            }
            catch (Exception ex) { MessageBox.Show(ex.Message, "Load Synonyms Error"); }
        }

        private void ImportSynonyms_Click(object? sender, EventArgs e)
        {
            using var ofd = new OpenFileDialog { Filter = "Excel Files (*.xlsx)|*.xlsx", Title = "Select Synonyms Excel" };
            if (ofd.ShowDialog() != DialogResult.OK) return;

            try
            {
                int added = ImportSynonymsFromExcel(ofd.FileName);
                LoadSynonymsFromDb();
                _synonymsGrid.DataSource = _synonymsTable;
                _lblStatus.Text = $"Status: Imported synonyms. Added {added}. Total {_synonymsTable.Rows.Count}.";
            }
            catch (Exception ex) { MessageBox.Show(ex.Message, "Import Synonyms Error"); }
        }

        private void SaveSynonyms_Click(object? sender, EventArgs e)
        {
            try
            {
                SaveSynonymsToDb(_synonymsTable);
                LoadSynonymsFromDb();
                _synonymsGrid.DataSource = _synonymsTable;
                _lblStatus.Text = $"Status: Synonyms saved. Total {_synonymsTable.Rows.Count}.";
            }
            catch (Exception ex) { MessageBox.Show(ex.Message, "Save Synonyms Error"); }
        }

        private void UploadInput_Click(object? sender, EventArgs e)
        {
            using var ofd = new OpenFileDialog { Filter = "Excel Files (*.xlsx)|*.xlsx", Title = "Select Input Excel" };
            if (ofd.ShowDialog() != DialogResult.OK) return;

            try
            {
                _inputTable = LoadFirstSheetToDataTable(ofd.FileName);
                _inputGrid.DataSource = _inputTable;

                SetRunEnabled(true);
                SetPostRunEnabled(false);

                _selectedOutputColumns = null;

                _lblStatus.Text = $"Status: Input loaded ({_inputTable.Rows.Count} rows). (Right-click column header to delete columns)";
                SelectTabByName("Input + Output Preview");
            }
            catch (Exception ex) { MessageBox.Show(ex.Message, "Input Load Error"); }
        }

        private void Run_Click(object? sender, EventArgs e)
        {
            if (_inputTable == null)
            {
                MessageBox.Show("Upload an input Excel file first.");
                return;
            }

            if (_ingredientSet.Count == 0)
            {
                MessageBox.Show("Ingredient Library is empty. Import/add ingredients first.");
                return;
            }

            var genericCol = FindColumn(_inputTable, "generic_name");
            if (genericCol == null)
            {
                MessageBox.Show("Input must have a column named 'generic_name' in header row.");
                return;
            }

            EnsureOutputColumns(_inputTable);

            _lblStatus.Text = "Status: Standardizing...";
            Application.DoEvents();

            BuildUnknownsTableSchema();

            int unknownCount = 0;

            foreach (DataRow row in _inputTable.Rows)
            {
                var raw = row[genericCol]?.ToString() ?? "";
                var result = ExtractWithRules(raw, _ingredientSet, _synonymMap);

                row["PrimaryIngredient"] = result.PrimaryIngredient;
                row["AllIngredients"] = result.AllIngredients;
                row["RuleApplied"] = result.RuleApplied;
                row["NormalizedGeneric"] = result.CleanedForMatching;

                if (result.IsUnknown)
                {
                    unknownCount++;
                    AddUnknownRow(raw, result.CleanedForMatching, result.SuggestedIngredient);
                }
            }

            _inputGrid.Refresh();
            _unknownsGrid.DataSource = _unknownsTable;

            _selectedOutputColumns = new HashSet<string>(
                _inputTable.Columns.Cast<DataColumn>().Select(c => c.ColumnName),
                StringComparer.OrdinalIgnoreCase
            );

            SetPostRunEnabled(true);
            SyncExportButtons();

            LogRun(_inputTable.Rows.Count, unknownCount);

            _lblStatus.Text = $"Status: Done. Unknowns: {unknownCount}. Click PrimaryIngredient cell for popup. Right-click column header to delete preview columns.";
        }

        private void ChooseColumns_Click(object? sender, EventArgs e)
        {
            if (_inputTable == null) return;

            var allCols = _inputTable.Columns.Cast<DataColumn>().Select(c => c.ColumnName).ToList();

            if (_selectedOutputColumns == null)
                _selectedOutputColumns = new HashSet<string>(allCols, StringComparer.OrdinalIgnoreCase);

            using var dlg = new ColumnPickerDialog(allCols, _selectedOutputColumns);
            if (dlg.ShowDialog() == DialogResult.OK)
            {
                _selectedOutputColumns = dlg.SelectedColumns;
                _lblStatus.Text = $"Status: Output columns selected ({_selectedOutputColumns.Count} columns).";
            }
        }

        private void AnalyzeVariability_Click(object? sender, EventArgs e)
        {
            if (_inputTable == null) return;

            _variabilityTable = BuildVariabilityReport(_inputTable);
            _variabilityGrid.DataSource = _variabilityTable;

            SyncExportButtons();

            _lblStatus.Text = $"Status: Variability report created ({_variabilityTable.Rows.Count} ingredients).";
            SelectTabByName("Variability Report");
        }

        private void GenerateValidation_Click(object? sender, EventArgs e)
        {
            if (_inputTable == null) return;

            _validationTable = BuildValidationExamples(_inputTable, topIngredients: 20, examplesPerIngredient: 10);
            _validationGrid.DataSource = _validationTable;

            SyncExportButtons();

            _lblStatus.Text = $"Status: Validation examples created ({_validationTable.Rows.Count} rows).";
            SelectTabByName("Validation Examples");
        }

        private void SaveOutput_Click(object? sender, EventArgs e)
        {
            if (_inputTable == null) return;

            using var sfd = new SaveFileDialog
            {
                Filter = "Excel Files (*.xlsx)|*.xlsx",
                Title = "Save Standardized Output",
                FileName = "standardized_output.xlsx"
            };
            if (sfd.ShowDialog() != DialogResult.OK) return;

            try
            {
                DataTable toSave = _inputTable;

                if (_selectedOutputColumns != null)
                    toSave = CreateFilteredTable(_inputTable, _selectedOutputColumns);

                SaveDataTableToExcel(toSave, sfd.FileName);
                _lblStatus.Text = $"Status: Output saved -> {sfd.FileName}";
            }
            catch (Exception ex) { MessageBox.Show(ex.Message, "Save Output Error"); }
        }

        private void ExportUnknowns_Click(object? sender, EventArgs e)
        {
            if (_unknownsTable.Rows.Count == 0) return;

            using var sfd = new SaveFileDialog
            {
                Filter = "Excel Files (*.xlsx)|*.xlsx",
                Title = "Save Unknowns",
                FileName = "unknowns.xlsx"
            };
            if (sfd.ShowDialog() != DialogResult.OK) return;

            try
            {
                SaveDataTableToExcel(_unknownsTable, sfd.FileName);
                _lblStatus.Text = $"Status: Unknowns exported -> {sfd.FileName}";
            }
            catch (Exception ex) { MessageBox.Show(ex.Message, "Export Unknowns Error"); }
        }

        private void ExportVariability_Click(object? sender, EventArgs e)
        {
            if (_variabilityTable.Rows.Count == 0) return;

            using var sfd = new SaveFileDialog
            {
                Filter = "Excel Files (*.xlsx)|*.xlsx",
                Title = "Save Variability Report",
                FileName = "variability_report.xlsx"
            };
            if (sfd.ShowDialog() != DialogResult.OK) return;

            try
            {
                SaveDataTableToExcel(_variabilityTable, sfd.FileName);
                _lblStatus.Text = $"Status: Variability exported -> {sfd.FileName}";
            }
            catch (Exception ex) { MessageBox.Show(ex.Message, "Export Variability Error"); }
        }

        private void ExportValidation_Click(object? sender, EventArgs e)
        {
            if (_validationTable.Rows.Count == 0) return;

            using var sfd = new SaveFileDialog
            {
                Filter = "Excel Files (*.xlsx)|*.xlsx",
                Title = "Save Validation Examples",
                FileName = "validation_examples.xlsx"
            };
            if (sfd.ShowDialog() != DialogResult.OK) return;

            try
            {
                SaveDataTableToExcel(_validationTable, sfd.FileName);
                _lblStatus.Text = $"Status: Validation exported -> {sfd.FileName}";
            }
            catch (Exception ex) { MessageBox.Show(ex.Message, "Export Validation Error"); }
        }

        private void ExportDocs_Click(object? sender, EventArgs e)
        {
            using var sfd = new SaveFileDialog
            {
                Filter = "Text Files (*.txt)|*.txt",
                Title = "Save Documentation",
                FileName = "Standardization_Documentation.txt"
            };
            if (sfd.ShowDialog() != DialogResult.OK) return;

            try
            {
                File.WriteAllText(sfd.FileName, BuildDocumentationText(), Encoding.UTF8);
                _lblStatus.Text = $"Status: Documentation exported -> {sfd.FileName}";
            }
            catch (Exception ex) { MessageBox.Show(ex.Message, "Export Documentation Error"); }
        }

        // =========================
        // helper: select a cell in grid
        // =========================
        private static void SelectCell(DataGridView grid, int rowIndex, int colIndex)
        {
            if (rowIndex < 0 || rowIndex >= grid.Rows.Count) return;
            if (colIndex < 0 || colIndex >= grid.Columns.Count) return;

            grid.ClearSelection();
            grid.CurrentCell = grid.Rows[rowIndex].Cells[colIndex];
            grid.Rows[rowIndex].Cells[colIndex].Selected = true;

            try { grid.FirstDisplayedScrollingRowIndex = Math.Max(0, rowIndex - 3); } catch { }
        }

        // =========================
        // Popup Window Helper
        // =========================
        private void ShowBigPopup(string text, string title)
        {
            var f = new Form
            {
                Text = title,
                Width = 900,
                Height = 650,
                StartPosition = FormStartPosition.CenterParent
            };

            var box = new TextBox
            {
                Multiline = true,
                ReadOnly = true,
                ScrollBars = ScrollBars.Both,
                Dock = DockStyle.Fill,
                Font = new Font("Segoe UI", 10),
                Text = text
            };

            var btn = new Button
            {
                Text = "Close",
                Dock = DockStyle.Bottom,
                Height = 40
            };
            btn.Click += (_, __) => f.Close();

            f.Controls.Add(box);
            f.Controls.Add(btn);
            f.ShowDialog(this);
        }

        // =========================
        // UI helpers
        // =========================
        private static DataGridView MakeEditableGrid()
        {
            return new DataGridView
            {
                Dock = DockStyle.Fill,
                AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.DisplayedCells,
                AllowUserToAddRows = true,
                AllowUserToDeleteRows = true
            };
        }

        private static DataGridView MakeReadOnlyGrid()
        {
            return new DataGridView
            {
                Dock = DockStyle.Fill,
                AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.DisplayedCells,
                ReadOnly = true,
                SelectionMode = DataGridViewSelectionMode.CellSelect,
                MultiSelect = false,
                AllowUserToOrderColumns = true
            };
        }

        // =========================================================
        // EVERYTHING BELOW HERE IS YOUR ORIGINAL BUSINESS LOGIC
        // (Unchanged)
        // =========================================================

        // =========================
        // DB setup
        // =========================
        private void EnsureDatabase()
        {
            using var conn = new SqliteConnection($"Data Source={_dbPath}");
            conn.Open();

            using var cmd = conn.CreateCommand();
            cmd.CommandText =
            @"
            CREATE TABLE IF NOT EXISTS Ingredients (
                Id INTEGER PRIMARY KEY AUTOINCREMENT,
                Name TEXT NOT NULL UNIQUE,
                Normalized TEXT NOT NULL
            );

            CREATE TABLE IF NOT EXISTS Synonyms (
                Id INTEGER PRIMARY KEY AUTOINCREMENT,
                Pattern TEXT NOT NULL UNIQUE,
                NormalizedPattern TEXT NOT NULL,
                MapsToIngredient TEXT NOT NULL,
                NormalizedMapsTo TEXT NOT NULL,
                Source TEXT NOT NULL DEFAULT 'manual',
                CreatedAt TEXT NOT NULL DEFAULT (datetime('now'))
            );

            CREATE TABLE IF NOT EXISTS Runs (
                Id INTEGER PRIMARY KEY AUTOINCREMENT,
                RunAt TEXT NOT NULL DEFAULT (datetime('now')),
                RowCount INTEGER NOT NULL,
                UnknownCount INTEGER NOT NULL
            );
            ";
            cmd.ExecuteNonQuery();
        }

        private void LogRun(int rowCount, int unknownCount)
        {
            using var conn = new SqliteConnection($"Data Source={_dbPath}");
            conn.Open();
            using var cmd = conn.CreateCommand();
            cmd.CommandText = "INSERT INTO Runs (RowCount, UnknownCount) VALUES ($r, $u);";
            cmd.Parameters.AddWithValue("$r", rowCount);
            cmd.Parameters.AddWithValue("$u", unknownCount);
            cmd.ExecuteNonQuery();
        }

        // =========================
        // Library: Load / Save / Import
        // =========================
        private void LoadLibraryFromDb()
        {
            _libraryTable = new DataTable();
            _libraryTable.Columns.Add("Name", typeof(string));

            _ingredientSet = new HashSet<string>(StringComparer.OrdinalIgnoreCase);

            using var conn = new SqliteConnection($"Data Source={_dbPath}");
            conn.Open();

            using var cmd = conn.CreateCommand();
            cmd.CommandText = "SELECT Name FROM Ingredients ORDER BY Name;";
            using var reader = cmd.ExecuteReader();

            while (reader.Read())
            {
                var name = reader.GetString(0);
                _libraryTable.Rows.Add(name);

                var norm = NormalizeIngredient(name);
                if (!string.IsNullOrWhiteSpace(norm))
                    _ingredientSet.Add(norm);
            }
        }

        private void SaveIngredientsToDb(DataTable table)
        {
            var names = table.Rows
                .Cast<DataRow>()
                .Select(r => (r["Name"]?.ToString() ?? "").Trim())
                .Where(n => !string.IsNullOrWhiteSpace(n))
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .ToList();

            using var conn = new SqliteConnection($"Data Source={_dbPath}");
            conn.Open();
            using var tx = conn.BeginTransaction();

            using (var del = conn.CreateCommand())
            {
                del.CommandText = "DELETE FROM Ingredients;";
                del.ExecuteNonQuery();
            }

            foreach (var name in names)
            {
                var norm = NormalizeIngredient(name);
                if (string.IsNullOrWhiteSpace(norm)) continue;

                using var ins = conn.CreateCommand();
                ins.CommandText = "INSERT INTO Ingredients (Name, Normalized) VALUES ($n, $nn);";
                ins.Parameters.AddWithValue("$n", name);
                ins.Parameters.AddWithValue("$nn", norm);
                ins.ExecuteNonQuery();
            }

            tx.Commit();
        }

        private int ImportIngredientsFromExcel(string path)
        {
            using var wb = new XLWorkbook(path);
            var ws = wb.Worksheets.First();
            var range = ws.RangeUsed();
            if (range == null) throw new Exception("The ingredient library Excel is empty.");

            var headerRow = range.FirstRowUsed();
            var headers = headerRow.CellsUsed().Select(c => c.GetString().Trim().ToLowerInvariant()).ToList();

            int nameIndex = headers.FindIndex(h => h == "ingredient_name" || h == "name" || h == "ingredient");
            if (nameIndex < 0) throw new Exception("Library Excel must have a header column: ingredient_name (or name/ingredient).");

            int added = 0;

            using var conn = new SqliteConnection($"Data Source={_dbPath}");
            conn.Open();
            using var tx = conn.BeginTransaction();

            var firstDataRowNumber = headerRow.RowNumber() + 1;
            var lastRowNumber = range.LastRowUsed().RowNumber();

            for (int r = firstDataRowNumber; r <= lastRowNumber; r++)
            {
                var name = ws.Row(r).Cell(nameIndex + 1).GetValue<string>()?.Trim();
                if (string.IsNullOrWhiteSpace(name)) continue;

                var norm = NormalizeIngredient(name);
                if (string.IsNullOrWhiteSpace(norm)) continue;

                using var cmd = conn.CreateCommand();
                cmd.CommandText = "INSERT OR IGNORE INTO Ingredients (Name, Normalized) VALUES ($n, $nn);";
                cmd.Parameters.AddWithValue("$n", name);
                cmd.Parameters.AddWithValue("$nn", norm);

                var before = GetChangesCount(conn);
                cmd.ExecuteNonQuery();
                var after = GetChangesCount(conn);

                if (after > before) added++;
            }

            tx.Commit();
            return added;
        }

        // =========================
        // Synonyms: Load / Save / Import
        // =========================
        private void LoadSynonymsFromDb()
        {
            _synonymsTable = new DataTable();
            _synonymsTable.Columns.Add("Pattern", typeof(string));
            _synonymsTable.Columns.Add("MapsToIngredient", typeof(string));
            _synonymsTable.Columns.Add("Source", typeof(string));

            _synonymMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);

            using var conn = new SqliteConnection($"Data Source={_dbPath}");
            conn.Open();

            using var cmd = conn.CreateCommand();
            cmd.CommandText = "SELECT Pattern, MapsToIngredient, Source FROM Synonyms ORDER BY Pattern;";
            using var reader = cmd.ExecuteReader();

            while (reader.Read())
            {
                var pattern = reader.GetString(0);
                var mapsTo = reader.GetString(1);
                var source = reader.GetString(2);

                _synonymsTable.Rows.Add(pattern, mapsTo, source);

                var normPattern = NormalizeIngredient(pattern);
                var normMapsTo = NormalizeIngredient(mapsTo);

                if (!string.IsNullOrWhiteSpace(normPattern) && !string.IsNullOrWhiteSpace(normMapsTo))
                    _synonymMap[normPattern] = normMapsTo;
            }
        }

        private void SaveSynonymsToDb(DataTable table)
        {
            var rows = table.Rows
                .Cast<DataRow>()
                .Select(r => new
                {
                    Pattern = (r["Pattern"]?.ToString() ?? "").Trim(),
                    MapsTo = (r["MapsToIngredient"]?.ToString() ?? "").Trim(),
                    Source = (r.Table.Columns.Contains("Source") ? (r["Source"]?.ToString() ?? "manual").Trim() : "manual")
                })
                .Where(x => !string.IsNullOrWhiteSpace(x.Pattern) && !string.IsNullOrWhiteSpace(x.MapsTo))
                .ToList();

            using var conn = new SqliteConnection($"Data Source={_dbPath}");
            conn.Open();
            using var tx = conn.BeginTransaction();

            using (var del = conn.CreateCommand())
            {
                del.CommandText = "DELETE FROM Synonyms;";
                del.ExecuteNonQuery();
            }

            foreach (var row in rows)
            {
                var normPattern = NormalizeIngredient(row.Pattern);
                var normMapsTo = NormalizeIngredient(row.MapsTo);

                if (string.IsNullOrWhiteSpace(normPattern) || string.IsNullOrWhiteSpace(normMapsTo)) continue;

                using var ins = conn.CreateCommand();
                ins.CommandText =
                    "INSERT INTO Synonyms (Pattern, NormalizedPattern, MapsToIngredient, NormalizedMapsTo, Source) " +
                    "VALUES ($p, $np, $m, $nm, $s);";
                ins.Parameters.AddWithValue("$p", row.Pattern);
                ins.Parameters.AddWithValue("$np", normPattern);
                ins.Parameters.AddWithValue("$m", row.MapsTo);
                ins.Parameters.AddWithValue("$nm", normMapsTo);
                ins.Parameters.AddWithValue("$s", string.IsNullOrWhiteSpace(row.Source) ? "manual" : row.Source);

                ins.ExecuteNonQuery();
            }

            tx.Commit();
        }

        private int ImportSynonymsFromExcel(string path)
        {
            using var wb = new XLWorkbook(path);
            var ws = wb.Worksheets.First();
            var range = ws.RangeUsed();
            if (range == null) throw new Exception("Synonyms Excel is empty.");

            var headerRow = range.FirstRowUsed();
            var headers = headerRow.CellsUsed().Select(c => c.GetString().Trim().ToLowerInvariant()).ToList();

            int patternIndex = headers.FindIndex(h => h == "pattern" || h == "synonym" || h == "alias");
            int mapsToIndex = headers.FindIndex(h => h == "mapstoingredient" || h == "mapsto" || h == "ingredient" || h == "target");
            int sourceIndex = headers.FindIndex(h => h == "source");

            if (patternIndex < 0 || mapsToIndex < 0)
                throw new Exception("Synonyms Excel must have columns: Pattern and MapsToIngredient.");

            int added = 0;

            using var conn = new SqliteConnection($"Data Source={_dbPath}");
            conn.Open();
            using var tx = conn.BeginTransaction();

            var firstDataRowNumber = headerRow.RowNumber() + 1;
            var lastRowNumber = range.LastRowUsed().RowNumber();

            for (int r = firstDataRowNumber; r <= lastRowNumber; r++)
            {
                var pattern = ws.Row(r).Cell(patternIndex + 1).GetValue<string>()?.Trim();
                var mapsTo = ws.Row(r).Cell(mapsToIndex + 1).GetValue<string>()?.Trim();
                var source = sourceIndex >= 0 ? ws.Row(r).Cell(sourceIndex + 1).GetValue<string>()?.Trim() : "import";

                if (string.IsNullOrWhiteSpace(pattern) || string.IsNullOrWhiteSpace(mapsTo)) continue;

                var normPattern = NormalizeIngredient(pattern);
                var normMapsTo = NormalizeIngredient(mapsTo);
                if (string.IsNullOrWhiteSpace(normPattern) || string.IsNullOrWhiteSpace(normMapsTo)) continue;

                using var cmd = conn.CreateCommand();
                cmd.CommandText =
                    "INSERT OR IGNORE INTO Synonyms (Pattern, NormalizedPattern, MapsToIngredient, NormalizedMapsTo, Source) " +
                    "VALUES ($p, $np, $m, $nm, $s);";
                cmd.Parameters.AddWithValue("$p", pattern);
                cmd.Parameters.AddWithValue("$np", normPattern);
                cmd.Parameters.AddWithValue("$m", mapsTo);
                cmd.Parameters.AddWithValue("$nm", normMapsTo);
                cmd.Parameters.AddWithValue("$s", string.IsNullOrWhiteSpace(source) ? "import" : source);

                var before = GetChangesCount(conn);
                cmd.ExecuteNonQuery();
                var after = GetChangesCount(conn);

                if (after > before) added++;
            }

            tx.Commit();
            return added;
        }

        private static long GetChangesCount(SqliteConnection conn)
        {
            using var cmd = conn.CreateCommand();
            cmd.CommandText = "SELECT changes();";
            return (long)cmd.ExecuteScalar();
        }

        // =========================
        // Standardization Rules Engine
        // =========================
        private struct ExtractResult
        {
            public string PrimaryIngredient;
            public string AllIngredients;
            public string RuleApplied;
            public string CleanedForMatching;
            public bool IsUnknown;
            public string SuggestedIngredient;
        }

        private static ExtractResult ExtractWithRules(string genericName, HashSet<string> ingredientSet, Dictionary<string, string> synonymMap)
        {
            var result = new ExtractResult
            {
                PrimaryIngredient = "",
                AllIngredients = "",
                RuleApplied = "",
                CleanedForMatching = "",
                IsUnknown = false,
                SuggestedIngredient = ""
            };

            if (string.IsNullOrWhiteSpace(genericName))
            {
                result.PrimaryIngredient = "NON_DRUG";
                result.RuleApplied = "EMPTY";
                return result;
            }

            var cleaned = CleanGenericForMatching(genericName);
            result.CleanedForMatching = cleaned;

            if (string.IsNullOrWhiteSpace(cleaned))
            {
                result.PrimaryIngredient = "NON_DRUG";
                result.RuleApplied = "NON_DRUG_AFTER_CLEAN";
                return result;
            }

            var parts = SplitComboParts(genericName);
            if (parts.Count >= 2)
            {
                var ingredients = new List<string>();
                var rules = new List<string>();

                foreach (var p in parts)
                {
                    var c = CleanGenericForMatching(p);
                    if (string.IsNullOrWhiteSpace(c)) continue;

                    var synHit = LongestMatch(c, synonymMap.Keys);
                    if (!string.IsNullOrWhiteSpace(synHit))
                    {
                        var mapped = synonymMap[synHit];
                        ingredients.Add(mapped);
                        rules.Add($"SYNONYM({synHit}->{mapped})");
                        continue;
                    }

                    var ingHit = LongestMatch(c, ingredientSet);
                    if (!string.IsNullOrWhiteSpace(ingHit))
                    {
                        ingredients.Add(ingHit);
                        rules.Add("DICT");
                        continue;
                    }

                    if (c.Contains("insulin"))
                    {
                        ingredients.Add("insulin");
                        rules.Add("INSULIN_FALLBACK");
                        continue;
                    }
                }

                ingredients = ingredients
                    .Where(x => !string.IsNullOrWhiteSpace(x))
                    .Distinct(StringComparer.OrdinalIgnoreCase)
                    .ToList();

                if (ingredients.Count > 0)
                {
                    result.PrimaryIngredient = ingredients[0];
                    result.AllIngredients = string.Join("|", ingredients);
                    result.RuleApplied = "COMBO:" + string.Join(",", rules.Distinct());
                    return result;
                }

                result.RuleApplied = "COMBO_NO_MATCH";
                result.IsUnknown = true;
                result.SuggestedIngredient = SuggestIngredient(cleaned, ingredientSet);
                return result;
            }

            var syn = LongestMatch(cleaned, synonymMap.Keys);
            if (!string.IsNullOrWhiteSpace(syn))
            {
                var mapped = synonymMap[syn];
                result.PrimaryIngredient = mapped;
                result.AllIngredients = mapped;
                result.RuleApplied = $"SYNONYM({syn}->{mapped})";
                return result;
            }

            var ing = LongestMatch(cleaned, ingredientSet);
            if (!string.IsNullOrWhiteSpace(ing))
            {
                result.PrimaryIngredient = ing;
                result.AllIngredients = ing;
                result.RuleApplied = "DICT_LONGEST_MATCH";
                return result;
            }

            if (cleaned.Contains("insulin"))
            {
                result.PrimaryIngredient = "insulin";
                result.AllIngredients = "insulin";
                result.RuleApplied = "INSULIN_FALLBACK";
                return result;
            }

            if (!ContainsDrugLikeToken(cleaned))
            {
                result.PrimaryIngredient = "NON_DRUG";
                result.RuleApplied = "NON_DRUG_HEURISTIC";
                return result;
            }

            result.RuleApplied = "UNKNOWN_NO_MATCH";
            result.IsUnknown = true;
            result.SuggestedIngredient = SuggestIngredient(cleaned, ingredientSet);
            return result;
        }

        private static bool ContainsDrugLikeToken(string cleaned)
        {
            var tokens = cleaned.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            if (tokens.Any(t => t.Length >= 8)) return true;

            string[] suffixes =
            {
                "cillin","mycin","cycline","prazole","pril","sartan","olol","dipine","statin",
                "azole","vir","mab","nib","tide","caine","parin","dronate","gliptin","gliflozin"
            };
            return tokens.Any(t => suffixes.Any(s => t.EndsWith(s)));
        }

        private static List<string> SplitComboParts(string raw)
        {
            var s = raw.ToLowerInvariant();
            if (!s.Contains("/") && !s.Contains("+") && !s.Contains(" and "))
                return new List<string> { raw };

            var parts = Regex.Split(raw, @"\s*(\/|\+|\band\b)\s*", RegexOptions.IgnoreCase)
                .Select(p => p.Trim())
                .Where(p => !string.IsNullOrWhiteSpace(p))
                .ToList();

            parts = parts.Where(p =>
                p != "/" && p != "+" && !string.Equals(p, "and", StringComparison.OrdinalIgnoreCase)).ToList();

            return parts.Count == 0 ? new List<string> { raw } : parts;
        }

        private static string LongestMatch(string cleaned, IEnumerable<string> candidates)
        {
            var tokens = cleaned.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            if (tokens.Length == 0) return "";

            int maxGram = Math.Min(6, tokens.Length);

            HashSet<string>? set = candidates as HashSet<string>;
            set ??= new HashSet<string>(candidates, StringComparer.OrdinalIgnoreCase);

            for (int n = maxGram; n >= 1; n--)
            {
                for (int i = 0; i <= tokens.Length - n; i++)
                {
                    var phrase = string.Join(" ", tokens.Skip(i).Take(n));
                    if (set.Contains(phrase))
                        return phrase;
                }
            }
            return "";
        }

        private static string SuggestIngredient(string cleaned, HashSet<string> ingredientSet)
        {
            var tokens = cleaned.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            if (tokens.Length == 0) return "";

            foreach (var t in tokens)
                if (ingredientSet.Contains(t)) return t;

            var prefixes = tokens
                .Where(t => t.Length >= 6)
                .Select(t => t.Substring(0, 6))
                .Distinct()
                .ToList();

            string best = "";
            foreach (var ing in ingredientSet)
            {
                foreach (var p in prefixes)
                {
                    if (ing.StartsWith(p) && ing.Length > best.Length)
                        best = ing;
                }
            }
            return best;
        }

        private static string CleanGenericForMatching(string input)
        {
            var s = input.Trim().ToLowerInvariant();

            s = s.Replace("/", " ")
                 .Replace(",", " ")
                 .Replace(";", " ")
                 .Replace("(", " ")
                 .Replace(")", " ")
                 .Replace("-", " ");

            s = Regex.Replace(s, @"\bu\s*[-]?\s*\d+\b", " ");

            s = Regex.Replace(s, @"\b\d+(\.\d+)?\s*(mg|mcg|g|gram|grams|ml|mL|l|meq|units|iu|%)\b", " ");
            s = Regex.Replace(s, @"\b\d+(\.\d+)?\s*(mg\/ml|mg\/mL|mcg\/ml|g\/l|mg\/g)\b", " ");

            foreach (var w in StopWords)
                s = Regex.Replace(s, $@"\b{Regex.Escape(w)}\b", " ");

            foreach (var w in SaltWords)
                s = Regex.Replace(s, $@"\b{Regex.Escape(w)}\b", " ");

            s = Regex.Replace(s, @"\s+", " ").Trim();
            return s;
        }

        private static string NormalizeIngredient(string name)
        {
            var s = name.Trim().ToLowerInvariant();
            s = s.Replace("/", " ").Replace("-", " ");
            s = Regex.Replace(s, @"\s+", " ").Trim();
            return s;
        }

        private static readonly string[] StopWords =
        {
            "vial","vials","syringe","syringes","needle","needles","bag","bags","premix",
            "cartridge","cartridges","label","labels","printer","toner","thermometer","thermometers",
            "kit","kits","cap","caps","luer","female","male","tackle","box","various","dram","drams",
            "tablet","tablets","tab","capsule","capsules","solution","suspension","syrup","injection","inj","iv",
            "oral","topical","cream","ointment","gel","patch","spray","drops","ophthalmic","otic","nasal",
            "extended","release","er","xr","sr","dr","immediate","ir","concentrate","prefilled","pen",
            "for","use","single","dose","multi","dose","pre","filled"
        };

        private static readonly string[] SaltWords =
        {
            "hydrochloride","hcl","sodium","potassium","calcium","magnesium",
            "phosphate","acetate","succinate","tartrate","citrate","mesylate",
            "besylate","tosylate","fumarate","maleate","sulfate","nitrate"
        };

        private void BuildUnknownsTableSchema()
        {
            _unknownsTable = new DataTable();
            _unknownsTable.Columns.Add("OriginalGenericName", typeof(string));
            _unknownsTable.Columns.Add("CleanedForMatching", typeof(string));
            _unknownsTable.Columns.Add("SuggestedIngredient", typeof(string));
            _unknownsTable.Columns.Add("ApprovedIngredient", typeof(string));
            _unknownsTable.Columns.Add("SuggestedPattern", typeof(string));
        }

        private void AddUnknownRow(string original, string cleaned, string suggested)
        {
            _unknownsTable.Rows.Add(original, cleaned, suggested, "", cleaned);
        }

        private static DataTable BuildVariabilityReport(DataTable input)
        {
            var dt = new DataTable();
            dt.Columns.Add("PrimaryIngredient", typeof(string));
            dt.Columns.Add("RowCount", typeof(int));
            dt.Columns.Add("UniqueGenericNames", typeof(int));
            dt.Columns.Add("ExampleVariants", typeof(string));

            var genericCol = FindColumn(input, "generic_name");
            var primaryCol = FindColumn(input, "PrimaryIngredient");

            if (genericCol == null || primaryCol == null) return dt;

            var groups = input.Rows.Cast<DataRow>()
                .GroupBy(r => (r[primaryCol]?.ToString() ?? "").Trim())
                .OrderByDescending(g => g.Count());

            foreach (var g in groups)
            {
                var ingredient = g.Key;
                if (string.IsNullOrWhiteSpace(ingredient)) ingredient = "(blank)";
                if (ingredient.Equals("NON_DRUG", StringComparison.OrdinalIgnoreCase)) continue;

                var variants = g
                    .Select(r => (r[genericCol]?.ToString() ?? "").Trim())
                    .Where(x => !string.IsNullOrWhiteSpace(x))
                    .Distinct(StringComparer.OrdinalIgnoreCase)
                    .ToList();

                dt.Rows.Add(ingredient, g.Count(), variants.Count, string.Join(" | ", variants.Take(10)));
            }

            return dt;
        }

        private static DataTable BuildValidationExamples(DataTable input, int topIngredients, int examplesPerIngredient)
        {
            var dt = new DataTable();
            dt.Columns.Add("PrimaryIngredient", typeof(string));
            dt.Columns.Add("GenericNameExample", typeof(string));
            dt.Columns.Add("StandardizedPrimaryIngredient", typeof(string));
            dt.Columns.Add("AllIngredients", typeof(string));
            dt.Columns.Add("RuleApplied", typeof(string));

            var genericCol = FindColumn(input, "generic_name");
            var primaryCol = FindColumn(input, "PrimaryIngredient");
            var allCol = FindColumn(input, "AllIngredients");
            var ruleCol = FindColumn(input, "RuleApplied");

            if (genericCol == null || primaryCol == null) return dt;

            var groups = input.Rows.Cast<DataRow>()
                .Where(r => !string.Equals((r[primaryCol]?.ToString() ?? ""), "NON_DRUG", StringComparison.OrdinalIgnoreCase))
                .GroupBy(r => (r[primaryCol]?.ToString() ?? "").Trim())
                .Select(g => new
                {
                    Ingredient = g.Key,
                    RowCount = g.Count(),
                    UniqueVariants = g.Select(r => (r[genericCol]?.ToString() ?? "").Trim())
                                      .Where(x => !string.IsNullOrWhiteSpace(x))
                                      .Distinct(StringComparer.OrdinalIgnoreCase)
                                      .Count(),
                    Rows = g.ToList()
                })
                .OrderByDescending(x => x.UniqueVariants)
                .ThenByDescending(x => x.RowCount)
                .Take(topIngredients)
                .ToList();

            foreach (var g in groups)
            {
                var sample = g.Rows
                    .Select(r => new
                    {
                        Generic = (r[genericCol]?.ToString() ?? "").Trim(),
                        Primary = (r[primaryCol]?.ToString() ?? "").Trim(),
                        All = allCol == null ? "" : (r[allCol]?.ToString() ?? "").Trim(),
                        Rule = ruleCol == null ? "" : (r[ruleCol]?.ToString() ?? "").Trim()
                    })
                    .Where(x => !string.IsNullOrWhiteSpace(x.Generic))
                    .GroupBy(x => x.Generic, StringComparer.OrdinalIgnoreCase)
                    .Select(grp => grp.First())
                    .Take(examplesPerIngredient)
                    .ToList();

                foreach (var ex in sample)
                    dt.Rows.Add(g.Ingredient, ex.Generic, ex.Primary, ex.All, ex.Rule);
            }

            return dt;
        }

        private string BuildDocumentationText()
        {
            var sb = new StringBuilder();

            sb.AppendLine("Project: Standardizing Generic Drug Names to Identify Primary Active Ingredient");
            sb.AppendLine("Generated by: DrugNameStandardizer (WinForms + SQLite + ClosedXML)");
            sb.AppendLine($"Generated on: {DateTime.Now}");
            sb.AppendLine();

            sb.AppendLine("Approach Summary");
            sb.AppendLine("- Input: Excel sheet with 'generic_name'.");
            sb.AppendLine("- Output: PrimaryIngredient, AllIngredients, RuleApplied, NormalizedGeneric.");
            sb.AppendLine("- Method: normalization (remove packaging/strength/salts) + synonym mapping + longest n-gram match to Ingredient Library.");
            sb.AppendLine("- Combo products: split on '/', '+', 'and'; AllIngredients keeps all; PrimaryIngredient is first.");
            sb.AppendLine("- Unknown capture: saved into Unknowns tab with suggestion.");
            sb.AppendLine();

            sb.AppendLine("Validation/Reporting");
            sb.AppendLine("- Variability report: ingredient frequency and # unique variants.");
            sb.AppendLine("- Validation examples: before/after examples for high-variability ingredients.");
            sb.AppendLine();

            sb.AppendLine("Usability");
            sb.AppendLine("- Click PrimaryIngredient cell => popup with count + unique generic_name forms (no duplicates).");
            sb.AppendLine("- Right-click a column header in preview => Delete Column (generic_name protected).");
            sb.AppendLine("- Choose Output Columns => export only what user wants.");

            sb.AppendLine();
            sb.AppendLine("Added Tools");
            sb.AppendLine("- Cost-Savings Opportunity Finder (adds pricing spread columns + Top 25).");
            sb.AppendLine("- Therapeutic Category Spend Trends (pivot Sum WAC by ETC_Lowest_lvl).");

            return sb.ToString();
        }

        private static void EnsureOutputColumns(DataTable dt)
        {
            EnsureCol(dt, "PrimaryIngredient", typeof(string));
            EnsureCol(dt, "AllIngredients", typeof(string));
            EnsureCol(dt, "RuleApplied", typeof(string));
            EnsureCol(dt, "NormalizedGeneric", typeof(string));
        }

        private static void EnsureCol(DataTable dt, string name, Type t)
        {
            if (dt.Columns.Cast<DataColumn>().All(c => c.ColumnName != name))
                dt.Columns.Add(name, t);
        }

        private static DataColumn? FindColumn(DataTable dt, string name)
        {
            return dt.Columns.Cast<DataColumn>()
                .FirstOrDefault(c => string.Equals(c.ColumnName, name, StringComparison.OrdinalIgnoreCase));
        }

        private static DataTable CreateFilteredTable(DataTable source, HashSet<string> keepCols)
        {
            var dt = new DataTable();

            foreach (DataColumn col in source.Columns)
            {
                if (keepCols.Contains(col.ColumnName))
                    dt.Columns.Add(col.ColumnName, col.DataType);
            }

            foreach (DataRow row in source.Rows)
            {
                var nr = dt.NewRow();
                foreach (DataColumn col in dt.Columns)
                    nr[col.ColumnName] = row[col.ColumnName];
                dt.Rows.Add(nr);
            }

            return dt;
        }

        private static DataTable LoadFirstSheetToDataTable(string path)
        {
            using var wb = new XLWorkbook(path);
            var ws = wb.Worksheets.First();

            var range = ws.RangeUsed();
            if (range == null) throw new Exception("The first worksheet is empty.");

            var dt = new DataTable();

            var headerRow = range.FirstRowUsed();
            var headerCells = headerRow.CellsUsed().ToList();

            foreach (var cell in headerCells)
            {
                var name = cell.GetString().Trim();
                if (string.IsNullOrWhiteSpace(name))
                    name = "Column" + cell.Address.ColumnNumber;

                var original = name;
                int k = 1;
                while (dt.Columns.Contains(name))
                {
                    name = $"{original}_{k}";
                    k++;
                }

                dt.Columns.Add(name);
            }

            var firstDataRowNumber = headerRow.RowNumber() + 1;
            var lastRowNumber = range.LastRowUsed().RowNumber();

            for (int r = firstDataRowNumber; r <= lastRowNumber; r++)
            {
                var excelRow = ws.Row(r);
                if (excelRow.Cells(1, dt.Columns.Count).All(c => c.IsEmpty()))
                    continue;

                var dr = dt.NewRow();
                for (int i = 0; i < dt.Columns.Count; i++)
                    dr[i] = excelRow.Cell(i + 1).GetValue<string>();

                dt.Rows.Add(dr);
            }

            return dt;
        }

        private static void SaveDataTableToExcel(DataTable dt, string path)
        {
            using var wb = new XLWorkbook();
            var ws = wb.Worksheets.Add("Output");

            for (int c = 0; c < dt.Columns.Count; c++)
                ws.Cell(1, c + 1).Value = dt.Columns[c].ColumnName;

            for (int r = 0; r < dt.Rows.Count; r++)
            {
                for (int c = 0; c < dt.Columns.Count; c++)
                    ws.Cell(r + 2, c + 1).Value = dt.Rows[r][c]?.ToString() ?? "";
            }

            ws.Columns().AdjustToContents();
            wb.SaveAs(path);
        }

        // Column picker dialog (unchanged)
        private class ColumnPickerDialog : Form
        {
            private readonly CheckedListBox _list = new CheckedListBox();
            private readonly Button _ok = new Button();
            private readonly Button _cancel = new Button();
            private readonly Button _selectAll = new Button();
            private readonly Button _selectNone = new Button();

            public HashSet<string> SelectedColumns { get; private set; }

            public ColumnPickerDialog(List<string> allColumns, HashSet<string> currentlySelected)
            {
                Text = "Choose Output Columns";
                Width = 520;
                Height = 520;
                StartPosition = FormStartPosition.CenterParent;

                _list.Left = 15;
                _list.Top = 15;
                _list.Width = 470;
                _list.Height = 380;
                _list.CheckOnClick = true;

                foreach (var c in allColumns)
                {
                    bool isChecked = currentlySelected.Contains(c);
                    _list.Items.Add(c, isChecked);
                }

                _selectAll.Text = "Select All";
                _selectAll.Left = 15; _selectAll.Top = 405; _selectAll.Width = 110; _selectAll.Height = 30;

                _selectNone.Text = "Select None";
                _selectNone.Left = 135; _selectNone.Top = 405; _selectNone.Width = 110; _selectNone.Height = 30;

                _ok.Text = "OK";
                _ok.Left = 295; _ok.Top = 405; _ok.Width = 90; _ok.Height = 30;

                _cancel.Text = "Cancel";
                _cancel.Left = 395; _cancel.Top = 405; _cancel.Width = 90; _cancel.Height = 30;

                _selectAll.Click += (_, __) =>
                {
                    for (int i = 0; i < _list.Items.Count; i++)
                        _list.SetItemChecked(i, true);
                };

                _selectNone.Click += (_, __) =>
                {
                    for (int i = 0; i < _list.Items.Count; i++)
                        _list.SetItemChecked(i, false);
                };

                _ok.Click += (_, __) =>
                {
                    var selected = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
                    foreach (var item in _list.CheckedItems)
                        selected.Add(item.ToString() ?? "");

                    if (selected.Count == 0)
                    {
                        MessageBox.Show("Please select at least one column.");
                        return;
                    }

                    SelectedColumns = selected;
                    DialogResult = DialogResult.OK;
                    Close();
                };

                _cancel.Click += (_, __) =>
                {
                    DialogResult = DialogResult.Cancel;
                    Close();
                };

                Controls.Add(_list);
                Controls.Add(_selectAll);
                Controls.Add(_selectNone);
                Controls.Add(_ok);
                Controls.Add(_cancel);

                SelectedColumns = new HashSet<string>(currentlySelected, StringComparer.OrdinalIgnoreCase);
            }
        }

        // TOOL 1 + TOOL 2 + helpers (UNCHANGED from your code)
        // --- keep your exact implementations here ---
        // RunCostSavingsOpportunityFinder(...)
        // RunTherapeuticSpendTrends(...)
        // ParseMoney(...)
        // StdDev(...)
        // MinNullable(...)
        // MostCommon(...)

        // NOTE:
        // Paste your existing tool methods below exactly as you had them.
        // (They were already correct other than your earlier comma error.)

        // ---------------------------------------------------------
        // !!! PASTE YOUR TWO TOOL METHODS + HELPERS HERE !!!
        // ---------------------------------------------------------

        private void RunCostSavingsOpportunityFinder(DataTable input, DataGridView outputGrid)
        {
            // (same as your original) ...
            throw new NotImplementedException("Paste your original RunCostSavingsOpportunityFinder here.");
        }

        private void RunTherapeuticSpendTrends(DataTable input, DataGridView outputGrid)
        {
            // (same as your original) ...
            throw new NotImplementedException("Paste your original RunTherapeuticSpendTrends here.");
        }

        private static double? ParseMoney(object? val) => throw new NotImplementedException();
        private static double StdDev(List<double> values) => throw new NotImplementedException();
        private static double? MinNullable(params double?[] vals) => throw new NotImplementedException();
        private static string MostCommon(IEnumerable<string> vals) => throw new NotImplementedException();
    }
}