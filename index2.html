using System;
using System.Collections.Generic;
using System.Data;
using System.Drawing;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Windows.Forms;
using ClosedXML.Excel;
using Microsoft.Data.Sqlite;

namespace DrugNameStandardizer
{
    public partial class Form1 : Form
    {
        // =========================
        // State
        // =========================
        private DataTable? _inputTable;

        private DataTable _libraryTable = new DataTable();
        private DataTable _synonymsTable = new DataTable();
        private DataTable _unknownsTable = new DataTable();
        private DataTable _variabilityTable = new DataTable();
        private DataTable _validationTable = new DataTable();

        // tool outputs
        private DataTable _costSavingsTop25Table = new DataTable();
        private DataTable _spendTrendsTable = new DataTable();

        private HashSet<string> _ingredientSet = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        private Dictionary<string, string> _synonymMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);

        // Export column selection
        private HashSet<string>? _selectedOutputColumns = null;

        private readonly string _dbPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "ingredient_library.db");

        // =========================
        // UI fields
        // =========================

        // ONLY visible buttons on main form:
        private Button _btnUploadInput = null!;
        private Button _btnRun = null!;

        // Hidden legacy buttons (logic stays identical; ribbon calls PerformClick())
        private Button _btnLoadLibrary = null!;
        private Button _btnImportLibrary = null!;
        private Button _btnSaveLibrary = null!;
        private Button _btnLoadSynonyms = null!;
        private Button _btnImportSynonyms = null!;
        private Button _btnSaveSynonyms = null!;
        private Button _btnAnalyzeVariability = null!;
        private Button _btnGenerateValidation = null!;
        private Button _btnExportDocs = null!;
        private Button _btnExportUnknowns = null!;
        private Button _btnExportVariability = null!;
        private Button _btnExportValidation = null!;
        private Button _btnChooseColumns = null!;
        private Button _btnSaveOutput = null!;

        // MUST KEEP as-is: search ribbon ToolStrip
        private ToolStrip _searchRibbon = null!;
        private ToolStripTextBox _txtSearch = null!;
        private ToolStripButton _btnPrevSearch = null!;
        private ToolStripButton _btnNextSearch = null!;

        // MUST KEEP: tools ToolStrip concept
        private ToolStrip _toolsRibbon = null!;
        private ToolStripDropDownButton _ddTools = null!;

        private Label _lblStatus = null!;

        // Main content tabs + pages + grids
        private TabControl _tabs = null!;
        private TabPage _tabLibrary = null!;
        private TabPage _tabSynonyms = null!;
        private TabPage _tabInput = null!;
        private TabPage _tabUnknowns = null!;
        private TabPage _tabVariability = null!;
        private TabPage _tabValidation = null!;
        private TabPage _tabCostSavings = null!;
        private TabPage _tabSpendTrends = null!;

        private DataGridView _libraryGrid = null!;
        private DataGridView _synonymsGrid = null!;
        private DataGridView _inputGrid = null!;
        private DataGridView _unknownsGrid = null!;
        private DataGridView _variabilityGrid = null!;
        private DataGridView _validationGrid = null!;
        private DataGridView _costSavingsGrid = null!;
        private DataGridView _spendTrendsGrid = null!;

        // Office-style Ribbon (built-in controls)
        private TabControl _ribbonTabs = null!;

        // Ribbon items to mirror enabled state
        private ToolStripItem _rLoadLibrary = null!;
        private ToolStripItem _rImportLibrary = null!;
        private ToolStripItem _rSaveLibrary = null!;
        private ToolStripItem _rLoadSynonyms = null!;
        private ToolStripItem _rImportSynonyms = null!;
        private ToolStripItem _rSaveSynonyms = null!;

        private ToolStripItem _rAnalyzeVariability = null!;
        private ToolStripItem _rGenerateValidation = null!;
        private ToolStripItem _rExportDocs = null!;
        private ToolStripItem _rExportUnknowns = null!;
        private ToolStripItem _rExportVariability = null!;
        private ToolStripItem _rExportValidation = null!;
        private ToolStripItem _rChooseColumns = null!;
        private ToolStripItem _rSaveOutput = null!;

        private ToolStripItem _rToolCostSavings = null!;
        private ToolStripItem _rToolSpendTrends = null!;

        // Font group controls (apply to grid data)
        private ToolStripComboBox _rFontFamily = null!;
        private ToolStripComboBox _rFontSize = null!;
        private ToolStripButton _rBold = null!;
        private ToolStripButton _rItalic = null!;
        private ToolStripButton _rUnderline = null!;
        private ToolStripDropDownButton _rTextColor = null!;
        private ToolStripDropDownButton _rHighlight = null!;

        private Color? _gridForeColor = null;
        private Color? _gridBackColor = null;

        // =========================
        // Constructor
        // =========================
        public Form1()
        {
            InitializeComponent();
            Controls.Clear();

            Width = 1380;
            Height = 840;
            Text = "Generic Name Standardizer — Primary Ingredient (Library + Synonyms + Reports)";
            KeyPreview = true;

            BuildUiShell();
            BuildOfficeRibbon();
            BuildSearchAndToolsRibbons_ExactlyAsIs();
            BuildMainTabsAndGrids();

            // Ensure DB exists + initial load
            EnsureDatabase();

            LoadLibraryFromDb();
            LoadSynonymsFromDb();
            _libraryGrid.DataSource = _libraryTable;
            _synonymsGrid.DataSource = _synonymsTable;

            WireLegacyButtonActions_OriginalLogicUnchanged();

            // Right-click header delete column (Preview) - original behavior
            BuildInputGridDeleteColumnFeature();

            // Click PrimaryIngredient => popup summary (original behavior)
            BuildPrimaryIngredientPopupFeature();

            // Search logic (Ctrl+F + Next/Prev) - original behavior
            BuildSearchLogic_Original();

            // Tools dropdown (original behavior)
            BuildToolsDropdown_Original();

            // Keyboard shortcuts (new) — does NOT change Ctrl+F logic
            KeyDown += Form1_KeyDownShortcuts;

            // Initial enabled sync to ribbon
            SyncRibbonEnabledFromLegacyButtons();
        }

        // =========================
        // UI construction
        // =========================
        private void BuildUiShell()
        {
            // Visible buttons ONLY
            _btnUploadInput = new Button { Text = "Upload File", Left = 15, Top = 15, Width = 150, Height = 35 };
            _btnRun = new Button { Text = "Run", Left = 175, Top = 15, Width = 110, Height = 35, Enabled = false };

            // Keep RUN green (same as original style intent)
            _btnRun.UseVisualStyleBackColor = false;
            _btnRun.BackColor = Color.FromArgb(0, 170, 0);
            _btnRun.ForeColor = Color.White;
            _btnRun.FlatStyle = FlatStyle.Flat;
            _btnRun.FlatAppearance.BorderSize = 0;

            Controls.Add(_btnUploadInput);
            Controls.Add(_btnRun);

            // Status label (same placement as original)
            _lblStatus = new Label { Text = "Status: Ready", Left = 15, Top = 158, Width = 1320 };
            Controls.Add(_lblStatus);

            // Hidden legacy buttons (NOT visible on the form)
            _btnLoadLibrary = CreateHiddenButton("Load Library");
            _btnImportLibrary = CreateHiddenButton("Import Library (Excel)");
            _btnSaveLibrary = CreateHiddenButton("Save Library");
            _btnLoadSynonyms = CreateHiddenButton("Load Synonyms");
            _btnImportSynonyms = CreateHiddenButton("Import Synonyms (Excel)");
            _btnSaveSynonyms = CreateHiddenButton("Save Synonyms");
            _btnAnalyzeVariability = CreateHiddenButton("Analyze Variability", enabled: false);
            _btnGenerateValidation = CreateHiddenButton("Generate Validation", enabled: false);
            _btnExportDocs = CreateHiddenButton("Export Documentation");
            _btnExportUnknowns = CreateHiddenButton("Export Unknowns", enabled: false);
            _btnExportVariability = CreateHiddenButton("Export Variability", enabled: false);
            _btnExportValidation = CreateHiddenButton("Export Validation", enabled: false);
            _btnChooseColumns = CreateHiddenButton("Choose Output Columns", enabled: false);
            _btnSaveOutput = CreateHiddenButton("Save Output Excel", enabled: false);

            // Add hidden buttons to Controls (but invisible) so PerformClick is always reliable
            Controls.AddRange(new Control[]
            {
                _btnLoadLibrary, _btnImportLibrary, _btnSaveLibrary,
                _btnLoadSynonyms, _btnImportSynonyms, _btnSaveSynonyms,
                _btnAnalyzeVariability, _btnGenerateValidation, _btnExportDocs,
                _btnExportUnknowns, _btnExportVariability, _btnExportValidation,
                _btnChooseColumns, _btnSaveOutput
            });

            foreach (Control c in new Control[]
            {
                _btnLoadLibrary, _btnImportLibrary, _btnSaveLibrary,
                _btnLoadSynonyms, _btnImportSynonyms, _btnSaveSynonyms,
                _btnAnalyzeVariability, _btnGenerateValidation, _btnExportDocs,
                _btnExportUnknowns, _btnExportVariability, _btnExportValidation,
                _btnChooseColumns, _btnSaveOutput
            })
            {
                c.Visible = false;
                c.TabStop = false;
            }
        }

        private static Button CreateHiddenButton(string text, bool enabled = true)
        {
            return new Button
            {
                Text = text,
                Enabled = enabled,
                Visible = false,
                TabStop = false,
                Left = -5000,
                Top = -5000,
                Width = 1,
                Height = 1
            };
        }

        private void BuildOfficeRibbon()
        {
            // Office-style ribbon mimic: TabControl + ribbon pages containing GroupBoxes + ToolStrips
            _ribbonTabs = new TabControl
            {
                Left = 15,
                Top = 5,
                Width = 1350,
                Height = 86,
                Anchor = AnchorStyles.Top | AnchorStyles.Left | AnchorStyles.Right
            };

            var tabFile = new TabPage("File");
            var tabHome = new TabPage("Home");
            var tabView = new TabPage("View");
            var tabEdit = new TabPage("Edit");
            var tabTools = new TabPage("Tools");
            var tabLibrary = new TabPage("Library");

            _ribbonTabs.TabPages.Add(tabFile);
            _ribbonTabs.TabPages.Add(tabHome);
            _ribbonTabs.TabPages.Add(tabView);
            _ribbonTabs.TabPages.Add(tabEdit);
            _ribbonTabs.TabPages.Add(tabTools);
            _ribbonTabs.TabPages.Add(tabLibrary);

            Controls.Add(_ribbonTabs);

            // FILE ribbon layout
            var fileFlow = CreateRibbonFlow();
            tabFile.Controls.Add(fileFlow);

            var grpOpen = CreateRibbonGroup("Open", 220);
            var tsOpen = CreateGroupToolStrip();
            var rUpload = new ToolStripButton("Upload File") { AutoSize = false, Width = 180, Height = 30 };
            rUpload.Click += (_, __) => _btnUploadInput.PerformClick();
            tsOpen.Items.Add(rUpload);
            grpOpen.Controls.Add(tsOpen);
            fileFlow.Controls.Add(grpOpen);

            var grpSave = CreateRibbonGroup("Save / Export", 520);
            var tsSave = CreateGroupToolStrip();

            _rSaveOutput = new ToolStripButton("Save Output (Ctrl+S)") { AutoSize = false, Width = 160, Height = 30 };
            _rSaveOutput.Click += (_, __) => _btnSaveOutput.PerformClick();

            _rChooseColumns = new ToolStripButton("Choose Columns") { AutoSize = false, Width = 140, Height = 30 };
            _rChooseColumns.Click += (_, __) => _btnChooseColumns.PerformClick();

            _rExportUnknowns = new ToolStripButton("Export Unknowns") { AutoSize = false, Width = 140, Height = 30 };
            _rExportUnknowns.Click += (_, __) => _btnExportUnknowns.PerformClick();

            _rExportVariability = new ToolStripButton("Export Variability") { AutoSize = false, Width = 150, Height = 30 };
            _rExportVariability.Click += (_, __) => _btnExportVariability.PerformClick();

            _rExportValidation = new ToolStripButton("Export Validation") { AutoSize = false, Width = 145, Height = 30 };
            _rExportValidation.Click += (_, __) => _btnExportValidation.PerformClick();

            _rExportDocs = new ToolStripButton("Export Docs") { AutoSize = false, Width = 110, Height = 30 };
            _rExportDocs.Click += (_, __) => _btnExportDocs.PerformClick();

            tsSave.Items.Add(_rSaveOutput);
            tsSave.Items.Add(new ToolStripSeparator());
            tsSave.Items.Add(_rChooseColumns);
            tsSave.Items.Add(new ToolStripSeparator());
            tsSave.Items.Add(_rExportUnknowns);
            tsSave.Items.Add(_rExportVariability);
            tsSave.Items.Add(_rExportValidation);
            tsSave.Items.Add(new ToolStripSeparator());
            tsSave.Items.Add(_rExportDocs);

            grpSave.Controls.Add(tsSave);
            fileFlow.Controls.Add(grpSave);

            // HOME ribbon layout
            var homeFlow = CreateRibbonFlow();
            tabHome.Controls.Add(homeFlow);

            var grpRun = CreateRibbonGroup("Run", 360);
            var tsRun = CreateGroupToolStrip();

            var rRun = new ToolStripButton("Run (Ctrl+R)") { AutoSize = false, Width = 110, Height = 30 };
            rRun.Click += (_, __) => _btnRun.PerformClick();

            _rAnalyzeVariability = new ToolStripButton("Analyze Variability") { AutoSize = false, Width = 150, Height = 30 };
            _rAnalyzeVariability.Click += (_, __) => _btnAnalyzeVariability.PerformClick();

            _rGenerateValidation = new ToolStripButton("Generate Validation") { AutoSize = false, Width = 150, Height = 30 };
            _rGenerateValidation.Click += (_, __) => _btnGenerateValidation.PerformClick();

            tsRun.Items.Add(rRun);
            tsRun.Items.Add(new ToolStripSeparator());
            tsRun.Items.Add(_rAnalyzeVariability);
            tsRun.Items.Add(_rGenerateValidation);

            grpRun.Controls.Add(tsRun);
            homeFlow.Controls.Add(grpRun);

            var grpFont = CreateRibbonGroup("Font (Tables)", 560);
            var tsFont = CreateGroupToolStrip();

            _rFontFamily = new ToolStripComboBox { AutoSize = false, Width = 180, DropDownStyle = ComboBoxStyle.DropDownList };
            _rFontSize = new ToolStripComboBox { AutoSize = false, Width = 70, DropDownStyle = ComboBoxStyle.DropDownList };

            _rBold = new ToolStripButton("B") { CheckOnClick = true, Font = new Font("Segoe UI", 9, FontStyle.Bold) };
            _rItalic = new ToolStripButton("I") { CheckOnClick = true, Font = new Font("Segoe UI", 9, FontStyle.Italic) };
            _rUnderline = new ToolStripButton("U") { CheckOnClick = true, Font = new Font("Segoe UI", 9, FontStyle.Underline) };

            _rTextColor = new ToolStripDropDownButton("Text Color");
            _rHighlight = new ToolStripDropDownButton("Highlight");

            PopulateFontControls();
            BuildColorMenus();

            _rFontFamily.SelectedIndexChanged += (_, __) => ApplyGridFontFromRibbon();
            _rFontSize.SelectedIndexChanged += (_, __) => ApplyGridFontFromRibbon();
            _rBold.Click += (_, __) => ApplyGridFontFromRibbon();
            _rItalic.Click += (_, __) => ApplyGridFontFromRibbon();
            _rUnderline.Click += (_, __) => ApplyGridFontFromRibbon();

            tsFont.Items.Add(new ToolStripLabel("Font:"));
            tsFont.Items.Add(_rFontFamily);
            tsFont.Items.Add(_rFontSize);
            tsFont.Items.Add(new ToolStripSeparator());
            tsFont.Items.Add(_rBold);
            tsFont.Items.Add(_rItalic);
            tsFont.Items.Add(_rUnderline);
            tsFont.Items.Add(new ToolStripSeparator());
            tsFont.Items.Add(_rTextColor);
            tsFont.Items.Add(_rHighlight);

            grpFont.Controls.Add(tsFont);
            homeFlow.Controls.Add(grpFont);

            // VIEW ribbon (navigation shortcuts only; no behavior changes)
            var viewFlow = CreateRibbonFlow();
            tabView.Controls.Add(viewFlow);

            var grpNav = CreateRibbonGroup("Navigate Tabs", 620);
            var tsNav = CreateGroupToolStrip();

            tsNav.Items.Add(MakeNavButton("Input", () => _tabs.SelectedTab = _tabInput));
            tsNav.Items.Add(MakeNavButton("Unknowns", () => _tabs.SelectedTab = _tabUnknowns));
            tsNav.Items.Add(MakeNavButton("Variability", () => _tabs.SelectedTab = _tabVariability));
            tsNav.Items.Add(MakeNavButton("Validation", () => _tabs.SelectedTab = _tabValidation));
            tsNav.Items.Add(new ToolStripSeparator());
            tsNav.Items.Add(MakeNavButton("Cost Savings", () => _tabs.SelectedTab = _tabCostSavings));
            tsNav.Items.Add(MakeNavButton("Spend Trends", () => _tabs.SelectedTab = _tabSpendTrends));

            grpNav.Controls.Add(tsNav);
            viewFlow.Controls.Add(grpNav);

            // EDIT ribbon (search focus only; preserves existing Ctrl+F logic)
            var editFlow = CreateRibbonFlow();
            tabEdit.Controls.Add(editFlow);

            var grpFind = CreateRibbonGroup("Find", 220);
            var tsFind = CreateGroupToolStrip();

            var rFocusSearch = new ToolStripButton("Focus Search (Ctrl+F)") { AutoSize = false, Width = 180, Height = 30 };
            rFocusSearch.Click += (_, __) =>
            {
                _txtSearch.Focus();
                _txtSearch.SelectAll();
            };

            tsFind.Items.Add(rFocusSearch);
            grpFind.Controls.Add(tsFind);
            editFlow.Controls.Add(grpFind);

            // TOOLS ribbon (same tool actions as dropdown)
            var toolsFlow = CreateRibbonFlow();
            tabTools.Controls.Add(toolsFlow);

            var grpTools = CreateRibbonGroup("Analytics Tools", 520);
            var tsTools = CreateGroupToolStrip();

            _rToolCostSavings = new ToolStripButton("Cost-Savings Finder") { AutoSize = false, Width = 170, Height = 30 };
            _rToolCostSavings.Click += (_, __) =>
            {
                if (_inputTable == null) { MessageBox.Show("Upload an input Excel file first."); return; }
                try
                {
                    RunCostSavingsOpportunityFinder(_inputTable, _costSavingsGrid);
                    _lblStatus.Text = "Status: Cost-Savings computed. Top 25 shown.";
                    _tabs.SelectedTab = _tabCostSavings;
                }
                catch (Exception ex) { MessageBox.Show(ex.Message, "Cost-Savings Tool Error"); }
            };

            _rToolSpendTrends = new ToolStripButton("Spend Trends") { AutoSize = false, Width = 130, Height = 30 };
            _rToolSpendTrends.Click += (_, __) =>
            {
                if (_inputTable == null) { MessageBox.Show("Upload an input Excel file first."); return; }
                try
                {
                    RunTherapeuticSpendTrends(_inputTable, _spendTrendsGrid);
                    _lblStatus.Text = $"Status: Spend Trends created ({_spendTrendsTable.Rows.Count} rows).";
                    _tabs.SelectedTab = _tabSpendTrends;
                }
                catch (Exception ex) { MessageBox.Show(ex.Message, "Spend Trends Tool Error"); }
            };

            tsTools.Items.Add(_rToolCostSavings);
            tsTools.Items.Add(_rToolSpendTrends);

            grpTools.Controls.Add(tsTools);
            toolsFlow.Controls.Add(grpTools);

            // LIBRARY ribbon
            var libFlow = CreateRibbonFlow();
            tabLibrary.Controls.Add(libFlow);

            var grpIng = CreateRibbonGroup("Ingredient Library", 430);
            var tsIng = CreateGroupToolStrip();

            _rLoadLibrary = new ToolStripButton("Load") { AutoSize = false, Width = 90, Height = 30 };
            _rLoadLibrary.Click += (_, __) => _btnLoadLibrary.PerformClick();

            _rImportLibrary = new ToolStripButton("Import (Excel)") { AutoSize = false, Width = 130, Height = 30 };
            _rImportLibrary.Click += (_, __) => _btnImportLibrary.PerformClick();

            _rSaveLibrary = new ToolStripButton("Save") { AutoSize = false, Width = 90, Height = 30 };
            _rSaveLibrary.Click += (_, __) => _btnSaveLibrary.PerformClick();

            tsIng.Items.Add(_rLoadLibrary);
            tsIng.Items.Add(_rImportLibrary);
            tsIng.Items.Add(_rSaveLibrary);

            grpIng.Controls.Add(tsIng);
            libFlow.Controls.Add(grpIng);

            var grpSyn = CreateRibbonGroup("Synonyms", 430);
            var tsSyn = CreateGroupToolStrip();

            _rLoadSynonyms = new ToolStripButton("Load") { AutoSize = false, Width = 90, Height = 30 };
            _rLoadSynonyms.Click += (_, __) => _btnLoadSynonyms.PerformClick();

            _rImportSynonyms = new ToolStripButton("Import (Excel)") { AutoSize = false, Width = 130, Height = 30 };
            _rImportSynonyms.Click += (_, __) => _btnImportSynonyms.PerformClick();

            _rSaveSynonyms = new ToolStripButton("Save") { AutoSize = false, Width = 90, Height = 30 };
            _rSaveSynonyms.Click += (_, __) => _btnSaveSynonyms.PerformClick();

            tsSyn.Items.Add(_rLoadSynonyms);
            tsSyn.Items.Add(_rImportSynonyms);
            tsSyn.Items.Add(_rSaveSynonyms);

            grpSyn.Controls.Add(tsSyn);
            libFlow.Controls.Add(grpSyn);

            // Bind ribbon enabled states to legacy buttons (preserves all state logic)
            BindEnabled(_btnSaveOutput, _rSaveOutput);
            BindEnabled(_btnChooseColumns, _rChooseColumns);
            BindEnabled(_btnExportDocs, _rExportDocs);
            BindEnabled(_btnExportUnknowns, _rExportUnknowns);
            BindEnabled(_btnExportVariability, _rExportVariability);
            BindEnabled(_btnExportValidation, _rExportValidation);
            BindEnabled(_btnAnalyzeVariability, _rAnalyzeVariability);
            BindEnabled(_btnGenerateValidation, _rGenerateValidation);

            BindEnabled(_btnLoadLibrary, _rLoadLibrary);
            BindEnabled(_btnImportLibrary, _rImportLibrary);
            BindEnabled(_btnSaveLibrary, _rSaveLibrary);

            BindEnabled(_btnLoadSynonyms, _rLoadSynonyms);
            BindEnabled(_btnImportSynonyms, _rImportSynonyms);
            BindEnabled(_btnSaveSynonyms, _rSaveSynonyms);
        }

        private static FlowLayoutPanel CreateRibbonFlow()
        {
            return new FlowLayoutPanel
            {
                Dock = DockStyle.Fill,
                FlowDirection = FlowDirection.LeftToRight,
                WrapContents = false,
                AutoScroll = true,
                Padding = new Padding(6, 6, 6, 6)
            };
        }

        private static GroupBox CreateRibbonGroup(string text, int width)
        {
            return new GroupBox
            {
                Text = text,
                Width = width,
                Height = 56,
                Padding = new Padding(6, 14, 6, 6),
                Margin = new Padding(6, 2, 6, 2)
            };
        }

        private static ToolStrip CreateGroupToolStrip()
        {
            return new ToolStrip
            {
                Dock = DockStyle.Fill,
                GripStyle = ToolStripGripStyle.Hidden,
                BackColor = SystemColors.Control,
                RenderMode = ToolStripRenderMode.System
            };
        }

        private static ToolStripButton MakeNavButton(string text, Action onClick)
        {
            var b = new ToolStripButton(text) { AutoSize = false, Width = 95, Height = 30 };
            b.Click += (_, __) => onClick();
            return b;
        }

        private void BindEnabled(Control legacyButton, ToolStripItem ribbonItem)
        {
            ribbonItem.Enabled = legacyButton.Enabled;
            legacyButton.EnabledChanged += (_, __) => ribbonItem.Enabled = legacyButton.Enabled;
        }

        // =========================
        // MUST KEEP: Search + Tools ToolStrips (as-is)
        // =========================
        private void BuildSearchAndToolsRibbons_ExactlyAsIs()
        {
            // =========================
            // NEW: Search ribbon (ToolStrip) - search box only + Next/Prev
            // =========================
            var searchRibbon = new ToolStrip
            {
                Dock = DockStyle.None,
                GripStyle = ToolStripGripStyle.Hidden,
                Location = new Point(15, 95),
                Size = new Size(1350, 28)
            };

            var lblSearch = new ToolStripLabel("Search:");
            var txtSearch = new ToolStripTextBox { Width = 320 };
            var btnPrev = new ToolStripButton("Prev");
            var btnNext = new ToolStripButton("Next");

            searchRibbon.Items.Add(lblSearch);
            searchRibbon.Items.Add(txtSearch);
            searchRibbon.Items.Add(btnPrev);
            searchRibbon.Items.Add(btnNext);

            // =========================
            // NEW: Tools ribbon (ToolStrip) - dropdown list of tools
            // =========================
            var toolsRibbon = new ToolStrip
            {
                Dock = DockStyle.None,
                GripStyle = ToolStripGripStyle.Hidden,
                Location = new Point(15, 125),
                Size = new Size(1350, 28)
            };

            toolsRibbon.Items.Add(new ToolStripLabel("Tools:"));

            var ddTools = new ToolStripDropDownButton("Select Tool");
            toolsRibbon.Items.Add(ddTools);

            Controls.Add(searchRibbon);
            Controls.Add(toolsRibbon);

            // store fields (no behavior changes)
            _searchRibbon = searchRibbon;
            _txtSearch = txtSearch;
            _btnPrevSearch = btnPrev;
            _btnNextSearch = btnNext;

            _toolsRibbon = toolsRibbon;
            _ddTools = ddTools;
        }

        // =========================
        // Main tabs/grids (same)
        // =========================
        private void BuildMainTabsAndGrids()
        {
            _tabs = new TabControl { Left = 15, Top = 185, Width = 1350, Height = 590 };
            _tabs.Anchor = AnchorStyles.Top | AnchorStyles.Bottom | AnchorStyles.Left | AnchorStyles.Right;

            _tabLibrary = new TabPage("Ingredient Library (Editable)");
            _tabSynonyms = new TabPage("Synonyms (Editable)");
            _tabInput = new TabPage("Input + Output Preview");
            _tabUnknowns = new TabPage("Unknowns (Needs Review)");
            _tabVariability = new TabPage("Variability Report");
            _tabValidation = new TabPage("Validation Examples");
            _tabCostSavings = new TabPage("Cost Savings");
            _tabSpendTrends = new TabPage("Spend Trends");

            _tabs.TabPages.Add(_tabLibrary);
            _tabs.TabPages.Add(_tabSynonyms);
            _tabs.TabPages.Add(_tabInput);
            _tabs.TabPages.Add(_tabUnknowns);
            _tabs.TabPages.Add(_tabVariability);
            _tabs.TabPages.Add(_tabValidation);
            _tabs.TabPages.Add(_tabCostSavings);
            _tabs.TabPages.Add(_tabSpendTrends);

            _libraryGrid = MakeEditableGrid();
            _synonymsGrid = MakeEditableGrid();
            _inputGrid = MakeReadOnlyGrid();
            _unknownsGrid = MakeEditableGrid();
            _variabilityGrid = MakeReadOnlyGrid();
            _validationGrid = MakeReadOnlyGrid();
            _costSavingsGrid = MakeReadOnlyGrid();
            _spendTrendsGrid = MakeReadOnlyGrid();

            _tabLibrary.Controls.Add(_libraryGrid);
            _tabSynonyms.Controls.Add(_synonymsGrid);
            _tabInput.Controls.Add(_inputGrid);
            _tabUnknowns.Controls.Add(_unknownsGrid);
            _tabVariability.Controls.Add(_variabilityGrid);
            _tabValidation.Controls.Add(_validationGrid);
            _tabCostSavings.Controls.Add(_costSavingsGrid);
            _tabSpendTrends.Controls.Add(_spendTrendsGrid);

            Controls.Add(_tabs);
        }

        // =========================
        // Original button actions (kept identical)
        // =========================
        private void WireLegacyButtonActions_OriginalLogicUnchanged()
        {
            // Upload button maps to original upload logic (using the existing handler below)
            _btnUploadInput.Click += (_, __) => _btnUploadInput_OriginalHandler();
            _btnRun.Click += (_, __) => _btnRun_OriginalHandler();

            // Library buttons
            _btnLoadLibrary.Click += (_, __) =>
            {
                try
                {
                    LoadLibraryFromDb();
                    _libraryGrid.DataSource = _libraryTable;
                    _lblStatus.Text = $"Status: Library loaded ({_libraryTable.Rows.Count} ingredients).";
                }
                catch (Exception ex) { MessageBox.Show(ex.Message, "Load Library Error"); }
            };

            _btnImportLibrary.Click += (_, __) =>
            {
                using var ofd = new OpenFileDialog { Filter = "Excel Files (*.xlsx)|*.xlsx", Title = "Select Ingredient Library Excel" };
                if (ofd.ShowDialog() != DialogResult.OK) return;

                try
                {
                    int added = ImportIngredientsFromExcel(ofd.FileName);
                    LoadLibraryFromDb();
                    _libraryGrid.DataSource = _libraryTable;
                    _lblStatus.Text = $"Status: Imported ingredients. Added {added}. Total {_libraryTable.Rows.Count}.";
                }
                catch (Exception ex) { MessageBox.Show(ex.Message, "Import Library Error"); }
            };

            _btnSaveLibrary.Click += (_, __) =>
            {
                try
                {
                    SaveIngredientsToDb(_libraryTable);
                    LoadLibraryFromDb();
                    _libraryGrid.DataSource = _libraryTable;
                    _lblStatus.Text = $"Status: Library saved. Total {_libraryTable.Rows.Count}.";
                }
                catch (Exception ex) { MessageBox.Show(ex.Message, "Save Library Error"); }
            };

            // Synonyms buttons
            _btnLoadSynonyms.Click += (_, __) =>
            {
                try
                {
                    LoadSynonymsFromDb();
                    _synonymsGrid.DataSource = _synonymsTable;
                    _lblStatus.Text = $"Status: Synonyms loaded ({_synonymsTable.Rows.Count} mappings).";
                }
                catch (Exception ex) { MessageBox.Show(ex.Message, "Load Synonyms Error"); }
            };

            _btnImportSynonyms.Click += (_, __) =>
            {
                using var ofd = new OpenFileDialog { Filter = "Excel Files (*.xlsx)|*.xlsx", Title = "Select Synonyms Excel" };
                if (ofd.ShowDialog() != DialogResult.OK) return;

                try
                {
                    int added = ImportSynonymsFromExcel(ofd.FileName);
                    LoadSynonymsFromDb();
                    _synonymsGrid.DataSource = _synonymsTable;
                    _lblStatus.Text = $"Status: Imported synonyms. Added {added}. Total {_synonymsTable.Rows.Count}.";
                }
                catch (Exception ex) { MessageBox.Show(ex.Message, "Import Synonyms Error"); }
            };

            _btnSaveSynonyms.Click += (_, __) =>
            {
                try
                {
                    SaveSynonymsToDb(_synonymsTable);
                    LoadSynonymsFromDb();
                    _synonymsGrid.DataSource = _synonymsTable;
                    _lblStatus.Text = $"Status: Synonyms saved. Total {_synonymsTable.Rows.Count}.";
                }
                catch (Exception ex) { MessageBox.Show(ex.Message, "Save Synonyms Error"); }
            };

            // Analyze / validation
            _btnAnalyzeVariability.Click += (_, __) =>
            {
                if (_inputTable == null) return;

                _variabilityTable = BuildVariabilityReport(_inputTable);
                _variabilityGrid.DataSource = _variabilityTable;

                _btnExportVariability.Enabled = _variabilityTable.Rows.Count > 0;

                _lblStatus.Text = $"Status: Variability report created ({_variabilityTable.Rows.Count} ingredients).";
                _tabs.SelectedTab = _tabVariability;
            };

            _btnGenerateValidation.Click += (_, __) =>
            {
                if (_inputTable == null) return;

                _validationTable = BuildValidationExamples(_inputTable, topIngredients: 20, examplesPerIngredient: 10);
                _validationGrid.DataSource = _validationTable;

                _btnExportValidation.Enabled = _validationTable.Rows.Count > 0;

                _lblStatus.Text = $"Status: Validation examples created ({_validationTable.Rows.Count} rows).";
                _tabs.SelectedTab = _tabValidation;
            };

            // Choose columns
            _btnChooseColumns.Click += (_, __) =>
            {
                if (_inputTable == null) return;

                var allCols = _inputTable.Columns.Cast<DataColumn>().Select(c => c.ColumnName).ToList();

                if (_selectedOutputColumns == null)
                    _selectedOutputColumns = new HashSet<string>(allCols, StringComparer.OrdinalIgnoreCase);

                using var dlg = new ColumnPickerDialog(allCols, _selectedOutputColumns);
                if (dlg.ShowDialog() == DialogResult.OK)
                {
                    _selectedOutputColumns = dlg.SelectedColumns;
                    _lblStatus.Text = $"Status: Output columns selected ({_selectedOutputColumns.Count} columns).";
                }
            };

            // Save output
            _btnSaveOutput.Click += (_, __) =>
            {
                if (_inputTable == null) return;

                using var sfd = new SaveFileDialog
                {
                    Filter = "Excel Files (*.xlsx)|*.xlsx",
                    Title = "Save Standardized Output",
                    FileName = "standardized_output.xlsx"
                };
                if (sfd.ShowDialog() != DialogResult.OK) return;

                try
                {
                    DataTable toSave = _inputTable;

                    if (_selectedOutputColumns != null)
                        toSave = CreateFilteredTable(_inputTable, _selectedOutputColumns);

                    SaveDataTableToExcel(toSave, sfd.FileName);
                    _lblStatus.Text = $"Status: Output saved -> {sfd.FileName}";
                }
                catch (Exception ex) { MessageBox.Show(ex.Message, "Save Output Error"); }
            };

            // Export unknowns
            _btnExportUnknowns.Click += (_, __) =>
            {
                if (_unknownsTable.Rows.Count == 0) return;

                using var sfd = new SaveFileDialog
                {
                    Filter = "Excel Files (*.xlsx)|*.xlsx",
                    Title = "Save Unknowns",
                    FileName = "unknowns.xlsx"
                };
                if (sfd.ShowDialog() != DialogResult.OK) return;

                try
                {
                    SaveDataTableToExcel(_unknownsTable, sfd.FileName);
                    _lblStatus.Text = $"Status: Unknowns exported -> {sfd.FileName}";
                }
                catch (Exception ex) { MessageBox.Show(ex.Message, "Export Unknowns Error"); }
            };

            // Export variability
            _btnExportVariability.Click += (_, __) =>
            {
                if (_variabilityTable.Rows.Count == 0) return;

                using var sfd = new SaveFileDialog
                {
                    Filter = "Excel Files (*.xlsx)|*.xlsx",
                    Title = "Save Variability Report",
                    FileName = "variability_report.xlsx"
                };
                if (sfd.ShowDialog() != DialogResult.OK) return;

                try
                {
                    SaveDataTableToExcel(_variabilityTable, sfd.FileName);
                    _lblStatus.Text = $"Status: Variability exported -> {sfd.FileName}";
                }
                catch (Exception ex) { MessageBox.Show(ex.Message, "Export Variability Error"); }
            };

            // Export validation
            _btnExportValidation.Click += (_, __) =>
            {
                if (_validationTable.Rows.Count == 0) return;

                using var sfd = new SaveFileDialog
                {
                    Filter = "Excel Files (*.xlsx)|*.xlsx",
                    Title = "Save Validation Examples",
                    FileName = "validation_examples.xlsx"
                };
                if (sfd.ShowDialog() != DialogResult.OK) return;

                try
                {
                    SaveDataTableToExcel(_validationTable, sfd.FileName);
                    _lblStatus.Text = $"Status: Validation exported -> {sfd.FileName}";
                }
                catch (Exception ex) { MessageBox.Show(ex.Message, "Export Validation Error"); }
            };

            // Export docs
            _btnExportDocs.Click += (_, __) =>
            {
                using var sfd = new SaveFileDialog
                {
                    Filter = "Text Files (*.txt)|*.txt",
                    Title = "Save Documentation",
                    FileName = "Standardization_Documentation.txt"
                };
                if (sfd.ShowDialog() != DialogResult.OK) return;

                try
                {
                    File.WriteAllText(sfd.FileName, BuildDocumentationText(), Encoding.UTF8);
                    _lblStatus.Text = $"Status: Documentation exported -> {sfd.FileName}";
                }
                catch (Exception ex) { MessageBox.Show(ex.Message, "Export Documentation Error"); }
            };
        }

        private void _btnUploadInput_OriginalHandler()
        {
            using var ofd = new OpenFileDialog { Filter = "Excel Files (*.xlsx)|*.xlsx", Title = "Select Input Excel" };
            if (ofd.ShowDialog() != DialogResult.OK) return;

            try
            {
                _inputTable = LoadFirstSheetToDataTable(ofd.FileName);
                _inputGrid.DataSource = _inputTable;

                _btnRun.Enabled = true;

                _btnSaveOutput.Enabled = false;
                _btnChooseColumns.Enabled = false;

                _btnAnalyzeVariability.Enabled = false;
                _btnGenerateValidation.Enabled = false;

                _btnExportUnknowns.Enabled = false;
                _btnExportVariability.Enabled = false;
                _btnExportValidation.Enabled = false;

                _selectedOutputColumns = null;

                _lblStatus.Text = $"Status: Input loaded ({_inputTable.Rows.Count} rows). (Right-click column header to delete columns)";
                _tabs.SelectedTab = _tabInput;
            }
            catch (Exception ex) { MessageBox.Show(ex.Message, "Input Load Error"); }
        }

        private void _btnRun_OriginalHandler()
        {
            if (_inputTable == null)
            {
                MessageBox.Show("Upload an input Excel file first.");
                return;
            }

            if (_ingredientSet.Count == 0)
            {
                MessageBox.Show("Ingredient Library is empty. Import/add ingredients first.");
                return;
            }

            var genericCol = FindColumn(_inputTable, "generic_name");
            if (genericCol == null)
            {
                MessageBox.Show("Input must have a column named 'generic_name' in header row.");
                return;
            }

            EnsureOutputColumns(_inputTable);

            _lblStatus.Text = "Status: Standardizing...";
            Application.DoEvents();

            BuildUnknownsTableSchema();

            int unknownCount = 0;

            foreach (DataRow row in _inputTable.Rows)
            {
                var raw = row[genericCol]?.ToString() ?? "";
                var result = ExtractWithRules(raw, _ingredientSet, _synonymMap);

                row["PrimaryIngredient"] = result.PrimaryIngredient;
                row["AllIngredients"] = result.AllIngredients;
                row["RuleApplied"] = result.RuleApplied;
                row["NormalizedGeneric"] = result.CleanedForMatching;

                if (result.IsUnknown)
                {
                    unknownCount++;
                    AddUnknownRow(raw, result.CleanedForMatching, result.SuggestedIngredient);
                }
            }

            _inputGrid.Refresh();
            _unknownsGrid.DataSource = _unknownsTable;

            _btnSaveOutput.Enabled = true;
            _btnChooseColumns.Enabled = true;

            _btnAnalyzeVariability.Enabled = true;
            _btnGenerateValidation.Enabled = true;

            _btnExportUnknowns.Enabled = _unknownsTable.Rows.Count > 0;
            _btnExportVariability.Enabled = false;
            _btnExportValidation.Enabled = false;

            _selectedOutputColumns = new HashSet<string>(
                _inputTable.Columns.Cast<DataColumn>().Select(c => c.ColumnName),
                StringComparer.OrdinalIgnoreCase
            );

            LogRun(_inputTable.Rows.Count, unknownCount);

            _lblStatus.Text = $"Status: Done. Unknowns: {unknownCount}. Click PrimaryIngredient cell for popup. Right-click column header to delete preview columns.";
        }

        private void SyncRibbonEnabledFromLegacyButtons()
        {
            // (Enabled binding also handles this, but keep a one-shot sync)
            if (_rSaveOutput != null) _rSaveOutput.Enabled = _btnSaveOutput.Enabled;
            if (_rChooseColumns != null) _rChooseColumns.Enabled = _btnChooseColumns.Enabled;
            if (_rExportDocs != null) _rExportDocs.Enabled = _btnExportDocs.Enabled;
            if (_rExportUnknowns != null) _rExportUnknowns.Enabled = _btnExportUnknowns.Enabled;
            if (_rExportVariability != null) _rExportVariability.Enabled = _btnExportVariability.Enabled;
            if (_rExportValidation != null) _rExportValidation.Enabled = _btnExportValidation.Enabled;
            if (_rAnalyzeVariability != null) _rAnalyzeVariability.Enabled = _btnAnalyzeVariability.Enabled;
            if (_rGenerateValidation != null) _rGenerateValidation.Enabled = _btnGenerateValidation.Enabled;
        }

        // =========================
        // Feature A) Right-click column header -> Delete Column (Preview)
        // =========================
        private void BuildInputGridDeleteColumnFeature()
        {
            var inputHeaderMenu = new ContextMenuStrip();
            var miDeleteColumn = new ToolStripMenuItem("Delete Column");
            inputHeaderMenu.Items.Add(miDeleteColumn);

            string? lastRightClickedColumnName = null;

            _inputGrid.ColumnHeaderMouseClick += (_, e) =>
            {
                if (e.Button != MouseButtons.Right) return;
                if (e.ColumnIndex < 0) return;

                lastRightClickedColumnName = _inputGrid.Columns[e.ColumnIndex].Name;

                _inputGrid.ClearSelection();
                _inputGrid.Columns[e.ColumnIndex].Selected = true;

                inputHeaderMenu.Show(Cursor.Position);
            };

            miDeleteColumn.Click += (_, __) =>
            {
                if (_inputTable == null) return;
                if (string.IsNullOrWhiteSpace(lastRightClickedColumnName)) return;

                var protectedCols = new HashSet<string>(StringComparer.OrdinalIgnoreCase) { "generic_name" };

                if (protectedCols.Contains(lastRightClickedColumnName))
                {
                    MessageBox.Show($"You cannot delete required column: {lastRightClickedColumnName}", "Protected Column");
                    return;
                }

                if (!_inputTable.Columns.Contains(lastRightClickedColumnName)) return;

                var confirm = MessageBox.Show(
                    $"Delete column '{lastRightClickedColumnName}' from the preview table?\n\nThis removes it from the current loaded data in the program.",
                    "Confirm Delete Column",
                    MessageBoxButtons.YesNo,
                    MessageBoxIcon.Warning
                );

                if (confirm != DialogResult.Yes) return;

                _inputTable.Columns.Remove(lastRightClickedColumnName);

                _selectedOutputColumns?.Remove(lastRightClickedColumnName);

                _inputGrid.DataSource = _inputTable;
                _inputGrid.Refresh();

                _lblStatus.Text = $"Status: Deleted column '{lastRightClickedColumnName}' from preview.";
            };
        }

        // =========================
        // Feature B) Click PrimaryIngredient cell -> popup count + unique forms
        // =========================
        private void BuildPrimaryIngredientPopupFeature()
        {
            _inputGrid.CellClick += (_, e) =>
            {
                if (e.RowIndex < 0 || e.ColumnIndex < 0) return;
                if (_inputTable == null) return;

                var clickedColName = _inputGrid.Columns[e.ColumnIndex].Name;
                if (!clickedColName.Equals("PrimaryIngredient", StringComparison.OrdinalIgnoreCase))
                    return;

                var ingredient = _inputGrid.Rows[e.RowIndex].Cells[e.ColumnIndex].Value?.ToString()?.Trim();
                if (string.IsNullOrWhiteSpace(ingredient)) return;

                var primaryCol = FindColumn(_inputTable, "PrimaryIngredient");
                var genericCol = FindColumn(_inputTable, "generic_name");
                if (primaryCol == null || genericCol == null)
                {
                    MessageBox.Show("Missing required columns: PrimaryIngredient or generic_name.", "Error");
                    return;
                }

                int count = 0;
                var uniqueForms = new HashSet<string>(StringComparer.OrdinalIgnoreCase);

                foreach (DataRow r in _inputTable.Rows)
                {
                    var p = (r[primaryCol]?.ToString() ?? "").Trim();
                    if (!p.Equals(ingredient, StringComparison.OrdinalIgnoreCase)) continue;

                    count++;

                    var g = (r[genericCol]?.ToString() ?? "").Trim();
                    if (!string.IsNullOrWhiteSpace(g))
                        uniqueForms.Add(g);
                }

                var sb = new StringBuilder();
                sb.AppendLine($"Primary Ingredient: {ingredient}");
                sb.AppendLine($"Mentioned: {count} time(s)");
                sb.AppendLine();
                sb.AppendLine("Unique forms in sheet (no duplicates):");
                sb.AppendLine("-------------------------------------");
                foreach (var form in uniqueForms.OrderBy(x => x))
                    sb.AppendLine("• " + form);

                ShowBigPopup(sb.ToString(), $"Ingredient Summary — {ingredient}");
            };
        }

        // =========================
        // Search logic (original behavior)
        // =========================
        private void BuildSearchLogic_Original()
        {
            string lastTerm = "";
            int lastRow = -1;
            int lastCol = -1;

            // Ctrl+F focuses the search box (KEEP)
            KeyDown += (_, e) =>
            {
                if (e.Control && e.KeyCode == Keys.F)
                {
                    _txtSearch.Focus();
                    _txtSearch.SelectAll();
                    e.SuppressKeyPress = true;
                }
            };

            bool Find(bool forward)
            {
                if (_inputTable == null && _tabs.SelectedTab == _tabInput)
                {
                    MessageBox.Show("Upload an input Excel file first.");
                    return false;
                }

                var term = (_txtSearch.Text ?? "").Trim();
                if (string.IsNullOrWhiteSpace(term))
                {
                    _lblStatus.Text = "Status: Search is empty.";
                    return false;
                }

                if (!term.Equals(lastTerm, StringComparison.OrdinalIgnoreCase))
                {
                    lastTerm = term;
                    lastRow = -1;
                    lastCol = -1;
                }

                DataGridView activeGrid;
                DataTable? activeTable;

                if (_tabs.SelectedTab == _tabInput) { activeGrid = _inputGrid; activeTable = _inputTable; }
                else if (_tabs.SelectedTab == _tabLibrary) { activeGrid = _libraryGrid; activeTable = _libraryTable; }
                else if (_tabs.SelectedTab == _tabSynonyms) { activeGrid = _synonymsGrid; activeTable = _synonymsTable; }
                else if (_tabs.SelectedTab == _tabUnknowns) { activeGrid = _unknownsGrid; activeTable = _unknownsTable; }
                else if (_tabs.SelectedTab == _tabVariability) { activeGrid = _variabilityGrid; activeTable = _variabilityTable; }
                else if (_tabs.SelectedTab == _tabValidation) { activeGrid = _validationGrid; activeTable = _validationTable; }
                else if (_tabs.SelectedTab == _tabCostSavings) { activeGrid = _costSavingsGrid; activeTable = _costSavingsTop25Table; }
                else if (_tabs.SelectedTab == _tabSpendTrends) { activeGrid = _spendTrendsGrid; activeTable = _spendTrendsTable; }
                else { activeGrid = _inputGrid; activeTable = _inputTable; }

                if (activeTable == null || activeTable.Columns.Count == 0 || activeTable.Rows.Count == 0)
                {
                    _lblStatus.Text = "Status: Nothing to search on this tab.";
                    return false;
                }

                int rowCount = activeTable.Rows.Count;
                int colCount = activeTable.Columns.Count;

                int startRow = lastRow;
                int startCol = lastCol;

                if (startRow < 0) { startRow = 0; startCol = -1; }

                if (forward)
                {
                    for (int r = startRow; r < rowCount; r++)
                    {
                        int cStart = (r == startRow) ? startCol + 1 : 0;
                        for (int c = cStart; c < colCount; c++)
                        {
                            var v = activeTable.Rows[r][c]?.ToString() ?? "";
                            if (v.IndexOf(term, StringComparison.OrdinalIgnoreCase) >= 0)
                            {
                                SelectCell(activeGrid, r, c);
                                lastRow = r; lastCol = c;
                                _lblStatus.Text = $"Status: Found '{term}' at row {r + 1}, col {activeTable.Columns[c].ColumnName}.";
                                return true;
                            }
                        }
                    }

                    for (int r = 0; r <= startRow; r++)
                    {
                        for (int c = 0; c < colCount; c++)
                        {
                            if (r == startRow && c >= startCol) break;
                            var v = activeTable.Rows[r][c]?.ToString() ?? "";
                            if (v.IndexOf(term, StringComparison.OrdinalIgnoreCase) >= 0)
                            {
                                SelectCell(activeGrid, r, c);
                                lastRow = r; lastCol = c;
                                _lblStatus.Text = $"Status: Found '{term}' (wrapped) at row {r + 1}, col {activeTable.Columns[c].ColumnName}.";
                                return true;
                            }
                        }
                    }
                }
                else
                {
                    for (int r = startRow; r >= 0; r--)
                    {
                        int cStart = (r == startRow) ? startCol - 1 : colCount - 1;
                        for (int c = cStart; c >= 0; c--)
                        {
                            var v = activeTable.Rows[r][c]?.ToString() ?? "";
                            if (v.IndexOf(term, StringComparison.OrdinalIgnoreCase) >= 0)
                            {
                                SelectCell(activeGrid, r, c);
                                lastRow = r; lastCol = c;
                                _lblStatus.Text = $"Status: Found '{term}' at row {r + 1}, col {activeTable.Columns[c].ColumnName}.";
                                return true;
                            }
                        }
                    }

                    for (int r = rowCount - 1; r >= startRow; r--)
                    {
                        for (int c = colCount - 1; c >= 0; c--)
                        {
                            if (r == startRow && c <= startCol) break;
                            var v = activeTable.Rows[r][c]?.ToString() ?? "";
                            if (v.IndexOf(term, StringComparison.OrdinalIgnoreCase) >= 0)
                            {
                                SelectCell(activeGrid, r, c);
                                lastRow = r; lastCol = c;
                                _lblStatus.Text = $"Status: Found '{term}' (wrapped) at row {r + 1}, col {activeTable.Columns[c].ColumnName}.";
                                return true;
                            }
                        }
                    }
                }

                _lblStatus.Text = $"Status: '{term}' not found.";
                return false;
            }

            _btnNextSearch.Click += (_, __) => Find(true);
            _btnPrevSearch.Click += (_, __) => Find(false);

            _txtSearch.KeyDown += (_, e) =>
            {
                if (e.KeyCode == Keys.Enter)
                {
                    Find(true);
                    e.SuppressKeyPress = true;
                }
            };
        }

        // =========================
        // Tools dropdown (original behavior)
        // =========================
        private void BuildToolsDropdown_Original()
        {
            _ddTools.DropDownItems.Add(new ToolStripMenuItem("Run Standardization", null, (_, __) => _btnRun.PerformClick()));
            _ddTools.DropDownItems.Add(new ToolStripMenuItem("Analyze Variability", null, (_, __) => _btnAnalyzeVariability.PerformClick()));
            _ddTools.DropDownItems.Add(new ToolStripMenuItem("Generate Validation", null, (_, __) => _btnGenerateValidation.PerformClick()));
            _ddTools.DropDownItems.Add(new ToolStripSeparator());
            _ddTools.DropDownItems.Add(new ToolStripMenuItem("Cost-Savings Opportunity Finder", null, (_, __) =>
            {
                if (_inputTable == null) { MessageBox.Show("Upload an input Excel file first."); return; }
                try
                {
                    RunCostSavingsOpportunityFinder(_inputTable, _costSavingsGrid);
                    _lblStatus.Text = "Status: Cost-Savings computed. Top 25 shown.";
                    _tabs.SelectedTab = _tabCostSavings;
                }
                catch (Exception ex) { MessageBox.Show(ex.Message, "Cost-Savings Tool Error"); }
            }));
            _ddTools.DropDownItems.Add(new ToolStripMenuItem("Therapeutic Category Spend Trends", null, (_, __) =>
            {
                if (_inputTable == null) { MessageBox.Show("Upload an input Excel file first."); return; }
                try
                {
                    RunTherapeuticSpendTrends(_inputTable, _spendTrendsGrid);
                    _lblStatus.Text = $"Status: Spend Trends created ({_spendTrendsTable.Rows.Count} rows).";
                    _tabs.SelectedTab = _tabSpendTrends;
                }
                catch (Exception ex) { MessageBox.Show(ex.Message, "Spend Trends Tool Error"); }
            }));
        }

        // =========================
        // NEW Shortcuts (do not alter existing Ctrl+F)
        // =========================
        private void Form1_KeyDownShortcuts(object? sender, KeyEventArgs e)
        {
            if (!e.Control) return;

            if (e.KeyCode == Keys.O)
            {
                _btnUploadInput.PerformClick();
                e.SuppressKeyPress = true;
                return;
            }

            if (e.KeyCode == Keys.R)
            {
                if (_btnRun.Enabled) _btnRun.PerformClick();
                e.SuppressKeyPress = true;
                return;
            }

            if (e.KeyCode == Keys.S)
            {
                // Save behavior depends on context; does not change existing save logic.
                if (_tabs.SelectedTab == _tabLibrary && _btnSaveLibrary.Enabled) _btnSaveLibrary.PerformClick();
                else if (_tabs.SelectedTab == _tabSynonyms && _btnSaveSynonyms.Enabled) _btnSaveSynonyms.PerformClick();
                else if (_btnSaveOutput.Enabled) _btnSaveOutput.PerformClick();

                e.SuppressKeyPress = true;
                return;
            }
        }

        // =========================
        // Font group behavior (APPLY TO TABLE DATA)
        // =========================
        private void PopulateFontControls()
        {
            try
            {
                var fonts = FontFamily.Families.Select(f => f.Name).OrderBy(x => x).ToList();
                _rFontFamily.Items.Clear();
                foreach (var f in fonts) _rFontFamily.Items.Add(f);

                // Default to Segoe UI if available; else keep current grid font
                var defaultFont = "Segoe UI";
                if (_rFontFamily.Items.Contains(defaultFont))
                    _rFontFamily.SelectedItem = defaultFont;
                else if (_rFontFamily.Items.Count > 0)
                    _rFontFamily.SelectedIndex = 0;

                _rFontSize.Items.Clear();
                foreach (var s in new[] { "8", "9", "10", "11", "12", "14", "16", "18", "20", "24" })
                    _rFontSize.Items.Add(s);

                _rFontSize.SelectedItem = "10";
            }
            catch
            {
                // If font enumeration fails, keep controls empty
            }
        }

        private void BuildColorMenus()
        {
            // Text color menu
            _rTextColor.DropDownItems.Clear();
            AddColorItem(_rTextColor, "Black", Color.Black, isHighlight: false);
            AddColorItem(_rTextColor, "Dark Blue", Color.DarkBlue, isHighlight: false);
            AddColorItem(_rTextColor, "Dark Green", Color.DarkGreen, isHighlight: false);
            AddColorItem(_rTextColor, "Dark Red", Color.DarkRed, isHighlight: false);
            _rTextColor.DropDownItems.Add(new ToolStripSeparator());
            var moreText = new ToolStripMenuItem("More...");
            moreText.Click += (_, __) =>
            {
                using var cd = new ColorDialog();
                if (cd.ShowDialog() == DialogResult.OK)
                {
                    _gridForeColor = cd.Color;
                    ApplyGridFontFromRibbon();
                }
            };
            _rTextColor.DropDownItems.Add(moreText);

            // Highlight menu (cell background)
            _rHighlight.DropDownItems.Clear();
            AddColorItem(_rHighlight, "None", null, isHighlight: true);
            AddColorItem(_rHighlight, "Yellow", Color.Yellow, isHighlight: true);
            AddColorItem(_rHighlight, "Light Green", Color.LightGreen, isHighlight: true);
            AddColorItem(_rHighlight, "Light Blue", Color.LightBlue, isHighlight: true);
            AddColorItem(_rHighlight, "Light Pink", Color.LightPink, isHighlight: true);
            _rHighlight.DropDownItems.Add(new ToolStripSeparator());
            var moreHi = new ToolStripMenuItem("More...");
            moreHi.Click += (_, __) =>
            {
                using var cd = new ColorDialog();
                if (cd.ShowDialog() == DialogResult.OK)
                {
                    _gridBackColor = cd.Color;
                    ApplyGridFontFromRibbon();
                }
            };
            _rHighlight.DropDownItems.Add(moreHi);
        }

        private void AddColorItem(ToolStripDropDownButton dd, string name, Color? color, bool isHighlight)
        {
            var mi = new ToolStripMenuItem(name);
            mi.Image = MakeColorSwatch(color ?? Color.Transparent);
            mi.Click += (_, __) =>
            {
                if (isHighlight) _gridBackColor = color; else _gridForeColor = color;
                ApplyGridFontFromRibbon();
            };
            dd.DropDownItems.Add(mi);
        }

        private static Bitmap MakeColorSwatch(Color c)
        {
            var bmp = new Bitmap(16, 16);
            using var g = Graphics.FromImage(bmp);
            using var b = new SolidBrush(c);
            g.FillRectangle(b, 0, 0, 16, 16);
            g.DrawRectangle(Pens.Gray, 0, 0, 15, 15);
            return bmp;
        }

        private void ApplyGridFontFromRibbon()
        {
            var grid = GetActiveGrid();
            if (grid == null) return;

            var fam = _rFontFamily.SelectedItem?.ToString();
            if (string.IsNullOrWhiteSpace(fam)) fam = grid.DefaultCellStyle.Font?.FontFamily.Name ?? "Segoe UI";

            float size = 10f;
            if (_rFontSize.SelectedItem != null && float.TryParse(_rFontSize.SelectedItem.ToString(), out var parsed))
                size = parsed;

            var style = FontStyle.Regular;
            if (_rBold.Checked) style |= FontStyle.Bold;
            if (_rItalic.Checked) style |= FontStyle.Italic;
            if (_rUnderline.Checked) style |= FontStyle.Underline;

            Font newFont;
            try { newFont = new Font(fam!, size, style); }
            catch { newFont = new Font("Segoe UI", size, style); }

            ApplyToGridCellsOrDefault(grid, newFont, _gridForeColor, _gridBackColor);
        }

        private static void ApplyToGridCellsOrDefault(DataGridView grid, Font font, Color? fore, Color? back)
        {
            if (grid.SelectedCells != null && grid.SelectedCells.Count > 0)
            {
                foreach (DataGridViewCell cell in grid.SelectedCells)
                {
                    cell.Style.Font = font;
                    if (fore.HasValue) cell.Style.ForeColor = fore.Value;
                    if (back.HasValue) cell.Style.BackColor = back.Value;
                    if (back == null) cell.Style.BackColor = Color.Empty; // reset highlight when "None"
                }
            }
            else
            {
                grid.DefaultCellStyle.Font = font;
                if (fore.HasValue) grid.DefaultCellStyle.ForeColor = fore.Value;
                if (back.HasValue) grid.DefaultCellStyle.BackColor = back.Value;
                if (back == null) grid.DefaultCellStyle.BackColor = Color.Empty;
            }

            grid.Refresh();
        }

        private DataGridView? GetActiveGrid()
        {
            if (_tabs.SelectedTab == _tabInput) return _inputGrid;
            if (_tabs.SelectedTab == _tabLibrary) return _libraryGrid;
            if (_tabs.SelectedTab == _tabSynonyms) return _synonymsGrid;
            if (_tabs.SelectedTab == _tabUnknowns) return _unknownsGrid;
            if (_tabs.SelectedTab == _tabVariability) return _variabilityGrid;
            if (_tabs.SelectedTab == _tabValidation) return _validationGrid;
            if (_tabs.SelectedTab == _tabCostSavings) return _costSavingsGrid;
            if (_tabs.SelectedTab == _tabSpendTrends) return _spendTrendsGrid;
            return null;
        }

        // =========================
        // Grid helpers
        // =========================
        private static DataGridView MakeEditableGrid()
        {
            return new DataGridView
            {
                Dock = DockStyle.Fill,
                AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.DisplayedCells,
                AllowUserToAddRows = true,
                AllowUserToDeleteRows = true
            };
        }

        private static DataGridView MakeReadOnlyGrid()
        {
            return new DataGridView
            {
                Dock = DockStyle.Fill,
                AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.DisplayedCells,
                ReadOnly = true,
                SelectionMode = DataGridViewSelectionMode.CellSelect,
                MultiSelect = true,
                AllowUserToOrderColumns = true
            };
        }

        private static void SelectCell(DataGridView grid, int rowIndex, int colIndex)
        {
            if (rowIndex < 0 || rowIndex >= grid.Rows.Count) return;
            if (colIndex < 0 || colIndex >= grid.Columns.Count) return;

            grid.ClearSelection();
            grid.CurrentCell = grid.Rows[rowIndex].Cells[colIndex];
            grid.Rows[rowIndex].Cells[colIndex].Selected = true;

            try { grid.FirstDisplayedScrollingRowIndex = Math.Max(0, rowIndex - 3); } catch { }
        }

        // =========================
        // Popup helper
        // =========================
        private void ShowBigPopup(string text, string title)
        {
            var f = new Form
            {
                Text = title,
                Width = 900,
                Height = 650,
                StartPosition = FormStartPosition.CenterParent
            };

            var box = new TextBox
            {
                Multiline = true,
                ReadOnly = true,
                ScrollBars = ScrollBars.Both,
                Dock = DockStyle.Fill,
                Font = new Font("Segoe UI", 10),
                Text = text
            };

            var btn = new Button
            {
                Text = "Close",
                Dock = DockStyle.Bottom,
                Height = 40
            };
            btn.Click += (_, __) => f.Close();

            f.Controls.Add(box);
            f.Controls.Add(btn);
            f.ShowDialog(this);
        }

        // =========================
        // DB setup
        // =========================
        private void EnsureDatabase()
        {
            using var conn = new SqliteConnection($"Data Source={_dbPath}");
            conn.Open();

            using var cmd = conn.CreateCommand();
            cmd.CommandText =
            @"
            CREATE TABLE IF NOT EXISTS Ingredients (
                Id INTEGER PRIMARY KEY AUTOINCREMENT,
                Name TEXT NOT NULL UNIQUE,
                Normalized TEXT NOT NULL
            );

            CREATE TABLE IF NOT EXISTS Synonyms (
                Id INTEGER PRIMARY KEY AUTOINCREMENT,
                Pattern TEXT NOT NULL UNIQUE,
                NormalizedPattern TEXT NOT NULL,
                MapsToIngredient TEXT NOT NULL,
                NormalizedMapsTo TEXT NOT NULL,
                Source TEXT NOT NULL DEFAULT 'manual',
                CreatedAt TEXT NOT NULL DEFAULT (datetime('now'))
            );

            CREATE TABLE IF NOT EXISTS Runs (
                Id INTEGER PRIMARY KEY AUTOINCREMENT,
                RunAt TEXT NOT NULL DEFAULT (datetime('now')),
                RowCount INTEGER NOT NULL,
                UnknownCount INTEGER NOT NULL
            );
            ";
            cmd.ExecuteNonQuery();
        }

        private void LogRun(int rowCount, int unknownCount)
        {
            using var conn = new SqliteConnection($"Data Source={_dbPath}");
            conn.Open();
            using var cmd = conn.CreateCommand();
            cmd.CommandText = "INSERT INTO Runs (RowCount, UnknownCount) VALUES ($r, $u);";
            cmd.Parameters.AddWithValue("$r", rowCount);
            cmd.Parameters.AddWithValue("$u", unknownCount);
            cmd.ExecuteNonQuery();
        }

        // =========================
        // Library: Load / Save / Import
        // =========================
        private void LoadLibraryFromDb()
        {
            _libraryTable = new DataTable();
            _libraryTable.Columns.Add("Name", typeof(string));

            _ingredientSet = new HashSet<string>(StringComparer.OrdinalIgnoreCase);

            using var conn = new SqliteConnection($"Data Source={_dbPath}");
            conn.Open();

            using var cmd = conn.CreateCommand();
            cmd.CommandText = "SELECT Name FROM Ingredients ORDER BY Name;";
            using var reader = cmd.ExecuteReader();

            while (reader.Read())
            {
                var name = reader.GetString(0);
                _libraryTable.Rows.Add(name);

                var norm = NormalizeIngredient(name);
                if (!string.IsNullOrWhiteSpace(norm))
                    _ingredientSet.Add(norm);
            }
        }

        private void SaveIngredientsToDb(DataTable table)
        {
            var names = table.Rows
                .Cast<DataRow>()
                .Select(r => (r["Name"]?.ToString() ?? "").Trim())
                .Where(n => !string.IsNullOrWhiteSpace(n))
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .ToList();

            using var conn = new SqliteConnection($"Data Source={_dbPath}");
            conn.Open();
            using var tx = conn.BeginTransaction();

            using (var del = conn.CreateCommand())
            {
                del.CommandText = "DELETE FROM Ingredients;";
                del.ExecuteNonQuery();
            }

            foreach (var name in names)
            {
                var norm = NormalizeIngredient(name);
                if (string.IsNullOrWhiteSpace(norm)) continue;

                using var ins = conn.CreateCommand();
                ins.CommandText = "INSERT INTO Ingredients (Name, Normalized) VALUES ($n, $nn);";
                ins.Parameters.AddWithValue("$n", name);
                ins.Parameters.AddWithValue("$nn", norm);
                ins.ExecuteNonQuery();
            }

            tx.Commit();
        }

        private int ImportIngredientsFromExcel(string path)
        {
            using var wb = new XLWorkbook(path);
            var ws = wb.Worksheets.First();
            var range = ws.RangeUsed();
            if (range == null) throw new Exception("The ingredient library Excel is empty.");

            var headerRow = range.FirstRowUsed();
            var headers = headerRow.CellsUsed().Select(c => c.GetString().Trim().ToLowerInvariant()).ToList();

            int nameIndex = headers.FindIndex(h => h == "ingredient_name" || h == "name" || h == "ingredient");
            if (nameIndex < 0) throw new Exception("Library Excel must have a header column: ingredient_name (or name/ingredient).");

            int added = 0;

            using var conn = new SqliteConnection($"Data Source={_dbPath}");
            conn.Open();
            using var tx = conn.BeginTransaction();

            var firstDataRowNumber = headerRow.RowNumber() + 1;
            var lastRowNumber = range.LastRowUsed().RowNumber();

            for (int r = firstDataRowNumber; r <= lastRowNumber; r++)
            {
                var name = ws.Row(r).Cell(nameIndex + 1).GetValue<string>()?.Trim();
                if (string.IsNullOrWhiteSpace(name)) continue;

                var norm = NormalizeIngredient(name);
                if (string.IsNullOrWhiteSpace(norm)) continue;

                using var cmd = conn.CreateCommand();
                cmd.CommandText = "INSERT OR IGNORE INTO Ingredients (Name, Normalized) VALUES ($n, $nn);";
                cmd.Parameters.AddWithValue("$n", name);
                cmd.Parameters.AddWithValue("$nn", norm);

                var before = GetChangesCount(conn);
                cmd.ExecuteNonQuery();
                var after = GetChangesCount(conn);

                if (after > before) added++;
            }

            tx.Commit();
            return added;
        }

        // =========================
        // Synonyms: Load / Save / Import
        // =========================
        private void LoadSynonymsFromDb()
        {
            _synonymsTable = new DataTable();
            _synonymsTable.Columns.Add("Pattern", typeof(string));
            _synonymsTable.Columns.Add("MapsToIngredient", typeof(string));
            _synonymsTable.Columns.Add("Source", typeof(string));

            _synonymMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);

            using var conn = new SqliteConnection($"Data Source={_dbPath}");
            conn.Open();

            using var cmd = conn.CreateCommand();
            cmd.CommandText = "SELECT Pattern, MapsToIngredient, Source FROM Synonyms ORDER BY Pattern;";
            using var reader = cmd.ExecuteReader();

            while (reader.Read())
            {
                var pattern = reader.GetString(0);
                var mapsTo = reader.GetString(1);
                var source = reader.GetString(2);

                _synonymsTable.Rows.Add(pattern, mapsTo, source);

                var normPattern = NormalizeIngredient(pattern);
                var normMapsTo = NormalizeIngredient(mapsTo);

                if (!string.IsNullOrWhiteSpace(normPattern) && !string.IsNullOrWhiteSpace(normMapsTo))
                    _synonymMap[normPattern] = normMapsTo;
            }
        }

        private void SaveSynonymsToDb(DataTable table)
        {
            var rows = table.Rows
                .Cast<DataRow>()
                .Select(r => new
                {
                    Pattern = (r["Pattern"]?.ToString() ?? "").Trim(),
                    MapsTo = (r["MapsToIngredient"]?.ToString() ?? "").Trim(),
                    Source = (r.Table.Columns.Contains("Source") ? (r["Source"]?.ToString() ?? "manual").Trim() : "manual")
                })
                .Where(x => !string.IsNullOrWhiteSpace(x.Pattern) && !string.IsNullOrWhiteSpace(x.MapsTo))
                .ToList();

            using var conn = new SqliteConnection($"Data Source={_dbPath}");
            conn.Open();
            using var tx = conn.BeginTransaction();

            using (var del = conn.CreateCommand())
            {
                del.CommandText = "DELETE FROM Synonyms;";
                del.ExecuteNonQuery();
            }

            foreach (var row in rows)
            {
                var normPattern = NormalizeIngredient(row.Pattern);
                var normMapsTo = NormalizeIngredient(row.MapsTo);

                if (string.IsNullOrWhiteSpace(normPattern) || string.IsNullOrWhiteSpace(normMapsTo)) continue;

                using var ins = conn.CreateCommand();
                ins.CommandText =
                    "INSERT INTO Synonyms (Pattern, NormalizedPattern, MapsToIngredient, NormalizedMapsTo, Source) " +
                    "VALUES ($p, $np, $m, $nm, $s);";
                ins.Parameters.AddWithValue("$p", row.Pattern);
                ins.Parameters.AddWithValue("$np", normPattern);
                ins.Parameters.AddWithValue("$m", row.MapsTo);
                ins.Parameters.AddWithValue("$nm", normMapsTo);
                ins.Parameters.AddWithValue("$s", string.IsNullOrWhiteSpace(row.Source) ? "manual" : row.Source);

                ins.ExecuteNonQuery();
            }

            tx.Commit();
        }

        private int ImportSynonymsFromExcel(string path)
        {
            using var wb = new XLWorkbook(path);
            var ws = wb.Worksheets.First();
            var range = ws.RangeUsed();
            if (range == null) throw new Exception("Synonyms Excel is empty.");

            var headerRow = range.FirstRowUsed();
            var headers = headerRow.CellsUsed().Select(c => c.GetString().Trim().ToLowerInvariant()).ToList();

            int patternIndex = headers.FindIndex(h => h == "pattern" || h == "synonym" || h == "alias");
            int mapsToIndex = headers.FindIndex(h => h == "mapstoingredient" || h == "mapsto" || h == "ingredient" || h == "target");
            int sourceIndex = headers.FindIndex(h => h == "source");

            if (patternIndex < 0 || mapsToIndex < 0)
                throw new Exception("Synonyms Excel must have columns: Pattern and MapsToIngredient.");

            int added = 0;

            using var conn = new SqliteConnection($"Data Source={_dbPath}");
            conn.Open();
            using var tx = conn.BeginTransaction();

            var firstDataRowNumber = headerRow.RowNumber() + 1;
            var lastRowNumber = range.LastRowUsed().RowNumber();

            for (int r = firstDataRowNumber; r <= lastRowNumber; r++)
            {
                var pattern = ws.Row(r).Cell(patternIndex + 1).GetValue<string>()?.Trim();
                var mapsTo = ws.Row(r).Cell(mapsToIndex + 1).GetValue<string>()?.Trim();
                var source = sourceIndex >= 0 ? ws.Row(r).Cell(sourceIndex + 1).GetValue<string>()?.Trim() : "import";

                if (string.IsNullOrWhiteSpace(pattern) || string.IsNullOrWhiteSpace(mapsTo)) continue;

                var normPattern = NormalizeIngredient(pattern);
                var normMapsTo = NormalizeIngredient(mapsTo);
                if (string.IsNullOrWhiteSpace(normPattern) || string.IsNullOrWhiteSpace(normMapsTo)) continue;

                using var cmd = conn.CreateCommand();
                cmd.CommandText =
                    "INSERT OR IGNORE INTO Synonyms (Pattern, NormalizedPattern, MapsToIngredient, NormalizedMapsTo, Source) " +
                    "VALUES ($p, $np, $m, $nm, $s);";
                cmd.Parameters.AddWithValue("$p", pattern);
                cmd.Parameters.AddWithValue("$np", normPattern);
                cmd.Parameters.AddWithValue("$m", mapsTo);
                cmd.Parameters.AddWithValue("$nm", normMapsTo);
                cmd.Parameters.AddWithValue("$s", string.IsNullOrWhiteSpace(source) ? "import" : source);

                var before = GetChangesCount(conn);
                cmd.ExecuteNonQuery();
                var after = GetChangesCount(conn);

                if (after > before) added++;
            }

            tx.Commit();
            return added;
        }

        private static long GetChangesCount(SqliteConnection conn)
        {
            using var cmd = conn.CreateCommand();
            cmd.CommandText = "SELECT changes();";
            return (long)cmd.ExecuteScalar();
        }

        // =========================
        // Standardization Rules Engine
        // =========================
        private struct ExtractResult
        {
            public string PrimaryIngredient;
            public string AllIngredients;
            public string RuleApplied;
            public string CleanedForMatching;
            public bool IsUnknown;
            public string SuggestedIngredient;
        }

        private static ExtractResult ExtractWithRules(string genericName, HashSet<string> ingredientSet, Dictionary<string, string> synonymMap)
        {
            var result = new ExtractResult
            {
                PrimaryIngredient = "",
                AllIngredients = "",
                RuleApplied = "",
                CleanedForMatching = "",
                IsUnknown = false,
                SuggestedIngredient = ""
            };

            if (string.IsNullOrWhiteSpace(genericName))
            {
                result.PrimaryIngredient = "NON_DRUG";
                result.RuleApplied = "EMPTY";
                return result;
            }

            var cleaned = CleanGenericForMatching(genericName);
            result.CleanedForMatching = cleaned;

            if (string.IsNullOrWhiteSpace(cleaned))
            {
                result.PrimaryIngredient = "NON_DRUG";
                result.RuleApplied = "NON_DRUG_AFTER_CLEAN";
                return result;
            }

            var parts = SplitComboParts(genericName);
            if (parts.Count >= 2)
            {
                var ingredients = new List<string>();
                var rules = new List<string>();

                foreach (var p in parts)
                {
                    var c = CleanGenericForMatching(p);
                    if (string.IsNullOrWhiteSpace(c)) continue;

                    var synHit = LongestMatch(c, synonymMap.Keys);
                    if (!string.IsNullOrWhiteSpace(synHit))
                    {
                        var mapped = synonymMap[synHit];
                        ingredients.Add(mapped);
                        rules.Add($"SYNONYM({synHit}->{mapped})");
                        continue;
                    }

                    var ingHit = LongestMatch(c, ingredientSet);
                    if (!string.IsNullOrWhiteSpace(ingHit))
                    {
                        ingredients.Add(ingHit);
                        rules.Add("DICT");
                        continue;
                    }

                    if (c.Contains("insulin"))
                    {
                        ingredients.Add("insulin");
                        rules.Add("INSULIN_FALLBACK");
                        continue;
                    }
                }

                ingredients = ingredients
                    .Where(x => !string.IsNullOrWhiteSpace(x))
                    .Distinct(StringComparer.OrdinalIgnoreCase)
                    .ToList();

                if (ingredients.Count > 0)
                {
                    result.PrimaryIngredient = ingredients[0];
                    result.AllIngredients = string.Join("|", ingredients);
                    result.RuleApplied = "COMBO:" + string.Join(",", rules.Distinct());
                    return result;
                }

                result.RuleApplied = "COMBO_NO_MATCH";
                result.IsUnknown = true;
                result.SuggestedIngredient = SuggestIngredient(cleaned, ingredientSet);
                return result;
            }

            var syn = LongestMatch(cleaned, synonymMap.Keys);
            if (!string.IsNullOrWhiteSpace(syn))
            {
                var mapped = synonymMap[syn];
                result.PrimaryIngredient = mapped;
                result.AllIngredients = mapped;
                result.RuleApplied = $"SYNONYM({syn}->{mapped})";
                return result;
            }

            var ing = LongestMatch(cleaned, ingredientSet);
            if (!string.IsNullOrWhiteSpace(ing))
            {
                result.PrimaryIngredient = ing;
                result.AllIngredients = ing;
                result.RuleApplied = "DICT_LONGEST_MATCH";
                return result;
            }

            if (cleaned.Contains("insulin"))
            {
                result.PrimaryIngredient = "insulin";
                result.AllIngredients = "insulin";
                result.RuleApplied = "INSULIN_FALLBACK";
                return result;
            }

            if (!ContainsDrugLikeToken(cleaned))
            {
                result.PrimaryIngredient = "NON_DRUG";
                result.RuleApplied = "NON_DRUG_HEURISTIC";
                return result;
            }

            result.RuleApplied = "UNKNOWN_NO_MATCH";
            result.IsUnknown = true;
            result.SuggestedIngredient = SuggestIngredient(cleaned, ingredientSet);
            return result;
        }

        private static bool ContainsDrugLikeToken(string cleaned)
        {
            var tokens = cleaned.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            if (tokens.Any(t => t.Length >= 8)) return true;

            string[] suffixes =
            {
                "cillin","mycin","cycline","prazole","pril","sartan","olol","dipine","statin",
                "azole","vir","mab","nib","tide","caine","parin","dronate","gliptin","gliflozin"
            };
            return tokens.Any(t => suffixes.Any(s => t.EndsWith(s)));
        }

        private static List<string> SplitComboParts(string raw)
        {
            var s = raw.ToLowerInvariant();
            if (!s.Contains("/") && !s.Contains("+") && !s.Contains(" and "))
                return new List<string> { raw };

            var parts = Regex.Split(raw, @"\s*(\/|\+|\band\b)\s*", RegexOptions.IgnoreCase)
                .Select(p => p.Trim())
                .Where(p => !string.IsNullOrWhiteSpace(p))
                .ToList();

            parts = parts.Where(p =>
                p != "/" && p != "+" && !string.Equals(p, "and", StringComparison.OrdinalIgnoreCase)).ToList();

            return parts.Count == 0 ? new List<string> { raw } : parts;
        }

        private static string LongestMatch(string cleaned, IEnumerable<string> candidates)
        {
            var tokens = cleaned.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            if (tokens.Length == 0) return "";

            int maxGram = Math.Min(6, tokens.Length);

            HashSet<string>? set = candidates as HashSet<string>;
            set ??= new HashSet<string>(candidates, StringComparer.OrdinalIgnoreCase);

            for (int n = maxGram; n >= 1; n--)
            {
                for (int i = 0; i <= tokens.Length - n; i++)
                {
                    var phrase = string.Join(" ", tokens.Skip(i).Take(n));
                    if (set.Contains(phrase))
                        return phrase;
                }
            }
            return "";
        }

        private static string SuggestIngredient(string cleaned, HashSet<string> ingredientSet)
        {
            var tokens = cleaned.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            if (tokens.Length == 0) return "";

            foreach (var t in tokens)
                if (ingredientSet.Contains(t)) return t;

            var prefixes = tokens
                .Where(t => t.Length >= 6)
                .Select(t => t.Substring(0, 6))
                .Distinct()
                .ToList();

            string best = "";
            foreach (var ing in ingredientSet)
            {
                foreach (var p in prefixes)
                {
                    if (ing.StartsWith(p) && ing.Length > best.Length)
                        best = ing;
                }
            }
            return best;
        }

        // =========================
        // Cleaning / normalization
        // =========================
        private static string CleanGenericForMatching(string input)
        {
            var s = input.Trim().ToLowerInvariant();

            s = s.Replace("/", " ")
                 .Replace(",", " ")
                 .Replace(";", " ")
                 .Replace("(", " ")
                 .Replace(")", " ")
                 .Replace("-", " ");

            s = Regex.Replace(s, @"\bu\s*[-]?\s*\d+\b", " ");

            s = Regex.Replace(s, @"\b\d+(\.\d+)?\s*(mg|mcg|g|gram|grams|ml|mL|l|meq|units|iu|%)\b", " ");
            s = Regex.Replace(s, @"\b\d+(\.\d+)?\s*(mg\/ml|mg\/mL|mcg\/ml|g\/l|mg\/g)\b", " ");

            foreach (var w in StopWords)
                s = Regex.Replace(s, $@"\b{Regex.Escape(w)}\b", " ");

            foreach (var w in SaltWords)
                s = Regex.Replace(s, $@"\b{Regex.Escape(w)}\b", " ");

            s = Regex.Replace(s, @"\s+", " ").Trim();
            return s;
        }

        private static string NormalizeIngredient(string name)
        {
            var s = name.Trim().ToLowerInvariant();
            s = s.Replace("/", " ").Replace("-", " ");
            s = Regex.Replace(s, @"\s+", " ").Trim();
            return s;
        }

        private static readonly string[] StopWords =
        {
            "vial","vials","syringe","syringes","needle","needles","bag","bags","premix",
            "cartridge","cartridges","label","labels","printer","toner","thermometer","thermometers",
            "kit","kits","cap","caps","luer","female","male","tackle","box","various","dram","drams",
            "tablet","tablets","tab","capsule","capsules","solution","suspension","syrup","injection","inj","iv",
            "oral","topical","cream","ointment","gel","patch","spray","drops","ophthalmic","otic","nasal",
            "extended","release","er","xr","sr","dr","immediate","ir","concentrate","prefilled","pen",
            "for","use","single","dose","multi","dose","pre","filled"
        };

        private static readonly string[] SaltWords =
        {
            "hydrochloride","hcl","sodium","potassium","calcium","magnesium",
            "phosphate","acetate","succinate","tartrate","citrate","mesylate",
            "besylate","tosylate","fumarate","maleate","sulfate","nitrate"
        };

        // =========================
        // Unknowns
        // =========================
        private void BuildUnknownsTableSchema()
        {
            _unknownsTable = new DataTable();
            _unknownsTable.Columns.Add("OriginalGenericName", typeof(string));
            _unknownsTable.Columns.Add("CleanedForMatching", typeof(string));
            _unknownsTable.Columns.Add("SuggestedIngredient", typeof(string));
            _unknownsTable.Columns.Add("ApprovedIngredient", typeof(string));
            _unknownsTable.Columns.Add("SuggestedPattern", typeof(string));
        }

        private void AddUnknownRow(string original, string cleaned, string suggested)
        {
            _unknownsTable.Rows.Add(original, cleaned, suggested, "", cleaned);
        }

        // =========================
        // Reports
        // =========================
        private static DataTable BuildVariabilityReport(DataTable input)
        {
            var dt = new DataTable();
            dt.Columns.Add("PrimaryIngredient", typeof(string));
            dt.Columns.Add("RowCount", typeof(int));
            dt.Columns.Add("UniqueGenericNames", typeof(int));
            dt.Columns.Add("ExampleVariants", typeof(string));

            var genericCol = FindColumn(input, "generic_name");
            var primaryCol = FindColumn(input, "PrimaryIngredient");

            if (genericCol == null || primaryCol == null) return dt;

            var groups = input.Rows.Cast<DataRow>()
                .GroupBy(r => (r[primaryCol]?.ToString() ?? "").Trim())
                .OrderByDescending(g => g.Count());

            foreach (var g in groups)
            {
                var ingredient = g.Key;
                if (string.IsNullOrWhiteSpace(ingredient)) ingredient = "(blank)";
                if (ingredient.Equals("NON_DRUG", StringComparison.OrdinalIgnoreCase)) continue;

                var variants = g
                    .Select(r => (r[genericCol]?.ToString() ?? "").Trim())
                    .Where(x => !string.IsNullOrWhiteSpace(x))
                    .Distinct(StringComparer.OrdinalIgnoreCase)
                    .ToList();

                dt.Rows.Add(ingredient, g.Count(), variants.Count, string.Join(" | ", variants.Take(10)));
            }

            return dt;
        }

        private static DataTable BuildValidationExamples(DataTable input, int topIngredients, int examplesPerIngredient)
        {
            var dt = new DataTable();
            dt.Columns.Add("PrimaryIngredient", typeof(string));
            dt.Columns.Add("GenericNameExample", typeof(string));
            dt.Columns.Add("StandardizedPrimaryIngredient", typeof(string));
            dt.Columns.Add("AllIngredients", typeof(string));
            dt.Columns.Add("RuleApplied", typeof(string));

            var genericCol = FindColumn(input, "generic_name");
            var primaryCol = FindColumn(input, "PrimaryIngredient");
            var allCol = FindColumn(input, "AllIngredients");
            var ruleCol = FindColumn(input, "RuleApplied");

            if (genericCol == null || primaryCol == null) return dt;

            var groups = input.Rows.Cast<DataRow>()
                .Where(r => !string.Equals((r[primaryCol]?.ToString() ?? ""), "NON_DRUG", StringComparison.OrdinalIgnoreCase))
                .GroupBy(r => (r[primaryCol]?.ToString() ?? "").Trim())
                .Select(g => new
                {
                    Ingredient = g.Key,
                    RowCount = g.Count(),
                    UniqueVariants = g.Select(r => (r[genericCol]?.ToString() ?? "").Trim())
                                      .Where(x => !string.IsNullOrWhiteSpace(x))
                                      .Distinct(StringComparer.OrdinalIgnoreCase)
                                      .Count(),
                    Rows = g.ToList()
                })
                .OrderByDescending(x => x.UniqueVariants)
                .ThenByDescending(x => x.RowCount)
                .Take(topIngredients)
                .ToList();

            foreach (var g in groups)
            {
                var sample = g.Rows
                    .Select(r => new
                    {
                        Generic = (r[genericCol]?.ToString() ?? "").Trim(),
                        Primary = (r[primaryCol]?.ToString() ?? "").Trim(),
                        All = allCol == null ? "" : (r[allCol]?.ToString() ?? "").Trim(),
                        Rule = ruleCol == null ? "" : (r[ruleCol]?.ToString() ?? "").Trim()
                    })
                    .Where(x => !string.IsNullOrWhiteSpace(x.Generic))
                    .GroupBy(x => x.Generic, StringComparer.OrdinalIgnoreCase)
                    .Select(grp => grp.First())
                    .Take(examplesPerIngredient)
                    .ToList();

                foreach (var ex in sample)
                    dt.Rows.Add(g.Ingredient, ex.Generic, ex.Primary, ex.All, ex.Rule);
            }

            return dt;
        }

        // =========================
        // Documentation
        // =========================
        private string BuildDocumentationText()
        {
            var sb = new StringBuilder();

            sb.AppendLine("Project: Standardizing Generic Drug Names to Identify Primary Active Ingredient");
            sb.AppendLine("Generated by: DrugNameStandardizer (WinForms + SQLite + ClosedXML)");
            sb.AppendLine($"Generated on: {DateTime.Now}");
            sb.AppendLine();

            sb.AppendLine("Approach Summary");
            sb.AppendLine("- Input: Excel sheet with 'generic_name'.");
            sb.AppendLine("- Output: PrimaryIngredient, AllIngredients, RuleApplied, NormalizedGeneric.");
            sb.AppendLine("- Method: normalization (remove packaging/strength/salts) + synonym mapping + longest n-gram match to Ingredient Library.");
            sb.AppendLine("- Combo products: split on '/', '+', 'and'; AllIngredients keeps all; PrimaryIngredient is first.");
            sb.AppendLine("- Unknown capture: saved into Unknowns tab with suggestion.");
            sb.AppendLine();

            sb.AppendLine("Validation/Reporting");
            sb.AppendLine("- Variability report: ingredient frequency and # unique variants.");
            sb.AppendLine("- Validation examples: before/after examples for high-variability ingredients.");
            sb.AppendLine();

            sb.AppendLine("Usability");
            sb.AppendLine("- Click PrimaryIngredient cell => popup with count + unique generic_name forms (no duplicates).");
            sb.AppendLine("- Right-click a column header in preview => Delete Column (generic_name protected).");
            sb.AppendLine("- Choose Output Columns => export only what user wants.");

            sb.AppendLine();
            sb.AppendLine("Added Tools");
            sb.AppendLine("- Cost-Savings Opportunity Finder (adds pricing spread columns + Top 25).");
            sb.AppendLine("- Therapeutic Category Spend Trends (pivot Sum WAC by ETC_Lowest_lvl).");

            return sb.ToString();
        }

        // =========================
        // Output columns
        // =========================
        private static void EnsureOutputColumns(DataTable dt)
        {
            EnsureCol(dt, "PrimaryIngredient", typeof(string));
            EnsureCol(dt, "AllIngredients", typeof(string));
            EnsureCol(dt, "RuleApplied", typeof(string));
            EnsureCol(dt, "NormalizedGeneric", typeof(string));
        }

        private static void EnsureCol(DataTable dt, string name, Type t)
        {
            if (dt.Columns.Cast<DataColumn>().All(c => c.ColumnName != name))
                dt.Columns.Add(name, t);
        }

        private static DataColumn? FindColumn(DataTable dt, string name)
        {
            return dt.Columns.Cast<DataColumn>()
                .FirstOrDefault(c => string.Equals(c.ColumnName, name, StringComparison.OrdinalIgnoreCase));
        }

        // =========================
        // Export column filtering
        // =========================
        private static DataTable CreateFilteredTable(DataTable source, HashSet<string> keepCols)
        {
            var dt = new DataTable();

            foreach (DataColumn col in source.Columns)
            {
                if (keepCols.Contains(col.ColumnName))
                    dt.Columns.Add(col.ColumnName, col.DataType);
            }

            foreach (DataRow row in source.Rows)
            {
                var nr = dt.NewRow();
                foreach (DataColumn col in dt.Columns)
                    nr[col.ColumnName] = row[col.ColumnName];
                dt.Rows.Add(nr);
            }

            return dt;
        }

        // =========================
        // Excel I/O
        // =========================
        private static DataTable LoadFirstSheetToDataTable(string path)
        {
            using var wb = new XLWorkbook(path);
            var ws = wb.Worksheets.First();

            var range = ws.RangeUsed();
            if (range == null) throw new Exception("The first worksheet is empty.");

            var dt = new DataTable();

            var headerRow = range.FirstRowUsed();
            var headerCells = headerRow.CellsUsed().ToList();

            foreach (var cell in headerCells)
            {
                var name = cell.GetString().Trim();
                if (string.IsNullOrWhiteSpace(name))
                    name = "Column" + cell.Address.ColumnNumber;

                var original = name;
                int k = 1;
                while (dt.Columns.Contains(name))
                {
                    name = $"{original}_{k}";
                    k++;
                }

                dt.Columns.Add(name);
            }

            var firstDataRowNumber = headerRow.RowNumber() + 1;
            var lastRowNumber = range.LastRowUsed().RowNumber();

            for (int r = firstDataRowNumber; r <= lastRowNumber; r++)
            {
                var excelRow = ws.Row(r);
                if (excelRow.Cells(1, dt.Columns.Count).All(c => c.IsEmpty()))
                    continue;

                var dr = dt.NewRow();
                for (int i = 0; i < dt.Columns.Count; i++)
                    dr[i] = excelRow.Cell(i + 1).GetValue<string>();

                dt.Rows.Add(dr);
            }

            return dt;
        }

        private static void SaveDataTableToExcel(DataTable dt, string path)
        {
            using var wb = new XLWorkbook();
            var ws = wb.Worksheets.Add("Output");

            for (int c = 0; c < dt.Columns.Count; c++)
                ws.Cell(1, c + 1).Value = dt.Columns[c].ColumnName;

            for (int r = 0; r < dt.Rows.Count; r++)
            {
                for (int c = 0; c < dt.Columns.Count; c++)
                    ws.Cell(r + 2, c + 1).Value = dt.Rows[r][c]?.ToString() ?? "";
            }

            ws.Columns().AdjustToContents();
            wb.SaveAs(path);
        }

        // =========================
        // Column picker dialog
        // =========================
        private class ColumnPickerDialog : Form
        {
            private readonly CheckedListBox _list = new CheckedListBox();
            private readonly Button _ok = new Button();
            private readonly Button _cancel = new Button();
            private readonly Button _selectAll = new Button();
            private readonly Button _selectNone = new Button();

            public HashSet<string> SelectedColumns { get; private set; }

            public ColumnPickerDialog(List<string> allColumns, HashSet<string> currentlySelected)
            {
                Text = "Choose Output Columns";
                Width = 520;
                Height = 520;
                StartPosition = FormStartPosition.CenterParent;

                _list.Left = 15;
                _list.Top = 15;
                _list.Width = 470;
                _list.Height = 380;
                _list.CheckOnClick = true;

                foreach (var c in allColumns)
                {
                    bool isChecked = currentlySelected.Contains(c);
                    _list.Items.Add(c, isChecked);
                }

                _selectAll.Text = "Select All";
                _selectAll.Left = 15; _selectAll.Top = 405; _selectAll.Width = 110; _selectAll.Height = 30;

                _selectNone.Text = "Select None";
                _selectNone.Left = 135; _selectNone.Top = 405; _selectNone.Width = 110; _selectNone.Height = 30;

                _ok.Text = "OK";
                _ok.Left = 295; _ok.Top = 405; _ok.Width = 90; _ok.Height = 30;

                _cancel.Text = "Cancel";
                _cancel.Left = 395; _cancel.Top = 405; _cancel.Width = 90; _cancel.Height = 30;

                _selectAll.Click += (_, __) =>
                {
                    for (int i = 0; i < _list.Items.Count; i++)
                        _list.SetItemChecked(i, true);
                };

                _selectNone.Click += (_, __) =>
                {
                    for (int i = 0; i < _list.Items.Count; i++)
                        _list.SetItemChecked(i, false);
                };

                _ok.Click += (_, __) =>
                {
                    var selected = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
                    foreach (var item in _list.CheckedItems)
                        selected.Add(item.ToString() ?? "");

                    if (selected.Count == 0)
                    {
                        MessageBox.Show("Please select at least one column.");
                        return;
                    }

                    SelectedColumns = selected;
                    DialogResult = DialogResult.OK;
                    Close();
                };

                _cancel.Click += (_, __) =>
                {
                    DialogResult = DialogResult.Cancel;
                    Close();
                };

                Controls.Add(_list);
                Controls.Add(_selectAll);
                Controls.Add(_selectNone);
                Controls.Add(_ok);
                Controls.Add(_cancel);

                SelectedColumns = new HashSet<string>(currentlySelected, StringComparer.OrdinalIgnoreCase);
            }
        }

        // =========================================================
        // TOOL 1: Cost-Savings Opportunity Finder
        // =========================================================
        private void RunCostSavingsOpportunityFinder(DataTable input, DataGridView outputGrid)
        {
            string[] required =
            {
                "Vizient_ABC_WAC",
                "Vizient_MCK_WAC",
                "Vizient_MDX_WAC",
                "fdb_current_wac_price"
            };

            var missing = required.Where(r => FindColumn(input, r) == null).ToList();
            if (missing.Count > 0)
                throw new Exception("Missing required pricing columns:\n- " + string.Join("\n- ", missing));

            EnsureCol(input, "lowest_distributor", typeof(string));
            EnsureCol(input, "lowest_wholesaler_wac", typeof(double));
            EnsureCol(input, "highest_wholesaler_wac", typeof(double));
            EnsureCol(input, "wholesaler_spread_abs", typeof(double));
            EnsureCol(input, "wholesaler_spread_pct", typeof(double));
            EnsureCol(input, "wholesaler_avg_wac", typeof(double));
            EnsureCol(input, "wholesaler_std_wac", typeof(double));
            EnsureCol(input, "fdb_vs_lowest_abs", typeof(double));
            EnsureCol(input, "fdb_vs_lowest_pct", typeof(double));
            EnsureCol(input, "abnormal_variance", typeof(bool));
            EnsureCol(input, "incomplete_wholesaler_pricing", typeof(bool));

            var colABC = FindColumn(input, "Vizient_ABC_WAC")!;
            var colMCK = FindColumn(input, "Vizient_MCK_WAC")!;
            var colMDX = FindColumn(input, "Vizient_MDX_WAC")!;
            var colFDB = FindColumn(input, "fdb_current_wac_price")!;

            int lowABC = 0, lowMCK = 0, lowMDX = 0;

            foreach (DataRow r in input.Rows)
            {
                double? abc = ParseMoney(r[colABC]);
                double? mck = ParseMoney(r[colMCK]);
                double? mdx = ParseMoney(r[colMDX]);
                double? fdb = ParseMoney(r[colFDB]);

                var list = new List<(string name, double value)>();
                if (abc.HasValue) list.Add(("ABC", abc.Value));
                if (mck.HasValue) list.Add(("MCK", mck.Value));
                if (mdx.HasValue) list.Add(("MDX", mdx.Value));

                bool incomplete = (list.Count > 0) && (list.Count < 3);

                double? lowest = null;
                double? highest = null;
                string lowestDist = "";

                if (list.Count > 0)
                {
                    var min = list.OrderBy(x => x.value).First();
                    var max = list.OrderByDescending(x => x.value).First();
                    lowest = min.value;
                    highest = max.value;
                    lowestDist = min.name;

                    if (lowestDist == "ABC") lowABC++;
                    if (lowestDist == "MCK") lowMCK++;
                    if (lowestDist == "MDX") lowMDX++;
                }

                double? spreadAbs = (lowest.HasValue && highest.HasValue) ? (highest.Value - lowest.Value) : null;
                double? spreadPct = (lowest.HasValue && lowest.Value > 0 && highest.HasValue)
                    ? (highest.Value - lowest.Value) / lowest.Value
                    : null;

                double? avg = (list.Count > 0) ? list.Average(x => x.value) : null;
                double? std = (list.Count >= 2) ? StdDev(list.Select(x => x.value).ToList()) : (list.Count == 1 ? 0.0 : null);

                double? fdbVsAbs = (fdb.HasValue && lowest.HasValue) ? (fdb.Value - lowest.Value) : null;
                double? fdbVsPct = (fdb.HasValue && lowest.HasValue && lowest.Value > 0) ? (fdb.Value - lowest.Value) / lowest.Value : null;

                bool abnormal = false;
                if (spreadPct.HasValue && spreadPct.Value >= 0.20) abnormal = true;
                if (spreadAbs.HasValue && spreadAbs.Value >= 100) abnormal = true;

                r["lowest_distributor"] = lowestDist;
                r["lowest_wholesaler_wac"] = lowest.HasValue ? (object)lowest.Value : DBNull.Value;
                r["highest_wholesaler_wac"] = highest.HasValue ? (object)highest.Value : DBNull.Value;
                r["wholesaler_spread_abs"] = spreadAbs.HasValue ? (object)spreadAbs.Value : DBNull.Value;
                r["wholesaler_spread_pct"] = spreadPct.HasValue ? (object)spreadPct.Value : DBNull.Value;
                r["wholesaler_avg_wac"] = avg.HasValue ? (object)avg.Value : DBNull.Value;
                r["wholesaler_std_wac"] = std.HasValue ? (object)std.Value : DBNull.Value;
                r["fdb_vs_lowest_abs"] = fdbVsAbs.HasValue ? (object)fdbVsAbs.Value : DBNull.Value;
                r["fdb_vs_lowest_pct"] = fdbVsPct.HasValue ? (object)fdbVsPct.Value : DBNull.Value;
                r["abnormal_variance"] = abnormal;
                r["incomplete_wholesaler_pricing"] = incomplete;
            }

            _costSavingsTop25Table = new DataTable();
            _costSavingsTop25Table.Columns.Add("key", typeof(string));
            _costSavingsTop25Table.Columns.Add("lowest_distributor", typeof(string));
            _costSavingsTop25Table.Columns.Add("lowest_wholesaler_wac", typeof(double));
            _costSavingsTop25Table.Columns.Add("highest_wholesaler_wac", typeof(double));
            _costSavingsTop25Table.Columns.Add("wholesaler_spread_abs", typeof(double));
            _costSavingsTop25Table.Columns.Add("wholesaler_spread_pct", typeof(double));
            _costSavingsTop25Table.Columns.Add("abnormal_variance", typeof(bool));
            _costSavingsTop25Table.Columns.Add("incomplete_wholesaler_pricing", typeof(bool));

            var keyCol = FindColumn(input, "ndc") ?? FindColumn(input, "crossrefkey");

            var ranked = input.Rows.Cast<DataRow>()
                .Select((row, idx) => new
                {
                    Row = row,
                    Index = idx,
                    SpreadAbs = row["wholesaler_spread_abs"] == DBNull.Value ? (double?)null : Convert.ToDouble(row["wholesaler_spread_abs"]),
                    SpreadPct = row["wholesaler_spread_pct"] == DBNull.Value ? (double?)null : Convert.ToDouble(row["wholesaler_spread_pct"])
                })
                .Where(x => x.SpreadAbs.HasValue || x.SpreadPct.HasValue)
                .OrderByDescending(x => x.SpreadAbs ?? -1)
                .ThenByDescending(x => x.SpreadPct ?? -1)
                .Take(25)
                .ToList();

            foreach (var x in ranked)
            {
                var row = x.Row;
                var key = keyCol != null ? (row[keyCol]?.ToString() ?? "").Trim() : "";
                if (string.IsNullOrWhiteSpace(key)) key = $"row_{x.Index + 1}";

                _costSavingsTop25Table.Rows.Add(
                    key,
                    row["lowest_distributor"]?.ToString() ?? "",
                    row["lowest_wholesaler_wac"] == DBNull.Value ? 0.0 : Convert.ToDouble(row["lowest_wholesaler_wac"]),
                    row["highest_wholesaler_wac"] == DBNull.Value ? 0.0 : Convert.ToDouble(row["highest_wholesaler_wac"]),
                    row["wholesaler_spread_abs"] == DBNull.Value ? 0.0 : Convert.ToDouble(row["wholesaler_spread_abs"]),
                    row["wholesaler_spread_pct"] == DBNull.Value ? 0.0 : Convert.ToDouble(row["wholesaler_spread_pct"]),
                    Convert.ToBoolean(row["abnormal_variance"]),
                    Convert.ToBoolean(row["incomplete_wholesaler_pricing"])
                );
            }

            outputGrid.DataSource = _costSavingsTop25Table;

            var buckets = new Dictionary<string, int>
            {
                { "0–5%", 0 }, { "5–10%", 0 }, { "10–20%", 0 }, { ">20%", 0 }, { "null/NA", 0 }
            };

            foreach (DataRow r in input.Rows)
            {
                if (r["wholesaler_spread_pct"] == DBNull.Value) { buckets["null/NA"]++; continue; }
                double p = Convert.ToDouble(r["wholesaler_spread_pct"]);
                if (p < 0.05) buckets["0–5%"]++;
                else if (p < 0.10) buckets["5–10%"]++;
                else if (p < 0.20) buckets["10–20%"]++;
                else buckets[">20%"]++;
            }

            var sb = new StringBuilder();
            sb.AppendLine("Cost-Savings Opportunity Finder — Summary");
            sb.AppendLine("----------------------------------------");
            sb.AppendLine("Lowest distributor counts:");
            sb.AppendLine($"• ABC: {lowABC}");
            sb.AppendLine($"• MCK: {lowMCK}");
            sb.AppendLine($"• MDX: {lowMDX}");
            sb.AppendLine();
            sb.AppendLine("Spread % buckets:");
            foreach (var kv in buckets)
                sb.AppendLine($"• {kv.Key}: {kv.Value}");

            ShowBigPopup(sb.ToString(), "Cost-Savings Summary");
        }

        // =========================================================
        // TOOL 2: Therapeutic Category Spend Trends
        // =========================================================
        private void RunTherapeuticSpendTrends(DataTable input, DataGridView outputGrid)
        {
            string[] required =
            {
                "ETC_Lowest_lvl",
                "etc1",
                "etc2",
                "AHFS_therapeutic_description",
                "Vizient_ABC_WAC",
                "Vizient_MCK_WAC",
                "Vizient_MDX_WAC",
                "fdb_current_wac_price"
            };

            var missing = required.Where(r => FindColumn(input, r) == null).ToList();
            if (missing.Count > 0)
                throw new Exception("Missing required columns for Spend Trends:\n- " + string.Join("\n- ", missing));

            var colETC = FindColumn(input, "ETC_Lowest_lvl")!;
            var colEtc1 = FindColumn(input, "etc1")!;
            var colEtc2 = FindColumn(input, "etc2")!;
            var colAhfs = FindColumn(input, "AHFS_therapeutic_description")!;

            var colABC = FindColumn(input, "Vizient_ABC_WAC")!;
            var colMCK = FindColumn(input, "Vizient_MCK_WAC")!;
            var colMDX = FindColumn(input, "Vizient_MDX_WAC")!;
            var colFDB = FindColumn(input, "fdb_current_wac_price")!;

            var colCompetition = FindColumn(input, "competition");

            _spendTrendsTable = new DataTable();
            _spendTrendsTable.Columns.Add("ETC_Lowest_lvl", typeof(string));
            _spendTrendsTable.Columns.Add("ItemCount", typeof(int));
            _spendTrendsTable.Columns.Add("Sum_WAC", typeof(double));
            _spendTrendsTable.Columns.Add("Avg_WAC", typeof(double));
            _spendTrendsTable.Columns.Add("MostCommon_etc1", typeof(string));
            _spendTrendsTable.Columns.Add("MostCommon_etc2", typeof(string));
            _spendTrendsTable.Columns.Add("MostCommon_AHFS", typeof(string));
            _spendTrendsTable.Columns.Add("AbnormalVarianceCount", typeof(int));
            _spendTrendsTable.Columns.Add("AvgSpreadPct", typeof(double));
            _spendTrendsTable.Columns.Add("HighCompetitionCount", typeof(int));

            bool hasSpreadPct = FindColumn(input, "wholesaler_spread_pct") != null;
            bool hasAbnormal = FindColumn(input, "abnormal_variance") != null;

            var groups = input.Rows.Cast<DataRow>()
                .GroupBy(r => (r[colETC]?.ToString() ?? "").Trim())
                .Where(g => !string.IsNullOrWhiteSpace(g.Key));

            foreach (var g in groups)
            {
                var key = g.Key;

                var wacs = new List<double>();
                var spreads = new List<double>();
                int abnormalCount = 0;
                int highComp = 0;

                foreach (var r in g)
                {
                    double? abc = ParseMoney(r[colABC]);
                    double? mck = ParseMoney(r[colMCK]);
                    double? mdx = ParseMoney(r[colMDX]);
                    double? fdb = ParseMoney(r[colFDB]);

                    double? basis = MinNullable(abc, mck, mdx) ?? fdb;
                    if (basis.HasValue) wacs.Add(basis.Value);

                    if (hasSpreadPct && r.Table.Columns.Contains("wholesaler_spread_pct") && r["wholesaler_spread_pct"] != DBNull.Value)
                        spreads.Add(Convert.ToDouble(r["wholesaler_spread_pct"]));
                    else
                    {
                        var list = new List<double>();
                        if (abc.HasValue) list.Add(abc.Value);
                        if (mck.HasValue) list.Add(mck.Value);
                        if (mdx.HasValue) list.Add(mdx.Value);
                        if (list.Count >= 2)
                        {
                            double min = list.Min();
                            double max = list.Max();
                            if (min > 0) spreads.Add((max - min) / min);
                        }
                    }

                    if (hasAbnormal && r.Table.Columns.Contains("abnormal_variance"))
                    {
                        if (r["abnormal_variance"] != DBNull.Value && Convert.ToBoolean(r["abnormal_variance"])) abnormalCount++;
                    }
                    else
                    {
                        var list = new List<double>();
                        if (abc.HasValue) list.Add(abc.Value);
                        if (mck.HasValue) list.Add(mck.Value);
                        if (mdx.HasValue) list.Add(mdx.Value);
                        if (list.Count >= 2)
                        {
                            double min = list.Min();
                            double max = list.Max();
                            double abs = max - min;
                            double pct = (min > 0) ? abs / min : 0;
                            if (pct >= 0.20 || abs >= 100) abnormalCount++;
                        }
                    }

                    if (colCompetition != null)
                    {
                        var comp = (r[colCompetition]?.ToString() ?? "").Trim();
                        if (comp.Equals("High", StringComparison.OrdinalIgnoreCase)) highComp++;
                    }
                }

                int itemCount = g.Count();
                double sum = wacs.Sum();
                double avg = wacs.Count > 0 ? wacs.Average() : 0.0;
                double avgSpread = spreads.Count > 0 ? spreads.Average() : 0.0;

                string mc1 = MostCommon(g.Select(r => (r[colEtc1]?.ToString() ?? "").Trim()));
                string mc2 = MostCommon(g.Select(r => (r[colEtc2]?.ToString() ?? "").Trim()));
                string mcAhfs = MostCommon(g.Select(r => (r[colAhfs]?.ToString() ?? "").Trim()));

                _spendTrendsTable.Rows.Add(key, itemCount, sum, avg, mc1, mc2, mcAhfs, abnormalCount, avgSpread, highComp);
            }

            var view = _spendTrendsTable.DefaultView;
            view.Sort = "Sum_WAC DESC";
            outputGrid.DataSource = view.ToTable();
            _spendTrendsTable = view.ToTable();
        }

        // =========================
        // Tool helpers
        // =========================
        private static double? ParseMoney(object? val)
        {
            var s = (val?.ToString() ?? "").Trim();
            if (string.IsNullOrWhiteSpace(s)) return null;

            s = s.Replace("$", "").Replace(",", "").Trim();
            if (s.Equals("na", StringComparison.OrdinalIgnoreCase) ||
                s.Equals("n/a", StringComparison.OrdinalIgnoreCase) ||
                s.Equals("-", StringComparison.OrdinalIgnoreCase))
                return null;

            bool neg = false;
            if (s.StartsWith("(") && s.EndsWith(")"))
            {
                neg = true;
                s = s.Trim('(', ')').Trim();
            }

            if (double.TryParse(s, NumberStyles.Any, CultureInfo.InvariantCulture, out double d) ||
                double.TryParse(s, NumberStyles.Any, CultureInfo.CurrentCulture, out d))
            {
                return neg ? -d : d;
            }

            return null;
        }

        private static double StdDev(List<double> values)
        {
            if (values.Count <= 1) return 0.0;
            double avg = values.Average();
            double sumSq = values.Sum(v => (v - avg) * (v - avg));
            return Math.Sqrt(sumSq / (values.Count - 1));
        }

        private static double? MinNullable(params double?[] vals)
        {
            var ok = vals.Where(v => v.HasValue).Select(v => v!.Value).ToList();
            return ok.Count == 0 ? (double?)null : ok.Min();
        }

        private static string MostCommon(IEnumerable<string> vals)
        {
            return vals.Where(v => !string.IsNullOrWhiteSpace(v))
                       .GroupBy(v => v, StringComparer.OrdinalIgnoreCase)
                       .OrderByDescending(g => g.Count())
                       .Select(g => g.Key)
                       .FirstOrDefault() ?? "";
        }
    }
}
